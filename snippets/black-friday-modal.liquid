{% comment %}
  Black Friday Subscription Modal
  Shows when black_friday_countdown is true.
  Usage: {% render 'black-friday-modal' %} in layout/theme.liquid
{% endcomment %}

<div id="BlackFridayModalOverlay" class="bf-modal-overlay"></div>
<div
  id="BlackFridayModalContainer"
  class="bf-modal"
  data-black-friday-countdown="{{ settings.black_friday_countdown }}"
  data-success="{{ form.posted_successfully }}"
>
  <button class="bf-modal-close" aria-label="{{ 'general.close' | t | default: 'Close' }}">&times;</button>
  <div class="bf-modal-inner">
    <div class="bf-image">
      <img
        src="https://cdn.shopify.com/s/files/1/0954/9840/4181/files/CAR01650-2.jpg?v=1764120484"
        alt="Black Friday"
        class="bf-modal-image"
        width="400"
        height="400"
      >
    </div>
    <div class="bf-content">
      <h2 id="BlackFridayModalTitle" class="bf-modal-title">EARLY ACCESS</h2>
      <h1 class="bf-modal-main">BLACK FRIDAY</h1>
      <p class="bf-modal-discount">UP to 50%</p>
      <p id="BlackFridayModalDesc" class="bf-modal-desc">SIGN UP AND BE THE FIRST TO KNOW WHEN IT STARTS</p>

      {% form 'customer', id: 'BlackFridayModalForm' %}
        <div id="bf-message" class="bf-modal-message"></div>

        <div class="bf-modal-fieldset">
          <label class="visually-hidden" for="BlackFridayModalEmail">Email</label>
          <input
            type="email"
            name="contact[email]"
            id="BlackFridayModalEmail"
            placeholder="Email"
            autocomplete="email"
            required
            class="bf-modal-input"
          >
          <input type="hidden" name="contact[tags]" id="BlackFridayModalTags" value="black-friday">
          <button type="submit" class="btn btn--primary btn--block bf-modal-submit">
            Subscribe
          </button>
        </div>
      {% endform %}
    </div>
  </div>
</div>

<style>
  .bf-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9998;
    display: none;
  }
  .bf-modal {
    position: fixed;
    z-index: 9999;
    inset: 50% auto auto 50%;
    transform: translate(-50%, -50%);
    width: min(90vw, 600px);
    max-width: 90vw;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 10px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    padding: 0;
    color: var(--color-foreground);
    overflow: hidden;
    display: none;
  }
  .bf-modal-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none !important;
    font-size: 24px;
    cursor: pointer;
    color: var(--color-foreground);
    z-index: 10;
  }

  .bf-modal-close:hover {
    color: var(--color-primary) !important;
    background: none !important;
  }

  .bf-modal-inner {
    display: flex;
    min-height: 320px;
  }
  .bf-image {
    flex: 1;
    background: #000;
  }
  .bf-modal-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .bf-content {
    flex: 1;
    padding: 30px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
  }
  .bf-modal-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: #8f2b3f;
  }
  .bf-modal-main {
    font-size: 3rem;
    margin-bottom: 10px;
    font-weight: bold;
  }
  .bf-modal-discount {
    font-size: 2rem;
    margin-bottom: 20px;
    color: #8f2b3f;
  }
  .bf-modal-desc {
    margin-bottom: 15px;
    font-size: 1.1rem;
  }
  .bf-modal-fieldset {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .bf-modal-input {
    padding: 12px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 1rem;
    background: rgba(0, 0, 0, 0.7);
  }
  .bf-modal-submit {
    padding: 12px;
    background: #8f2b3f;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
  }
  .bf-modal-message {
    font-size: 0.9rem;
  }

  .bf-modal-success {
    color: #8f2b3f;
    margin-bottom: 5px;
  }

  .bf-modal-errors {
    color: red;
  }
  
</style>

<style>
  /* Mobile responsive styles */
  @media (max-width: 768px) {
    .bf-modal {
      width: min(88vw, 360px);
      max-width: 88vw;
      max-height: 80vh;
      overflow: hidden;
    }

    .bf-modal-close {
      background-color: transparent !important;
    }

    .bf-modal-inner {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 36px 22px;
      min-height: 320px;
    }

    .bf-image {
      position: absolute;
      inset: 0;
      display: block;
      flex: none;
      max-height: none;
      order: initial;
      z-index: 0;
    }

    .bf-modal-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.35;
    }

    .bf-content {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 280px;
      padding: 28px 24px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 14px;
      text-align: center;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      color: #f5f5f5;
    }

    .bf-modal-title {
      font-size: 1.25rem;
      letter-spacing: 0.08em;
      margin-bottom: 10px;
      color: #8f2b3f;
    }

    .bf-modal-main {
      font-size: 2.4rem;
      margin-bottom: 10px;
      color: #ffffff;
    }

    .bf-modal-discount {
      font-size: 1.7rem;
      margin-bottom: 16px;
      color: #8f2b3f;
    }

    .bf-modal-desc {
      margin-bottom: 15px;
      font-size: 1rem;
      line-height: 1.5;
      color: #ededed;
    }

    .bf-modal-fieldset {
      gap: 14px;
    }

    .bf-modal-input {
      padding: 12px;
      font-size: 1rem;
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.7);
      color: #f5f5f5;
    }

    .bf-modal-input::placeholder {
      color: #f5f5f5;
    }

    .bf-modal-submit {
      padding: 12px;
      font-size: 1rem;
      border-radius: 6px;
    }
  }

  @media (max-width: 480px) {
    .bf-modal {
      width: min(92vw, 300px);
      max-width: 92vw;
    }

    .bf-modal-inner {
      padding: 32px 18px;
      min-height: 300px;
    }

    .bf-content {
      max-width: 260px;
      padding: 24px 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #f5f5f5;
    }

    .bf-modal-title {
      font-size: 1.1rem;
      color: #8f2b3f;
    }

    .bf-modal-main {
      font-size: 2.1rem;
      color: #ffffff;
    }

    .bf-modal-discount {
      font-size: 1.5rem;
      color: #8f2b3f;
    }
  }
</style>

{% javascript %}
(function () {
  const overlay = document.getElementById('BlackFridayModalOverlay');
  const modal = document.getElementById('BlackFridayModalContainer');
  const closeBtn = document.querySelector('.bf-modal-close');
  const form = document.getElementById('BlackFridayModalForm');
  const message = document.getElementById('bf-message');

  if (!overlay || !modal || !closeBtn || !form || !message) return;

  const SUCCESS_MESSAGE = "Subscribed! You'll be the first to know when Black Friday starts.";
  const ERROR_MESSAGE = 'An error occurred. Please try again.';
  const SUCCESS_AUTO_CLOSE_DELAY = 2200;

  function clearMessage() {
    if (!message) return;
    message.textContent = '';
    message.className = 'bf-modal-message';
    message.style.display = 'none';
  }

  function showMessage(text, type = 'info') {
    if (!message) return;
    message.textContent = text;
    message.style.display = text ? 'block' : 'none';
    message.className = 'bf-modal-message';

    if (type === 'success') {
      message.classList.add('bf-modal-success');
    } else if (type === 'error') {
      message.classList.add('bf-modal-errors');
    }
  }

  function openModal() {
    overlay.style.display = 'block';
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  function hideModal() {
    overlay.style.display = 'none';
    modal.style.display = 'none';
    document.body.style.overflow = '';
    clearMessage();
  }

  closeBtn.addEventListener('click', () => {
    hideModal();
    dismissForDays(dismissDaysOnClose);
  });
  overlay.addEventListener('click', () => {
    hideModal();
    dismissForDays(dismissDaysOnClose);
  });

  clearMessage();

  // Show modal on load if not dismissed
  const showDelayMs = 0; // Show immediately for testing
  const dismissDaysOnClose = 7; // 7 days
  const storageKey = 'bf-modal-dismissed-v2';
  const subscribedFlag = 'bf-subscribed-v2';
  const captchaPendingFlag = 'bf-captcha-pending';

  function shouldShow() {
    const countdownEnabled = modal.dataset.blackFridayCountdown === 'true';
    const notDismissed = !isDismissed();
    const notSubscribed = !localStorage.getItem(subscribedFlag);
    console.log('Modal shouldShow:', { countdownEnabled, notDismissed, notSubscribed });
    return countdownEnabled && notDismissed && notSubscribed;
  }

  function dismissForDays(days) {
    const expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
    localStorage.setItem(storageKey, expiry);
  }

  function isDismissed() {
    const expiry = localStorage.getItem(storageKey);
    if (!expiry) return false;
    return Date.now() < parseInt(expiry);
  }

  function markSubscribed() {
    localStorage.setItem(subscribedFlag, 'true');
    dismissForDays(dismissDaysOnClose);
  }

  function handleSuccess({ showModal = false, messageText = SUCCESS_MESSAGE, resetForm = true } = {}) {
    markSubscribed();

    if (resetForm && form) {
      form.reset();
    }

    showMessage(messageText, 'success');

    if (showModal && modal.style.display !== 'block') {
      openModal();
    }

    setTimeout(() => {
      hideModal();
    }, SUCCESS_AUTO_CLOSE_DELAY);
  }

  if (localStorage.getItem(captchaPendingFlag)) {
    localStorage.removeItem(captchaPendingFlag);
    handleSuccess({ showModal: true, resetForm: false });
  } else if (modal.dataset.success === 'true') {
    handleSuccess({ showModal: true, resetForm: false });
  } else if (shouldShow()) {
    setTimeout(openModal, showDelayMs);
  }

  // Handle form submission
  if (form) {
    const submitButton = form.querySelector('.bf-modal-submit');
    const originalText = submitButton ? submitButton.textContent : '';

    const handleSubmit = async (e) => {
      e.preventDefault();
      clearMessage();
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Subscribing...';
      }

      const formData = new FormData(form);

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          },
        });

        if (response.redirected) {
          const url = response.url;
          if (url.includes('/challenge') || url.includes('shopify-challenge')) {
            console.log('Captcha detected in redirect URL');
            // Captcha required - hide modal and redirect
            localStorage.setItem(captchaPendingFlag, 'true');
            hideModal();
            window.location.href = url;
            return;
          } else {
            // Assume success - show message and close
            handleSuccess();
          }
        } else {
          // Check response text for challenge indicators
          const text = await response.text();
          const lower = text.toLowerCase();
          if (
            lower.includes('shopify-challenge') ||
            lower.includes('g-recaptcha') ||
            lower.includes('h-captcha') ||
            lower.includes('/challenge') ||
            lower.includes('captcha') ||
            lower.includes('verify you are human')
          ) {
            console.log('Captcha detected in response text');
            // Captcha required - hide modal and submit form normally
            localStorage.setItem(captchaPendingFlag, 'true');
            hideModal();
            form.removeEventListener('submit', handleSubmit);
            form.submit();
            return;
          } else if (response.ok) {
            // Success - show message and close
            handleSuccess();
          } else {
            showMessage(ERROR_MESSAGE, 'error');
          }
        }
      } catch (e) {
        showMessage(ERROR_MESSAGE, 'error');
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      }
    };
    form.addEventListener('submit', handleSubmit);
  }
})();
{% endjavascript %}