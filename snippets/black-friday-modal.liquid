{% comment %}
  Black Friday Subscription Modal
  Shows when black_friday_countdown is true.
  Usage: {% render 'black-friday-modal' %} in layout/theme.liquid
{% endcomment %}

<div id="BlackFridayModalOverlay" class="bf-modal-overlay"></div>
<div
  id="BlackFridayModalContainer"
  class="bf-modal"
  data-black-friday-countdown="{{ settings.black_friday_countdown }}"
  data-success="{{ form.posted_successfully }}"
>
  <button class="bf-modal-close" aria-label="{{ 'general.close' | t | default: 'Close' }}">&times;</button>
  <div class="bf-modal-inner">
    <div class="bf-image">
      <img
        src="https://cdn.shopify.com/s/files/1/0954/9840/4181/files/CAR01650-2.jpg?v=1764120484"
        alt="Black Friday"
        class="bf-modal-image"
        width="400"
        height="400"
      >
    </div>
    <div class="bf-content">
      <h2 id="BlackFridayModalTitle" class="bf-modal-title">EARLY ACCESS</h2>
      <h1 class="bf-modal-main">BLACK FRIDAY</h1>
      <p class="bf-modal-discount">UP to 50%</p>
      <p id="BlackFridayModalDesc" class="bf-modal-desc">SIGN UP AND BE THE FIRST TO KNOW WHEN IT STARTS</p>

      {% form 'customer', id: 'BlackFridayModalForm' %}
        <div id="bf-message" class="bf-modal-message"></div>

        <div class="bf-modal-fieldset">
          <label class="visually-hidden" for="BlackFridayModalName">Name</label>
          <input
            type="text"
            name="contact[first_name]"
            id="BlackFridayModalName"
            placeholder="Name"
            autocomplete="given-name"
            class="bf-modal-input"
          >
          <label class="visually-hidden" for="BlackFridayModalEmail">Email</label>
          <input
            type="email"
            name="contact[email]"
            id="BlackFridayModalEmail"
            placeholder="Email"
            autocomplete="email"
            required
            class="bf-modal-input"
          >
          <input type="hidden" name="contact[tags]" id="BlackFridayModalTags" value="black-friday">
          <button type="submit" class="btn btn--primary btn--block bf-modal-submit">
            Subscribe
          </button>
        </div>
      {% endform %}
    </div>
  </div>
</div>

<style>
  .bf-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9998;
    display: none;
  }
  .bf-modal {
    position: fixed;
    z-index: 9999;
    inset: 50% auto auto 50%;
    transform: translate(-50%, -50%);
    width: min(95vw, 800px);
    max-width: 95vw;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 10px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    padding: 0;
    color: var(--color-foreground);
    overflow: hidden;
    display: none;
  }
  .bf-modal-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none !important;
    font-size: 24px;
    cursor: pointer;
    color: var(--color-foreground);
    z-index: 10;
  }

  .bf-modal-close:hover {
    color: var(--color-primary) !important;
    background: none !important;
  }

  .bf-modal-inner {
    display: flex;
    min-height: 400px;
  }
  .bf-image {
    flex: 1;
    background: #000;
  }
  .bf-modal-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .bf-content {
    flex: 1;
    padding: 40px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
  }
  .bf-modal-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: #8f2b3f;
  }
  .bf-modal-main {
    font-size: 3rem;
    margin-bottom: 10px;
    font-weight: bold;
  }
  .bf-modal-discount {
    font-size: 2rem;
    margin-bottom: 20px;
    color: #8f2b3f;
  }
  .bf-modal-desc {
    margin-bottom: 30px;
    font-size: 1.1rem;
  }
  .bf-modal-fieldset {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  .bf-modal-input {
    padding: 12px;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 1rem;
  }
  .bf-modal-submit {
    padding: 12px;
    background: #8f2b3f;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
  }
  .bf-modal-message {
    margin-top: 10px;
    font-size: 0.9rem;
  }
  .bf-modal-success {
    color: #8f2b3f;
    margin-bottom: 5px;
  }
  .bf-modal-errors {
    color: red;
  }
</style>

<style>
  /* Mobile responsive styles */
  @media (max-width: 768px) {
    .bf-modal {
      width: min(90vw, 400px);
      max-width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
    }

    .bf-modal-close {
      background-color: transparent !important;
    }

    .bf-modal-inner {
      flex-direction: column;
      min-height: auto;
    }

    .bf-image {
      flex: 0 0 200px;
      order: -1;
    }

    .bf-content {
      flex: 1;
      padding: 30px 20px;
      text-align: center;
    }

    .bf-modal-title {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }

    .bf-modal-main {
      font-size: 2.2rem;
      margin-bottom: 8px;
    }

    .bf-modal-discount {
      font-size: 1.6rem;
      margin-bottom: 15px;
    }

    .bf-modal-desc {
      margin-bottom: 25px;
      font-size: 1rem;
    }

    .bf-modal-fieldset {
      gap: 12px;
    }

    .bf-modal-input {
      padding: 10px;
      font-size: 0.9rem;
    }

    .bf-modal-submit {
      padding: 10px;
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    .bf-modal {
      width: min(95vw, 350px);
      max-width: 95vw;
    }

    .bf-image {
      flex: 0 0 150px;
    }

    .bf-content {
      padding: 25px 15px;
    }

    .bf-modal-main {
      font-size: 2rem;
    }

    .bf-modal-discount {
      font-size: 1.4rem;
    }
  }
</style>

{% javascript %}
(function () {
  const overlay = document.getElementById('BlackFridayModalOverlay');
  const modal = document.getElementById('BlackFridayModalContainer');
  const closeBtn = document.querySelector('.bf-modal-close');
  const form = document.getElementById('BlackFridayModalForm');
  const message = document.getElementById('bf-message');

  if (!overlay || !modal || !closeBtn || !form || !message) return;

  function openModal() {
    overlay.style.display = 'block';
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }

  function hideModal() {
    overlay.style.display = 'none';
    modal.style.display = 'none';
    document.body.style.overflow = '';
  }

  closeBtn.addEventListener('click', () => {
    hideModal();
    dismissForDays(dismissDaysOnClose);
  });
  overlay.addEventListener('click', () => {
    hideModal();
    dismissForDays(dismissDaysOnClose);
  });

  // Show modal on load if not dismissed
  const showDelayMs = 0; // Show immediately for testing
  const dismissDaysOnClose = 7; // 7 days
  const storageKey = 'bf-modal-dismissed-v2';
  const subscribedFlag = 'bf-subscribed-v2';
  const captchaPendingFlag = 'bf-captcha-pending';

  function shouldShow() {
    const countdownEnabled = modal.dataset.blackFridayCountdown === 'true';
    const notDismissed = !isDismissed();
    const notSubscribed = !localStorage.getItem(subscribedFlag);
    console.log('Modal shouldShow:', { countdownEnabled, notDismissed, notSubscribed });
    return countdownEnabled && notDismissed && notSubscribed;
  }

  function dismissForDays(days) {
    const expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
    localStorage.setItem(storageKey, expiry);
  }

  function isDismissed() {
    const expiry = localStorage.getItem(storageKey);
    if (!expiry) return false;
    return Date.now() < parseInt(expiry);
  }

  if (localStorage.getItem(captchaPendingFlag)) {
    localStorage.removeItem(captchaPendingFlag);
    message.textContent = 'Subscribed! You\'ll be the first to know when Black Friday starts.';
    message.style.color = '#8f2b3f';
    localStorage.setItem(subscribedFlag, 'true');
    openModal();
    setTimeout(() => {
      hideModal();
    }, 2000);
  } else if (modal.dataset.success === 'true') {
    message.textContent = 'Subscribed! You\'ll be the first to know when Black Friday starts.';
    message.style.color = '#8f2b3f';
    localStorage.setItem(subscribedFlag, 'true');
    openModal();
    setTimeout(() => {
      hideModal();
    }, 2000);
  } else if (shouldShow()) {
    setTimeout(openModal, showDelayMs);
  }

  // Handle form submission
  if (form) {
    const submitButton = form.querySelector('.bf-modal-submit');
    const originalText = submitButton ? submitButton.textContent : '';

    const handleSubmit = async (e) => {
      e.preventDefault();
      message.textContent = '';
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Subscribing...';
      }

      const formData = new FormData(form);

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          },
        });

        if (response.redirected) {
          const url = response.url;
          if (url.includes('/challenge') || url.includes('shopify-challenge')) {
            console.log('Captcha detected in redirect URL');
            // Captcha required - hide modal and redirect
            hideModal();
            window.location.href = url;
            return;
          } else {
            // Assume success - show message and close
            message.textContent = 'Subscribed! You\'ll be the first to know when Black Friday starts.';
            message.style.color = '#8f2b3f';
            localStorage.setItem(subscribedFlag, 'true');
            form.reset();
            setTimeout(() => {
              hideModal();
            }, 2000);
          }
        } else {
          // Check response text for challenge indicators
          const text = await response.text();
          const lower = text.toLowerCase();
          if (
            lower.includes('shopify-challenge') ||
            lower.includes('g-recaptcha') ||
            lower.includes('h-captcha') ||
            lower.includes('/challenge') ||
            lower.includes('captcha') ||
            lower.includes('verify you are human')
          ) {
            console.log('Captcha detected in response text');
            // Captcha required - hide modal and submit form normally
            localStorage.setItem(captchaPendingFlag, 'true');
            hideModal();
            form.removeEventListener('submit', handleSubmit);
            form.submit();
            return;
          } else if (response.ok) {
            // Success - show message and close
            message.textContent = 'Subscribed! You\'ll be the first to know when Black Friday starts.';
            message.style.color = '#8f2b3f';
            localStorage.setItem(subscribedFlag, 'true');
            form.reset();
            setTimeout(() => {
              hideModal();
            }, 2000);
          } else {
            message.textContent = 'An error occurred. Please try again.';
            message.style.color = 'red';
          }
        }
      } catch (e) {
        message.textContent = 'An error occurred. Please try again.';
        message.style.color = 'red';
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      }
    };
    form.addEventListener('submit', handleSubmit);
  }
})();
{% endjavascript %}