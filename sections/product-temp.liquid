{% comment %}
  This section is used in the product template to render product page with
  media, content, and add-to-cart form.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/product
{% endcomment %}

{% assign current_variant = product.selected_or_first_available_variant %}

<div class="product-page-new{% if product.gift_card? or product.type == 'Gift Card' %} product-page--gift-card{% endif %}">
  
  <!-- Left Column: Product Info -->
  <div class="product-col-left">
    <nav class="product-breadcrumb">
      {% if product.collections.size > 0 %}
        <a href="{{ product.collections.first.url }}">{{ product.collections.first.title }}</a>
        <span>/</span>
      {% endif %}
      <span>{{ product.title }}</span>
    </nav>
    
    <h1 class="product-title">{{ product.title }}</h1>
    <div class="product-price">{% render 'price', amount: current_variant.price, product: product %}</div>
    
    <!-- Details Accordion -->
    <div class="product-info-sections">
      <div class="info-section">
        <button class="info-section-toggle" type="button" data-section="details">
          <span>DETAILS</span>
          <span class="toggle-icon">—</span>
        </button>
        <div class="info-section-content active" data-content="details">
          {% if product.description != blank %}
            {{ product.description }}
          {% endif %}
          {% if product.metafields.custom.details != blank %}
            {{ product.metafields.custom.details | metafield_tag | newline_to_br }}
          {% endif %}
        </div>
      </div>
      
      <div class="info-section">
        <button class="info-section-toggle" type="button" data-section="shipping">
          <span>SHIPPING</span>
          <span class="toggle-icon">+</span>
        </button>
        <div class="info-section-content" data-content="shipping">
          <p>- Spain 24-48H (Spain & Portugal) - Correos</p>
          <p>- European Shipping 3-5 working days - Maersk</p>
          <p>- International Shipping 5-10 working days - UPS</p>
          <p style="margin-top: 15px;">If you have any issues with your order email us at help@incorrectsociety.com and we will be there to help you.</p>
          <p style="margin-top: 15px;">Orders placed after 1PM (CET) will be shipped the following business day.</p>
        </div>
      </div>
      
      {% unless product.gift_card? or product.type == 'Gift Card' %}
      <div class="info-section">
        <button class="info-section-toggle" type="button" data-section="sizeguide">
          <span>SIZE GUIDE</span>
          <span class="toggle-icon">+</span>
        </button>
        <div class="info-section-content" data-content="sizeguide">
          {% assign product_type_down = product.metafields.custom.type | downcase %}
          {% if product_type_down contains 'hoodie' %}
            <div class="size-guide-table">
              <div class="size-row header">
                <span>Size</span><span>Width</span><span>Length</span><span>Sleeve</span>
              </div>
              <div class="size-row"><span>S</span><span>53cm</span><span>68cm</span><span>62cm</span></div>
              <div class="size-row"><span>M</span><span>56cm</span><span>71cm</span><span>63cm</span></div>
              <div class="size-row"><span>L</span><span>59cm</span><span>74cm</span><span>64cm</span></div>
              <div class="size-row"><span>XL</span><span>62cm</span><span>77cm</span><span>65cm</span></div>
            </div>
          {% else %}
            <div class="size-guide-table">
              <div class="size-row header">
                <span>Size</span><span>Width</span><span>Length</span><span>Sleeve</span>
              </div>
              <div class="size-row"><span>S</span><span>46cm</span><span>70cm</span><span>20cm</span></div>
              <div class="size-row"><span>M</span><span>51cm</span><span>72cm</span><span>21cm</span></div>
              <div class="size-row"><span>L</span><span>56cm</span><span>74cm</span><span>22cm</span></div>
              <div class="size-row"><span>XL</span><span>61cm</span><span>76cm</span><span>23cm</span></div>
            </div>
          {% endif %}
        </div>
      </div>
      {% endunless %}
    </div>
  </div>
  
  <!-- Center Column: Images -->
  <div class="product-col-center">
    {% if product.images.size > 1 %}
    <div class="product-thumbnails">
      {% for image in product.images %}
        <button 
          class="thumbnail{% if forloop.first %} active{% endif %}" 
          data-image-index="{{ forloop.index0 }}"
          type="button"
        >
          <img
            src="{{ image | image_url: width: 100 }}"
            alt="{{ image.alt | escape }}"
            width="70"
            height="90"
            loading="lazy"
          >
        </button>
      {% endfor %}
    </div>
    {% endif %}
    
    <div class="product-main-image" id="product-main-image">
      {% for image in product.images %}
        <div 
          class="main-image{% if forloop.first %} active{% endif %}" 
          data-image-index="{{ forloop.index0 }}"
        >
          <img
            src="{{ image | image_url: width: 1600 }}"
            alt="{{ image.alt | escape }}"
            width="800"
            height="1000"
            loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
            data-zoom-src="{{ image | image_url: width: 2400 }}"
          >
          {% if product.metafields.custom.model_info != blank and forloop.last %}
            <div class="model-info-overlay">
              {{ product.metafields.custom.model_info | metafield_tag }}
            </div>
          {% endif %}
        </div>
      {% endfor %}
      {% if product.images.size == 0 %}
        <div class="no-image-placeholder">
          <p>No Image Available</p>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Right Column: Options & Add to Cart -->
  <div class="product-col-right">
    {% form 'product', product %}
      {% if product.has_only_default_variant == false %}
        <!-- Color Selection (if exists) -->
        {% for option in product.options_with_values %}
          {% assign option_key = option.name | downcase | handleize %}
          {% if option_key contains 'color' or option_key contains 'cor' or option_key contains 'colour' %}
            <div class="product-option-group">
              <div class="option-header-inline">
                <span class="option-name">Select Color</span>
                <span class="option-value-display">{{ option.selected_value }}</span>
              </div>
              <div class="color-swatches">
                {% for value in option.values %}
                  {% assign variant_for_color = product.variants | where: 'option1', value | first %}
                  {% if variant_for_color %}
                    <label class="color-swatch">
                      <input
                        type="radio"
                        name="option-{{ option.position }}"
                        value="{{ value | escape }}"
                        {% if option.selected_value == value %}checked{% endif %}
                      >
                      <span class="swatch-image">
                        <img 
                          src="{{ variant_for_color.featured_image | default: product.featured_image | image_url: width: 80 }}" 
                          alt="{{ value }}"
                          width="50"
                          height="65"
                        >
                      </span>
                    </label>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
        
        <!-- Size Selection -->
        {% for option in product.options_with_values %}
          {% assign option_key = option.name | downcase | handleize %}
          {% unless option_key contains 'color' or option_key contains 'cor' or option_key contains 'colour' %}
            <div class="product-option-group">
              <label class="option-name">{{ option.name }}</label>
              <div class="size-options">
                {% for value in option.values %}
                  <label class="size-option">
                    <input
                      type="radio"
                      name="option-{{ option.position }}"
                      value="{{ value | escape }}"
                      {% if option.selected_value == value %}checked{% endif %}
                    >
                    <span class="size-btn">{{ value }}</span>
                  </label>
                {% endfor %}
              </div>
            </div>
          {% endunless %}
        {% endfor %}
      {% endif %}

      <!-- Hidden variant selector -->
      <select name="id" class="variant-selector" style="display: none;">
        {% for variant in product.variants %}
          <option value="{{ variant.id }}" {% if variant == current_variant %}selected{% endif %}>
            {{ variant.title }}
          </option>
        {% endfor %}
      </select>

      <!-- Variant data for JavaScript -->
      <script type="application/json" id="variant-data">
        {
          "variants": [
            {% for variant in product.variants %}
              {% capture price_html %}{% render 'price', amount: variant.price, product: product %}{% endcapture %}
              {
                "id": {{ variant.id | json }},
                "title": {{ variant.title | json }},
                "available": {{ variant.available | json }},
                "inventory_quantity": {{ variant.inventory_quantity | json }},
                "inventory_policy": {{ variant.inventory_policy | json }},
                "inventory_management": {{ variant.inventory_management | json }},
                "price": {{ variant.price | json }},
                "priceHtml": {{ price_html | json }},
                "option1": {{ variant.option1 | json }},
                "option2": {{ variant.option2 | json }},
                "option3": {{ variant.option3 | json }},
                "featured_image": {% if variant.featured_image %}{{ variant.featured_image | image_url: width: 800 | json }}{% else %}null{% endif %}
              }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ],
          "options": [
            {% for option in product.options %}
              {
                "name": {{ option | json }},
                "values": {{ option.values | json }}
              }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ]
        }
      </script>

      {% if current_variant.available %}
        <p class="stock-status in-stock">● Buy now orders shipped within 1-2 days.</p>
      {% else %}
        <p class="stock-status out-stock">● Currently out of stock</p>
      {% endif %}

      <button
        type="submit"
        id="add-to-cart-btn"
        class="add-to-cart-btn"
        {% unless current_variant.available %}disabled{% endunless %}
      >
        <span class="btn-text">Add to Cart</span>
        <span class="btn-price">{% render 'price', amount: current_variant.price, product: product %}</span>
      </button>
      <div class="cart-message" style="display: none;"></div>
    {% endform %}
    
    <div class="product-benefits">
      <p>Worldwide shipping available.</p>
      <p>Hassle-free returns.</p>
      <p>Premium quality products made to last.</p>
    </div>
  </div>
</div>

<!-- Image Lightbox -->
<div class="image-lightbox" id="image-lightbox">
  <button class="lightbox-close" type="button" aria-label="Close">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M18 6L6 18M6 6l12 12"/>
    </svg>
  </button>
  <div class="lightbox-content">
    <img src="" alt="" id="lightbox-image">
  </div>
  <button class="lightbox-nav lightbox-prev" type="button" aria-label="Previous">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M15 18L9 12L15 6"/>
    </svg>
  </button>
  <button class="lightbox-nav lightbox-next" type="button" aria-label="Next">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M9 18L15 12L9 6"/>
    </svg>
  </button>
</div>

{% stylesheet %}
  /* New Product Page Layout */
  .product-page-new {
    display: grid;
    grid-template-columns: 280px 1fr 320px;
    gap: 30px;
    padding: 20px 40px;
    min-height: calc(100vh - 150px);
    max-width: 1600px;
    margin: 0 auto;
  }
  
  /* Left Column */
  .product-col-left {
    padding: 20px 0;
  }
  
  .product-breadcrumb {
    font-size: 12px;
    color: var(--color-description, #666);
    margin-bottom: 30px;
  }
  
  .product-breadcrumb a {
    color: var(--color-description, #666);
    text-decoration: none;
  }
  
  .product-breadcrumb a:hover {
    color: var(--color-foreground);
  }
  
  .product-title {
    font-size: 24px;
    font-weight: var(--font-heading-weight);
    color: var(--color-title, #000);
    margin: 0 0 10px 0;
    line-height: 1.2;
  }
  
  .product-price {
    font-size: 18px;
    color: var(--color-title, #000);
    margin-bottom: 40px;
  }
  
  /* Info Sections (Accordion) */
  .product-info-sections {
    border-top: 1px solid var(--color-border);
  }
  
  .info-section {
    border-bottom: 1px solid var(--color-border);
  }
  
  .info-section-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 15px 0;
    background: none;
    border: none;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.05em;
    color: var(--color-title, #000);
    cursor: pointer;
    text-align: left;
  }
  
  .toggle-icon {
    font-size: 16px;
    font-weight: 300;
  }
  
  .info-section-content {
    display: none;
    padding: 0 0 20px 0;
    font-size: 14px;
    line-height: 1.7;
    color: var(--color-description, #666);
  }
  
  .info-section-content.active {
    display: block;
  }
  
  .info-section-content p {
    margin: 0 0 5px 0;
  }
  
  /* Size Guide Table */
  .size-guide-table {
    margin-top: 10px;
  }
  
  .size-guide-table .size-row {
    display: grid;
    grid-template-columns: 50px repeat(3, 1fr);
    gap: 10px;
    padding: 8px 0;
    font-size: 13px;
    border-bottom: 1px solid var(--color-border);
  }
  
  .size-guide-table .size-row.header {
    font-weight: 600;
    color: var(--color-title, #000);
  }
  
  .size-guide-table .size-row:last-child {
    border-bottom: none;
  }
  
  /* Center Column - Images */
  .product-col-center {
    display: flex;
    gap: 15px;
    position: relative;
  }
  
  .product-thumbnails {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 70px;
    flex-shrink: 0;
  }
  
  .thumbnail {
    width: 70px;
    height: 90px;
    border: 2px solid transparent;
    background: var(--color-surface);
    padding: 0;
    cursor: pointer;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  
  .thumbnail.active {
    border-color: var(--color-foreground);
  }
  
  .thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .product-main-image {
    flex: 1;
    position: relative;
    background: var(--color-surface);
    cursor: zoom-in;
    overflow: hidden;
  }
  
  .product-main-image .main-image {
    display: none;
    width: 100%;
    height: 100%;
  }
  
  .product-main-image .main-image.active {
    display: block;
  }
  
  .product-main-image .main-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .model-info-overlay {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 12px;
    color: var(--color-description, #666);
    background: rgba(255,255,255,0.9);
    padding: 8px;
  }
  
  .no-image-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 600px;
    background: var(--color-surface);
    color: var(--color-description);
  }
  
  /* Right Column */
  .product-col-right {
    padding: 20px 0;
  }
  
  .product-option-group {
    margin-bottom: 25px;
  }
  
  .option-header-inline {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .option-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--color-title, #000);
    display: block;
    margin-bottom: 12px;
  }
  
  .option-value-display {
    font-size: 14px;
    color: var(--color-description, #666);
  }
  
  /* Color Swatches */
  .color-swatches {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .color-swatch {
    cursor: pointer;
  }
  
  .color-swatch input {
    position: absolute;
    opacity: 0;
  }
  
  .swatch-image {
    display: block;
    width: 50px;
    height: 65px;
    border: 2px solid transparent;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  
  .color-swatch input:checked + .swatch-image {
    border-color: var(--color-foreground);
  }
  
  .swatch-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* Size Options */
  .size-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .size-option {
    cursor: pointer;
  }
  
  .size-option input {
    position: absolute;
    opacity: 0;
  }
  
  .size-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 48px;
    height: 48px;
    padding: 0 15px;
    border: 1px solid var(--color-border);
    border-radius: 50%;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
  }
  
  .size-option input:checked + .size-btn {
    background: var(--color-foreground);
    color: var(--color-background);
    border-color: var(--color-foreground);
  }
  
  .size-option input:disabled + .size-btn {
    opacity: 0.4;
    cursor: not-allowed;
    text-decoration: line-through;
  }
  
  /* Stock Status */
  .stock-status {
    font-size: 13px;
    margin: 20px 0;
  }
  
  .stock-status.in-stock {
    color: #22c55e;
  }
  
  .stock-status.out-stock {
    color: var(--color-error);
  }
  
  /* Add to Cart Button */
  .add-to-cart-btn {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    padding: 18px 25px;
    background: var(--color-foreground);
    color: var(--color-background);
    border: none;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  
  .add-to-cart-btn:hover {
    opacity: 0.9;
  }
  
  .add-to-cart-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .cart-message {
    margin-top: 15px;
    padding: 12px;
    text-align: center;
    font-size: 13px;
  }
  
  .cart-message.success {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
  }
  
  .cart-message.error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--color-error);
  }
  
  /* Product Benefits */
  .product-benefits {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--color-border);
  }
  
  .product-benefits p {
    font-size: 13px;
    color: var(--color-description, #666);
    margin: 0 0 8px 0;
    line-height: 1.5;
  }
  
  /* Lightbox */
  .image-lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.95);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
  }
  
  .image-lightbox.active {
    display: flex;
  }
  
  .lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    padding: 10px;
  }
  
  .lightbox-content {
    max-width: 90vw;
    max-height: 90vh;
  }
  
  .lightbox-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
  }
  
  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    padding: 20px;
  }
  
  .lightbox-prev { left: 20px; }
  .lightbox-next { right: 20px; }
  
  /* Gift Card adjustments */
  .product-page--gift-card .product-col-center {
    background: var(--color-surface);
  }
  
  /* Responsive */
  @media (max-width: 1200px) {
    .product-page-new {
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    .product-col-left {
      grid-column: 1;
      grid-row: 2;
    }
    
    .product-col-center {
      grid-column: 1 / -1;
      grid-row: 1;
      max-height: 70vh;
    }
    
    .product-col-right {
      grid-column: 2;
      grid-row: 2;
    }
  }
  
  @media (max-width: 768px) {
    .product-page-new {
      grid-template-columns: 1fr;
      padding: 15px;
    }
    
    .product-col-left,
    .product-col-center,
    .product-col-right {
      grid-column: 1;
    }
    
    .product-col-center {
      grid-row: 1;
      flex-direction: column-reverse;
      max-height: none;
    }
    
    .product-col-left {
      grid-row: 2;
    }
    
    .product-col-right {
      grid-row: 3;
    }
    
    .product-thumbnails {
      flex-direction: row;
      width: 100%;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .thumbnail {
      flex-shrink: 0;
    }
    
    .product-main-image {
      min-height: 400px;
    }
  }
{% endstylesheet %}

{% javascript %}
document.addEventListener('DOMContentLoaded', function() {
  // Info Section Toggles
  const toggles = document.querySelectorAll('.info-section-toggle');
  toggles.forEach(toggle => {
    toggle.addEventListener('click', function() {
      const section = this.dataset.section;
      const content = document.querySelector(`[data-content="${section}"]`);
      const icon = this.querySelector('.toggle-icon');
      
      if (content.classList.contains('active')) {
        content.classList.remove('active');
        icon.textContent = '+';
      } else {
        content.classList.add('active');
        icon.textContent = '—';
      }
    });
  });
  
  // Thumbnail Gallery
  const thumbnails = document.querySelectorAll('.thumbnail');
  const mainImages = document.querySelectorAll('.product-main-image .main-image');
  
  thumbnails.forEach(thumb => {
    thumb.addEventListener('click', function() {
      const index = this.dataset.imageIndex;
      
      thumbnails.forEach(t => t.classList.remove('active'));
      mainImages.forEach(img => img.classList.remove('active'));
      
      this.classList.add('active');
      const targetImage = document.querySelector(`.product-main-image .main-image[data-image-index="${index}"]`);
      if (targetImage) targetImage.classList.add('active');
    });
  });
  
  // Lightbox
  const mainImageContainer = document.getElementById('product-main-image');
  const lightbox = document.getElementById('image-lightbox');
  const lightboxImage = document.getElementById('lightbox-image');
  const lightboxClose = document.querySelector('.lightbox-close');
  const lightboxPrev = document.querySelector('.lightbox-prev');
  const lightboxNext = document.querySelector('.lightbox-next');
  let currentLightboxIndex = 0;
  
  if (mainImageContainer && lightbox) {
    mainImageContainer.addEventListener('click', function(e) {
      if (e.target.tagName === 'IMG') {
        const zoomSrc = e.target.dataset.zoomSrc || e.target.src;
        lightboxImage.src = zoomSrc;
        lightboxImage.alt = e.target.alt;
        currentLightboxIndex = parseInt(e.target.closest('.main-image').dataset.imageIndex);
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    });
    
    lightboxClose.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', function(e) {
      if (e.target === lightbox) closeLightbox();
    });
    
    function closeLightbox() {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    lightboxPrev.addEventListener('click', function() {
      const images = document.querySelectorAll('.product-main-image .main-image img');
      currentLightboxIndex = (currentLightboxIndex - 1 + images.length) % images.length;
      const img = images[currentLightboxIndex];
      lightboxImage.src = img.dataset.zoomSrc || img.src;
    });
    
    lightboxNext.addEventListener('click', function() {
      const images = document.querySelectorAll('.product-main-image .main-image img');
      currentLightboxIndex = (currentLightboxIndex + 1) % images.length;
      const img = images[currentLightboxIndex];
      lightboxImage.src = img.dataset.zoomSrc || img.src;
    });
    
    document.addEventListener('keydown', function(e) {
      if (!lightbox.classList.contains('active')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') lightboxPrev.click();
      if (e.key === 'ArrowRight') lightboxNext.click();
    });
  }
  
  // Variant Selection
  const variantDataEl = document.getElementById('variant-data');
  if (!variantDataEl) return;
  
  const variantData = JSON.parse(variantDataEl.textContent);
  const variantSelector = document.querySelector('.variant-selector');
  const priceEl = document.querySelector('.product-price');
  const btnPriceEl = document.querySelector('.btn-price');
  const addToCartBtn = document.querySelector('#add-to-cart-btn');
  const stockStatus = document.querySelector('.stock-status');
  
  function updateVariant() {
    const selectedOptions = [];
    document.querySelectorAll('input[name^="option-"]:checked').forEach(input => {
      const pos = parseInt(input.name.match(/option-(\d+)/)[1]) - 1;
      selectedOptions[pos] = input.value.trim().toLowerCase();
    });
    
    const matchingVariant = variantData.variants.find(v => {
      const opts = [v.option1, v.option2, v.option3].map(o => o ? o.toLowerCase() : '');
      return selectedOptions.every((sel, i) => opts[i] === sel);
    });
    
    if (matchingVariant) {
      if (variantSelector) variantSelector.value = matchingVariant.id;
      if (priceEl) priceEl.innerHTML = matchingVariant.priceHtml;
      if (btnPriceEl) btnPriceEl.innerHTML = matchingVariant.priceHtml;
      
      if (addToCartBtn) {
        addToCartBtn.disabled = !matchingVariant.available;
        const btnText = addToCartBtn.querySelector('.btn-text');
        if (btnText) {
          btnText.textContent = matchingVariant.available ? 'Add to Cart' : 'Sold Out';
        }
      }
      
      if (stockStatus) {
        if (matchingVariant.available) {
          stockStatus.className = 'stock-status in-stock';
          stockStatus.textContent = '● Buy now orders shipped within 1-2 days.';
        } else {
          stockStatus.className = 'stock-status out-stock';
          stockStatus.textContent = '● Currently out of stock';
        }
      }
    }
  }
  
  document.querySelectorAll('input[name^="option-"]').forEach(input => {
    input.addEventListener('change', updateVariant);
  });
  
  // Add to Cart
  const productForm = document.querySelector('form[action*="/cart/add"]');
  const cartMessage = document.querySelector('.cart-message');
  
  if (productForm) {
    productForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(productForm);
      const addButton = productForm.querySelector('#add-to-cart-btn');
      const btnText = addButton.querySelector('.btn-text');
      const originalText = btnText.textContent;
      
      addButton.disabled = true;
      btnText.textContent = 'Adding...';
      
      if (cartMessage) {
        cartMessage.style.display = 'none';
        cartMessage.className = 'cart-message';
      }
      
      const addPromise = window.addToCartAndUpdate
        ? window.addToCartAndUpdate(formData)
        : fetch('/cart/add.js', { method: 'POST', body: formData }).then(r => r.json());
      
      addPromise
        .then(data => {
          if (cartMessage) {
            cartMessage.className = 'cart-message success';
            cartMessage.textContent = 'Added to cart!';
            cartMessage.style.display = 'block';
          }
          addButton.disabled = false;
          btnText.textContent = originalText;
          setTimeout(() => { if (cartMessage) cartMessage.style.display = 'none'; }, 3000);
        })
        .catch(error => {
          if (cartMessage) {
            cartMessage.className = 'cart-message error';
            cartMessage.textContent = 'Error adding to cart.';
            cartMessage.style.display = 'block';
          }
          addButton.disabled = false;
          btnText.textContent = originalText;
        });
    });
  }
});
{% endjavascript %}

{% schema %}
{
  "name": "t:general.product",
  "settings": [],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
