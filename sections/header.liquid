<div class="site-header-backdrop"></div>
<header class="site-header" role="banner">
  
  <div class="site-header-inner">
    <div class="header-content">
    <div class="header-left">
      <button type="button" class="header-action header-hamburger" id="mobile-nav-toggle" aria-label="Open menu">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <nav class="header-nav">
        <ul class="header-menu">
          <li class="header-menu-item">
            <a href="{{ pages['all-products'].url }}" class="header-menu-link">Shop</a>
          </li>
          <li class="header-menu-item">
            <a href="{{ routes.collections_url }}/outsider" class="header-menu-link">Outsider</a>
          </li>
          <li class="header-menu-item">
            <a href="{{ routes.collections_url }}/gift-cards" class="header-menu-link">Gift Card</a>
          </li>
          <li class="header-menu-item">
            <a href="{{ routes.collections_url }}/accessories" class="header-menu-link">Accessories</a>
          </li>
          <li class="header-menu-item">
            <a href="{{ pages['news'].url }}" class="header-menu-link">News</a>
          </li>
        </ul>
      </nav>
    </div>
    <div class="header-center">
      <div class="header-identity">
        <a href="{{ routes.root_url }}" class="header-logo-link" aria-label="{{ 'general.home' | t }}">
          <img
            src="https://cdn.shopify.com/s/files/1/0954/9840/4181/files/Logo_black.svg?v=1764257555"
            alt="{{ shop.name }}"
            class="header-logo"
            loading="eager"
            width="10px"
            height="60px"
          >
        </a>
      </div>
    </div>
    <div class="header-right">
      <div class="header-actions">
        <div class="header-search" data-search>
          <form action="{{ routes.search_url }}" method="get" role="search" class="header-search-form" aria-label="{{ 'search.title' | t }}">
            <label for="header-search-input" class="visually-hidden">{{ 'search.title' | t }}</label>
            <input
              id="header-search-input"
              class="header-search-input"
              type="search"
              name="q"
              placeholder="{{ 'search.placeholder' | t }}"
              value="{{ search.terms | escape }}"
              autocomplete="off"
            >
            <button type="submit" class="header-search-submit" aria-label="{{ 'search.submit' | t }}">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M5 12h14M13 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="predictive-search-results" id="predictive-search-results"></div>
          </form>
          <button
            type="button"
            class="header-action header-search-toggle"
            aria-label="{{ 'search.title' | t }}"
            aria-expanded="false"
            aria-controls="header-search-input"
          >
            <svg class="search-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle cx="10.5" cy="10.5" r="7.5" stroke="currentColor" stroke-width="2" fill="none"/>
              <path d="M18 18L21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <a href="{{ routes.cart_url }}" class="header-action header-cart" id="cart-toggle" aria-label="{{ 'cart.title' | t }}">
          <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6h14l-2 8H8L6 6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round" fill="none"/>
            <path d="M6 6L5 3H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="9" cy="18" r="1.5" fill="currentColor"/>
            <circle cx="17" cy="18" r="1.5" fill="currentColor"/>
          </svg>
          <span class="visually-hidden">{{ 'cart.title' | t }}</span>
          <span
            class="cart-count{% if cart.item_count > 0 %} cart-count--visible{% endif %}"
            id="cart-count"
            aria-hidden="true"
          >
            {% if cart.item_count > 0 %}{{ cart.item_count }}{% endif %}
          </span>
        </a>
      </div>
    </div>
</div>
  </div>
</header>
<div id="site-header-spacer" class="site-header-spacer" aria-hidden="true"></div>

<div class="cart-sidebar" id="cart-sidebar">
  <div class="cart-sidebar-content">
    <div class="cart-header">
      <h3>{{ 'cart.title' | t }}</h3>
      <button class="cart-close" id="cart-close">
        <svg width="24" height="24" viewBox="0 0 24 24">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <div class="cart-items" id="cart-items">
    </div>

    <div class="cart-footer">
      <div class="cart-total">
        <span>{{ 'cart.subtotal' | t }}: </span>
        <span id="cart-total">{% render 'price', amount: cart.total_price %}</span>
      </div>
      <div class="cart-actions">
        <button class="btn btn--secondary" id="clear-cart-btn">{{ 'cart.clear' | t }}</button>
        <a href="{{ routes.cart_url }}" class="btn btn--primary">{{ 'cart.goToCartBtn' | t }}</a>
        <a href="/checkout" class="btn btn--primary">{{ 'cart.checkout' | t }}</a>
      </div>
    </div>
  </div>
</div>

<div class="cart-overlay" id="cart-overlay"></div>

<div class="mobile-nav-overlay" id="mobile-nav-overlay"></div>
<nav class="mobile-nav" id="mobile-nav" aria-hidden="true">
  <div class="mobile-nav-inner">
    <button class="mobile-nav-close" id="mobile-nav-close" aria-label="Close menu">✕</button>
    <div class="mobile-nav-logo">
      <a href="{{ routes.root_url }}" class="header-logo-link" aria-label="{{ 'general.home' | t }}">
        <img
          src="https://cdn.shopify.com/s/files/1/0954/9840/4181/files/logo_standard_black.svg?v=1764257556"
          alt="{{ shop.name }}"
          class="header-logo"
          loading="eager"
          width="220"
          height="60"
        >
      </a>
    </div>
    <ul class="mobile-nav-menu">
      <li><a href="{{ pages['all-products'].url }}">Shop</a></li>
      <li><a href="{{ routes.collections_url }}/outsider">Outsider</a></li>
      <li><a href="{{ routes.collections_url }}/gift-cards">Gift Card</a></li>
      <li><a href="{{ routes.collections_url }}/accessories">Accessories</a></li>
      <li><a href="{{ pages['news'].url }}">News</a></li>
    </ul>
    <div class="mobile-nav-actions">
      {% if shop.customer_accounts_enabled %}
        <a href="{{ routes.account_url }}" class="header-action header-account" aria-label="{{ 'customers.login.title' | t }}">
          <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z" fill="currentColor"/>
          </svg>
          <span class="visually-hidden">{{ 'customers.login.title' | t }}</span>
        </a>
      {% endif %}
      <a href="{{ routes.cart_url }}" class="header-action header-cart" id="mobile-cart-toggle" aria-label="{{ 'cart.title' | t }}">
        <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6h14l-2 8H8L6 6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round" fill="none"/>
          <path d="M6 6L5 3H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="9" cy="18" r="1.5" fill="currentColor"/>
          <circle cx="17" cy="18" r="1.5" fill="currentColor"/>
        </svg>
        <span class="visually-hidden">{{ 'cart.title' | t }}</span>
        <span
          class="cart-count{% if cart.item_count > 0 %} cart-count--visible{% endif %}"
          id="mobile-cart-count"
          aria-hidden="true"
        >
          {% if cart.item_count > 0 %}{{ cart.item_count }}{% endif %}
        </span>
      </a>
    </div>
  </div>
</nav>

<div class="clear-cart-modal" id="clear-cart-modal">
  <div class="modal-content">
    <h3>{{ 'cart.clear_confirm_title' | t }}</h3>
    <p>{{ 'cart.clear_confirm_message' | t }}</p>
    <div class="modal-actions">
      <button class="btn btn--secondary" id="modal-cancel">{{ 'general.cancel' | t }}</button>
      <button class="btn btn--primary" id="modal-confirm">{{ 'cart.clear' | t }}</button>
    </div>
  </div>
</div>
<div class="modal-overlay" id="modal-overlay"></div>

{% stylesheet %}
  :root {
    --announcement-height: 30px;
    --header-pad-top: 8px;
    --header-pad-top-mobile: 6px;
    --header-row-min-height: 36px;
  }

  .site-header {
    background-color: transparent;
    padding: var(--header-pad-top) 0;
    position: fixed;
    top: var(--announcement-height);
    left: 0;
    right: 0;
    width: 100%;
    z-index: 1000;
    --header-icon-size: 22px;
  }

  .site-header-backdrop {
    position: fixed;
    top: var(--announcement-height);
    left: 0;
    right: 0;
    width: 100%;
    z-index: 900;
    transition: background-color 0.3s ease, border-bottom-color 0.3s ease;
  }
  .site-header-spacer {
    height: var(--site-header-height, 0px);
  }

  .header-content {
    width: 100%;
    margin: 0;
    padding: 0 40px;
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: clamp(1.5rem, 5vw, 4rem);
  }

  .header-left {
    display: flex;
    align-items: center;
    justify-self: flex-start;
    gap: clamp(0.75rem, 3vw, 2.25rem);
  }

  .header-nav {
    justify-self: flex-start;
    display: flex;
    align-items: center;
  }

  .header-center {
    justify-self: center;
    display: flex;
    align-items: center;
  }

  .header-right {
    display: flex;
    align-items: center;
    justify-self: flex-end;
  }

  .header-identity {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .header-left .header-brand {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: var(--color-foreground);
    min-height: var(--header-row-min-height);
    padding: 10px 22px;
    border-radius: 999px;
    border: 1px solid color-mix(in oklab, var(--color-border), transparent 35%);
    box-shadow: 0 12px 25px rgba(10, 10, 10, 0.08);
    text-transform: uppercase;
    letter-spacing: 0.28em;
    font-size: clamp(0.9rem, 0.8rem + 0.3vw, 1.05rem);
    font-family: var(--font-heading-family, var(--font-primary-family));
  }

  .header-brand__text {
    white-space: nowrap;
  }

  .header-left .brand-logo {
    display: inline-block;
    width: 60px;
    height: auto;
    opacity: 0.5;
    filter: grayscale(1) contrast(1.2);
  }

  .header-tagline {
    margin: 0;
    font-size: 0.72rem;
    letter-spacing: 0.24em;
    text-transform: uppercase;
    color: color-mix(in oklab, var(--color-foreground), transparent 45%);
  }

  .header-center-badge::before {
    content: '\2022';
    font-size: 1.4rem;
    line-height: 0;
    opacity: 0.8;
  }

  .header-nav {
    display: flex;
    align-items: center;
  }

  .header-menu {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: clamp(1.5rem, 4vw, 3.5rem);
  }

  .header-menu-item {
    margin: 0;
  }

  .header-menu-link {
    color: var(--color-foreground);
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.95rem;
    font-weight: 500;
    transition: color 0.3s ease, filter 0.3s ease;
  }

  .header-menu-link:hover {
    color: var(--color-primary);
  }

  /* Dynamic contrast for header elements over media/images */
  .header-menu-link.is-over-media {
    color: #ffffff;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
  }

  .header-menu-link.is-over-media:hover {
    color: rgba(255, 255, 255, 0.7);
  }

  .header-action.is-over-media {
    color: #ffffff;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.4));
  }

  .header-action.is-over-media:hover {
    color: rgba(255, 255, 255, 0.7);
  }

  .header-hamburger.is-over-media {
    color: #ffffff;
  }


  .header-logo {
    display: block;
    flex-shrink: 0;
    height: 36px;
    width: auto;
    max-width: 200px;
    object-fit: contain;
    filter: none;
    box-shadow: none !important;
    opacity: 1 !important;
    border: none !important;
    background: transparent !important;
    transition: filter 0.3s ease;
  }

  /* Invert logo to white when over dark images/media */
  .header-logo.is-over-media {
    filter: brightness(0) invert(1) drop-shadow(0 1px 2px rgba(0, 0, 0, 0.4));
  }

  .header-logo-link {
    display: block;
    text-decoration: none;
  }

  .logo-placeholder {
    background-color: #ffffff;
    color: #000000;
    padding: 15px 20px;
    text-align: center;
    font-weight: bold;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .header-search {
    position: relative;
    display: flex;
    align-items: center;
  }

  .header-search-toggle {
    display: inline-flex;
  }

  .header-search.is-open .header-search-toggle {
    color: var(--color-primary);
  }

  .header-search-form {
    position: absolute;
    top: calc(100% + 12px);
    right: 0;
    width: 320px;
    padding: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--color-background);
    border-radius: var(--radius-base);
    border: 1px solid var(--color-border);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    opacity: 0;
    pointer-events: none;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    z-index: 100;
  }

  .header-search.is-open .header-search-form {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  .header-search-input {
    flex: 1;
    border: none;
    background: transparent;
    padding: 8px 12px;
    font-size: 14px;
    color: var(--color-foreground);
    font-family: var(--font-primary-family);
  }

  .header-search-input::placeholder {
    color: var(--color-foreground-muted);
  }

  .header-search-input:focus {
    outline: none;
  }

  .header-search-submit {
    border: none;
    background: var(--color-primary);
    color: var(--color-background);
    border-radius: var(--radius-base);
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s ease;
    flex-shrink: 0;
  }

  .header-search-submit:hover {
    background-color: var(--color-primary-hover);
    opacity: 1;
  }

  .predictive-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-top: none;
    border-radius: 0 0 var(--radius-base) var(--radius-base);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    max-height: 300px;
    overflow-y: auto;
    z-index: 101;
    display: none;
  }

  .predictive-search-results.has-results {
    display: block;
  }

  .predictive-search-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border-bottom: 1px solid var(--color-border);
    text-decoration: none;
    color: var(--color-foreground);
    transition: background-color 0.2s;
  }

  .predictive-search-item:last-child {
    border-bottom: none;
  }

  .predictive-search-item:hover {
    background-color: var(--color-surface);
  }

  .predictive-search-image {
    width: 40px;
    height: 40px;
    object-fit: contain;
    border-radius: 4px;
    background-color: #f5f5f5;
  }

  .predictive-search-info {
    flex: 1;
  }

  .predictive-search-title {
    font-size: 14px;
    font-weight: 500;
    margin: 0;
    line-height: 1.2;
  }

  .predictive-search-price {
    font-size: 12px;
    color: var(--color-foreground-muted);
    margin-top: 2px;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: clamp(1rem, 3vw, 2.5rem);
  }

  .header-action {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    border: none;
    background: transparent;
    color: var(--color-foreground);
    text-decoration: none;
    cursor: pointer;
    min-height: var(--header-row-min-height);
    transition: color 0.2s ease, transform 0.2s ease;
  }

  .header-action svg,
  .header-search-toggle .search-icon {
    display: block;
    width: var(--header-icon-size);
    height: var(--header-icon-size);
  }

  .header-action:hover {
    color: var(--color-primary);
    transform: translateY(-1px);
  }

  .header-hamburger {
    display: none;
    border-radius: 50%;
  }

  .header-hamburger:hover {
    color: var(--color-primary);
    background-color: transparent;
  }

  .visually-hidden {
    position: absolute !important;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .cart-count {
    position: absolute;
    top: -0.4rem;
    right: -0.55rem;
    min-width: 1.2rem;
    height: 1.2rem;
    border-radius: 999px;
    background-color: var(--color-primary);
    color: var(--color-background);
    font-size: 0.7rem;
    line-height: 1;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0 0.3rem;
  }

  .cart-count--visible {
    display: inline-flex;
  }

  /* Cart Sidebar */
  .cart-sidebar {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background-color: var(--color-background);
    border-left: 1px solid var(--color-border);
    outline: 1px solid var(--color-border);
    z-index: 1000;
    transition: right 0.3s ease;
  }

  .cart-sidebar.open {
    z-index: 100000;
    right: 0;
  }

  .cart-sidebar-content {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .cart-header {
    padding: 20px;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .cart-header h3 {
    color: var(--color-foreground);
    font-size: 18px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
  }

  .cart-close {
    background: none;
    border: none;
    color: var(--color-foreground);
    cursor: pointer;
    padding: 5px;
    transition: color 0.3s ease;
  }

  .cart-close:hover {
    color: var(--color-primary);
  }

  .cart-items {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
  }

  .cart-item {
    display: flex;
    gap: 10px;
    padding-bottom: 12px;
    margin-bottom: 12px;
    border-bottom: 1px solid var(--color-border);
  }

  .cart-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  /* Custom scrollbar for cart items */
  .cart-items {
    scrollbar-width: thin; /* Firefox */
    scrollbar-color: var(--color-primary) color-mix(in oklab, var(--color-surface), var(--color-background) 60%);
  }
  .cart-items::-webkit-scrollbar {
    width: 10px;
  }
  .cart-items::-webkit-scrollbar-track {
    background: color-mix(in oklab, var(--color-surface), var(--color-background) 60%);
    border-left: 1px solid var(--color-border);
  }
  .cart-items::-webkit-scrollbar-thumb {
    background: var(--color-primary);
    border: 2px solid color-mix(in oklab, var(--color-surface), var(--color-background) 60%);
    border-radius: 8px;
  }
  .cart-items::-webkit-scrollbar-thumb:hover {
    background: color-mix(in oklab, var(--color-primary), var(--color-foreground) 15%);
  }

  .cart-item-image {
    width: 76px;
    height: 76px;
    flex-shrink: 0;
    border-radius: 4px;
    overflow: hidden;
  }

  .cart-item-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background-color: transparent;
  }

  .cart-item-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .cart-item-title {
    color: var(--color-foreground);
    font-size: 15px;
    font-weight: 500;
    line-height: 1.25;
  }

  .cart-item-variant {
    color: #888888;
    font-size: 13px;
  }

  .cart-item-price {
    color: var(--color-primary);
    font-size: 15px;
    font-weight: 600;
  }

  .cart-item-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-top: 2px;
  }

  .cart-item-stock {
    color: var(--color-foreground);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    font-weight: 500;
  }

  .cart-item-quantity {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 0;
  }

  .quantity-btn {
    --btn-padding-x: 0;
    --btn-padding-y: 0;
    --btn-radius: 0;
    --btn-border: color-mix(in oklab, var(--color-foreground), transparent 35%);
    --btn-color: var(--color-foreground);
    --btn-hover-bg: color-mix(in oklab, var(--color-foreground), transparent 85%);
    --btn-hover-border: color-mix(in oklab, var(--color-foreground), transparent 20%);
    width: 32px;
    height: 32px;
    font-size: 15px;
    font-weight: var(--font-heading-weight);
    letter-spacing: 0.4px;
  }

  .quantity-btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
    --btn-border: color-mix(in oklab, var(--color-border), transparent 10%);
    --btn-hover-bg: transparent;
    --btn-hover-border: color-mix(in oklab, var(--color-border), transparent 10%);
  }

  .quantity-display {
    color: var(--color-foreground);
    font-size: 15px;
    min-width: 22px;
    text-align: center;
  }

  .cart-footer {
    padding: 12px 25px;
    padding-bottom: 50px;
    border-top: 1px solid var(--color-border);
  }

  .cart-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--color-foreground);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
  }

  .cart-actions {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  .cart-actions .btn {
    width: 100%;
    text-align: center;
  }

  .cart-view-btn {
    --btn-border: color-mix(in oklab, var(--color-border), transparent 15%);
    --btn-hover-border: color-mix(in oklab, var(--color-border), var(--color-primary) 20%);
  }

  .cart-view-btn:hover {
    background-color: var(--color-foreground);
    color: var(--color-background);
    text-decoration: none;
  }

  .cart-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .cart-overlay.open {
    z-index: 10000;
    opacity: 1;
    visibility: visible;
  }

  .cart-empty {
    text-align: center;
    color: var(--color-foreground);
    padding: 26px 18px;
    border: 1px dashed var(--color-border);
    margin: 20px 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .cart-empty p {
    font-size: 14px;
    margin: 0;
  }

  @media (max-width: 1250px) {
    .header-content {
      padding: 0 20px;
      gap: 20px;
    }
    .header-nav {
      display: none;
    }
    .header-hamburger {
      display: inline-flex;
    }
    .cart-sidebar {
      width: 350px;
      right: -350px;
    }
  }

  @media (max-width: 768px) {
    .site-header {
      padding: var(--header-pad-top-mobile) 0;
    }
    .header-content {
      display: flex;
      padding: 0 16px;
    }
    .header-left {
      justify-self: start;
      grid-column: 1;
      min-width: 85px;
    }
    .header-left .header-brand {
      display: none;
    }
    .header-nav {
      margin-top: 0;
      justify-self: flex-start;
    }
    .header-right {
      grid-column: 3;
      justify-self: flex-end;
    }
    .header-actions {
      justify-content: flex-end;
      gap: 0.75rem;
    }
    .locale-switcher summary {
      padding: 4px;
    }
    .logo-placeholder {
      padding: 10px 15px;
      font-size: 12px;
    }
    .cart-sidebar {
      width: 350px;
      right: -350px;
    }
    .cart-item-image {
      width: 56px;
      height: 56px;
    }
    .cart-item-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .header-search-form {
      position: fixed;
      top: calc(var(--announcement-height, 46px) + var(--site-header-height, 80px) + 10px);
      left: 20px;
      right: 20px;
      width: auto;
      transform: translateY(-10px);
    }
    .header-search.is-open .header-search-form {
      transform: translateY(0);
    }
  }

    @media (max-width: 640px) {
    .cart-items {
      max-height: 450px;
    }

  }

  /* Clear Cart Modal */
  .clear-cart-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.98);
    /* enforce black/white palette for modals */
    --modal-bg: var(--color-surface);
    --modal-fg: var(--color-foreground);
    background: var(--modal-bg);
    color: var(--modal-fg);
    font-family: var(--font-heading-family);
    border: 1px solid var(--color-border);
    padding: 40px;
    z-index: 1001;
    width: 400px;
    max-width: 92vw;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s ease, visibility 0.25s ease, transform 0.25s ease;
    border-radius: var(--radius-base);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  }

  .clear-cart-modal.open {
    z-index: 1000000;
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
  }

  .modal-content {
    padding: 0;
    background: transparent;
  }

  .modal-content h3 {
    color: var(--modal-fg);
    margin: 0 0 16px 0;
    font-size: 24px;
    text-align: center;
    font-weight: 400;
    text-transform: none;
    letter-spacing: 0;
  }

  .modal-content p {
    color: var(--modal-fg);
    margin: 0 0 24px 0;
    text-align: center;
    font-size: 16px;
    line-height: 1.6;
    opacity: 0.8;
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .modal-actions .btn {
    flex: 1;
    min-width: 0;
    text-align: center;
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.open {
    opacity: 1;
    visibility: visible;
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  /* Side Cart Item Styles (Matching Main Cart) */
  .cart-sidebar .cart-item-card {
    display: grid;
    grid-template-columns: 75px 1fr 100px;
    gap: 15px;
    padding: 20px 0;
    border-bottom: 1px solid var(--color-border);
    align-items: start;
    background: transparent;
  }
  
  .cart-sidebar .cart-item-card:last-child {
    border-bottom: none;
  }

  .cart-sidebar .item-image {
    width: 65px;
    height: 80px;
    border-radius: 4px;
    overflow: hidden;
  }

  .cart-sidebar .item-image img {
    transition: transform 0.5s ease;
  }

  .cart-sidebar .cart-item-card:hover .item-image img {
    transform: scale(1.05);
  }

  .cart-sidebar .item-info {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .cart-sidebar .item-title {
    font-family: var(--font-heading-family);
    font-size: 16px;
    font-weight: 500;
    margin: 0;
    color: var(--color-foreground);
    text-decoration: none;
    line-height: 1.3;
    text-transform: uppercase;
  }

  .cart-sidebar .item-variant-price-wrapper {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .cart-sidebar .item-variant {
    font-size: 13px;
    color: var(--color-foreground-muted);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .cart-sidebar .variant-price {
    font-size: 14px;
    color: var(--color-foreground);
    font-weight: 400;
  }
  
  .cart-sidebar .price-label {
    font-size: 12px;
    color: var(--color-foreground-muted);
    margin-left: 4px;
  }

  .cart-sidebar .item-actions-column {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 12px;
  }

  .cart-sidebar .quantity-wrapper {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }

  .cart-sidebar .quantity-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-foreground-muted);
  }

  .cart-sidebar .quantity-controls {
    display: flex;
    align-items: center;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    padding: 0;
    background: var(--color-background);
    height: 28px;
  }

  .cart-sidebar .quantity-btn {
    width: 24px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--color-foreground);
    cursor: pointer;
    font-size: 14px;
    padding: 0;
  }

  .cart-sidebar .qty-display {
    width: 24px;
    text-align: center;
    font-size: 13px;
    font-weight: 500;
  }

  .cart-sidebar .stock-info {
    font-size: 10px;
    color: var(--color-warning);
    text-align: right;
  }

  .cart-sidebar .total-wrapper {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
  }

  .cart-sidebar .total-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-foreground-muted);
  }

  .cart-sidebar .item-total-price {
    font-family: var(--font-heading-family);
    font-size: 15px;
    font-weight: 500;
    color: var(--color-foreground);
  }

  .cart-sidebar .remove-item-btn {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-foreground-muted);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: color 0.2s;
    margin-top: 4px;
  }

  .cart-sidebar .remove-item-btn:hover {
    color: var(--color-error);
  }

  .sold-out-badge {
    color: var(--color-error);
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
{% endstylesheet %}

{% javascript %}
  document.addEventListener('DOMContentLoaded', function () {
    // Keep content from jumping under fixed header by syncing spacer height
    const headerEl = document.querySelector('.site-header');
    const headerSpacer = document.getElementById('site-header-spacer');
    const headerBackdrop = document.querySelector('.site-header-backdrop');
    const setHeaderSpacer = () => {
      if (!headerEl || !headerSpacer) return;
      const rect = headerEl.getBoundingClientRect();
      const computed = getComputedStyle(headerEl);
      const padTop = parseFloat(computed.paddingTop) || 0;
      const padBottom = parseFloat(computed.paddingBottom) || 0;
      const height = rect.height; // already includes paddings
      headerSpacer.style.setProperty('height', `${height}px`);
      document.documentElement.style.setProperty('--site-header-height', `${height}px`);
      if (headerBackdrop) headerBackdrop.style.height = `${height}px`;
    };
    setHeaderSpacer();
    window.addEventListener('resize', () => {
      setHeaderSpacer();
    });
    // Toggle per-element contrast depending on media underneath the header.
    // We'll use CSS `filter` on the logo instead of swapping `src` to avoid
    // loading/switching image assets.

    // Per-element detection: sample the point just below the header at the
    // horizontal center of each interactive element and toggle a class on
    // that element only when the area below it contains an image or
    // background-image. This allows switching only the logo, or only a
    // specific link, rather than the whole header.
    const announcementHeight = () => parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--announcement-height')) || 46;
    const headerHeight = () => parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--site-header-height')) || (headerEl ? headerEl.getBoundingClientRect().height : 0);

    // More conservative media detection:
    // - For IMG nodes require either an ancestor with theme full-width classes
    //   or that the image height is a significant portion of the viewport.
    // - For background-image require a non-gradient background and prefer
    //   nodes with theme full-width classes.
    const isLightColor = (colorStr) => {
      // colorStr e.g. 'rgb(255, 255, 255)' or 'rgba(...)' or 'transparent'
      if (!colorStr || colorStr === 'transparent') return false;
      const m = colorStr.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      if (!m) return false;
      const r = parseInt(m[1], 10), g = parseInt(m[2], 10), b = parseInt(m[3], 10);
      // Relative luminance (simple) — normalize to 0..1
      const lum = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
      return lum > 0.9; // too light -> treat as not a media background
    };

    const detectMediaAt = (x, y) => {
      if (y > window.innerHeight || x < 0 || x > window.innerWidth) return false;
      const el = document.elementFromPoint(x, y);
      if (!el) return false;

      // If the element itself is a theme full-width image container, accept
      const candidate = el.closest('.full-width-image-container, .full-width-image, .fullscreen-slide, .full-width-images-section');
      if (candidate) return true;

      // Walk ancestors for IMG/background checks
      let node = el;
      while (node && node !== document.documentElement) {
        if (node.tagName === 'IMG') {
          const imgRect = node.getBoundingClientRect();
          // Require image to cover a decent chunk of the viewport height
          if (imgRect.height >= (window.innerHeight * 0.3)) return true;
          // Also accept if image is explicitly inside a full-width container
          if (node.closest('.full-width-image-container, .fullscreen-slide')) return true;
        }

        const bg = getComputedStyle(node).backgroundImage || '';
        const bgColor = getComputedStyle(node).backgroundColor || '';
        if (bg && bg !== 'none' && bg.indexOf('gradient') === -1) {
          if (!isLightColor(bgColor)) return true;
          // If background is light color, don't treat as media
        }

        node = node.parentElement;
      }
      return false;
    };

    const logoEl = headerEl.querySelector('.header-logo');
    const menuLinks = Array.from(headerEl.querySelectorAll('.header-menu-link'));
    // Include search toggle and cart so each action can invert individually
    const actions = Array.from(headerEl.querySelectorAll('.header-action'));

    const samplePointsForElement = (el) => {
      const rect = el.getBoundingClientRect();
      const y = Math.round(announcementHeight() + headerHeight() + 2);
      // sample 3 horizontal positions: left third, center, right third
      const p1 = { x: Math.round(rect.left + rect.width * 0.25), y };
      const p2 = { x: Math.round(rect.left + rect.width * 0.5), y };
      const p3 = { x: Math.round(rect.left + rect.width * 0.75), y };
      return [p1, p2, p3];
    };

    const majorityTrue = (arr) => arr.filter(Boolean).length >= 2;

    const updatePerElementContrast = () => {
      // Logo: apply by default
      if (logoEl) {
        const points = samplePointsForElement(logoEl);
        const results = points.map(p => detectMediaAt(p.x, p.y));
        logoEl.classList.toggle('is-over-media', majorityTrue(results));
      }

      // Menu links: toggle class individually using majority sampling
      menuLinks.forEach((link) => {
        const points = samplePointsForElement(link);
        const results = points.map(p => detectMediaAt(p.x, p.y));
        link.classList.toggle('is-over-media', majorityTrue(results));
      });

      // Actions (icons/buttons)
      actions.forEach((act) => {
        const points = samplePointsForElement(act);
        const results = points.map(p => detectMediaAt(p.x, p.y));
        act.classList.toggle('is-over-media', majorityTrue(results));
      });
    };

    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => { updatePerElementContrast(); ticking = false; });
        ticking = true;
      }
    }, { passive: true });
    window.addEventListener('resize', updatePerElementContrast);
    // run initially after spacer calculated
    updatePerElementContrast();
    const cartToggle = document.getElementById('cart-toggle');
    const cartSidebar = document.getElementById('cart-sidebar');
    const cartOverlay = document.getElementById('cart-overlay');
    const cartClose = document.getElementById('cart-close');
    const cartItems = document.getElementById('cart-items');
    const cartCount = document.getElementById('cart-count');
    const mobileCartCount = document.getElementById('mobile-cart-count');
    const cartTotal = document.getElementById('cart-total');
    // Localized option labels mapping via themeStrings (set in layout)
    const translateOptionName = (name) => {
      if (!name) return '';
      const key = String(name).trim().toLowerCase();
      if (key === 'size' || key === 'tamanho') return window.themeStrings?.option_size_label || name;
      if (key === 'color' || key === 'cor') return window.themeStrings?.option_color_label || name;
      return name;
    };

    // Store current cart data for stock validation
    let currentCartData = null;
    let currentInventoryData = {};

    // Predictive Search
    const searchInput = document.getElementById('header-search-input');
    const searchResults = document.getElementById('predictive-search-results');
    let searchTimeout;

    if (searchInput && searchResults) {
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length === 0) {
          searchResults.innerHTML = '';
          searchResults.classList.remove('has-results');
          return;
        }

        searchTimeout = setTimeout(() => {
          fetch(`/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=5`)
            .then(response => response.json())
            .then(data => {
              const products = data.resources.results.products;
              
              if (products.length > 0) {
                searchResults.innerHTML = products.map(product => `
                  <a href="${product.url}" class="predictive-search-item">
                    <img src="${product.image}" alt="${product.title}" class="predictive-search-image" width="40" height="40">
                    <div class="predictive-search-info">
                      <h4 class="predictive-search-title">${product.title}</h4>
                      <div class="predictive-search-price">
                        ${product.available ? product.price + ' €' : '<span class="sold-out-badge">Sold Out</span>'}
                      </div>
                    </div>
                  </a>
                `).join('');
                searchResults.classList.add('has-results');
              } else {
                searchResults.innerHTML = '<div class="predictive-search-item">No results found</div>';
                searchResults.classList.add('has-results');
              }
            })
            .catch(error => {
              console.error('Error fetching search suggestions:', error);
            });
        }, 300); // Debounce for 300ms
      });

      // Close search results when clicking outside
      document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
          searchResults.classList.remove('has-results');
        }
      });
    }

    // Open cart sidebar
    function openCart() {
      cartSidebar.classList.add('open');
      cartOverlay.classList.add('open');
      document.body.style.overflow = 'hidden';
      loadCartItems();
    }

    // Close cart sidebar
    function closeCart() {
      cartSidebar.classList.remove('open');
      cartOverlay.classList.remove('open');
      document.body.style.overflow = '';
    }

    // Event listeners
    cartToggle.addEventListener('click', function (e) {
      e.preventDefault();

      if (document.body.dataset.template === 'cart') {
        return;
      }
      openCart();
    });

    const mobileCartToggle = document.getElementById('mobile-cart-toggle');
    if (mobileCartToggle) {
      mobileCartToggle.addEventListener('click', function (e) {
        e.preventDefault();
        closeMobileNav(); // Close mobile nav first
        openCart();
      });
    }

    cartClose.addEventListener('click', closeCart);
    cartOverlay.addEventListener('click', closeCart);

    // Load cart items via AJAX
    function loadCartItems() {
      // Fetch both cart data and inventory data
      Promise.all([
        fetch('/cart.js').then(res => res.json()),
        fetch('/?section_id=cart-inventory').then(res => res.text())
      ])
      .then(([cart, inventoryHtml]) => {
        // Parse inventory data from the section HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(inventoryHtml, 'text/html');
        const inventoryJson = doc.getElementById('inventory-data')?.textContent;
        
        if (inventoryJson) {
          try {
            const data = JSON.parse(inventoryJson);
            currentInventoryData = data.items || {};
          } catch (e) {
            console.error('Error parsing inventory data', e);
            currentInventoryData = {};
          }
        }

        // Store cart data for stock validation
        currentCartData = cart;

        renderCartItems(cart);
        updateCartCount(cart.item_count);
        updateCartTotal(cart.total_price);
      })
      .catch((error) => {
        console.error('Error loading cart:', error);
      });
    }

    // Mobile nav toggle
    const mobileNavToggle = document.getElementById('mobile-nav-toggle');
    const mobileNav = document.getElementById('mobile-nav');
    const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
    const mobileNavClose = document.getElementById('mobile-nav-close');
    const headerLogoImg = document.querySelector('.header-logo');
    const mobileLogoSrc = 'https://cdn.shopify.com/s/files/1/0954/9840/4181/files/Logo_black.svg?v=1764257555';
    const originalLogoSrc = headerLogoImg ? headerLogoImg.getAttribute('src') : null;

    function openMobileNav() {
      if (!mobileNav || !mobileNavOverlay) return;
      mobileNav.classList.add('open');
      mobileNavOverlay.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeMobileNav() {
      if (!mobileNav || !mobileNavOverlay) return;
      mobileNav.classList.remove('open');
      mobileNavOverlay.classList.remove('open');
      document.body.style.overflow = '';
    }

    if (mobileNavToggle) mobileNavToggle.addEventListener('click', function (e) {
      e.preventDefault();
      openMobileNav();
    });
    if (mobileNavClose) mobileNavClose.addEventListener('click', closeMobileNav);
    if (mobileNavOverlay) mobileNavOverlay.addEventListener('click', closeMobileNav);

    // Render cart items
    function renderCartItems(cart) {
      // Store cart data for stock validation
      currentCartData = cart;

      if (cart.items.length === 0) {
        cartItems.innerHTML = `
        <div class="cart-empty">
          <p>${window.themeStrings?.cart_empty_title || 'Your cart is empty'}</p>
        </div>
      `;
        return;
      }

      cartItems.innerHTML = cart.items
        .map((item) => {
          // Build translated variant string from options
          let variantHtml = '';
          const opts = Array.isArray(item.options_with_values) ? item.options_with_values : [];
          const nonDefault = !(opts.length === 1 && String(opts[0]?.name || '').toLowerCase() === 'title');
          
          if (opts.length && nonDefault) {
            const parts = opts.map((ov) => {
              let optClass = 'variant-option';
              const optNameDown = ov.name.toLowerCase();
              if (optNameDown.includes('size') || optNameDown.includes('tamanho')) {
                optClass = 'size-badge';
              }
              return `<span class="${optClass}">${translateOptionName(ov.name)}: ${ov.value}</span>`;
            });
            variantHtml = `<div class="item-variant">${parts.join('')}</div>`;
          }

          // Get inventory data for this item
          const inventoryItem = currentInventoryData[item.key];
          
          const hasInventoryLimit = 
            inventoryItem &&
            inventoryItem.inventory_management === 'shopify' &&
            inventoryItem.inventory_policy === 'deny' &&
            inventoryItem.inventory_quantity !== null;
            
          const availableStock = hasInventoryLimit ? inventoryItem.inventory_quantity : null;
          const isMaxQuantity = hasInventoryLimit && item.quantity >= availableStock;

          return `
      <div class="cart-item-card" data-key="${item.key}">
        <div class="item-image">
          <a href="${item.url}" style="display: block; width: 100%; height: 100%;">
            ${item.featured_image 
              ? `<img src="${item.featured_image.url}?width=160" alt="${item.product_title}" loading="lazy" width="80" height="80">` 
              : '<div class="no-image">No Image</div>'}
          </a>
        </div>

        <div class="item-info">
          <a href="${item.url}" style="text-decoration: none; color: inherit;">
            <h3 class="item-title">${item.product_title}</h3>
          </a>
          
          <div class="item-variant-price-wrapper">
            ${variantHtml}
            <span class="variant-price">
              ${item.original_line_price !== item.line_price 
                ? `<span class="original-price">${formatMoneyEuro(item.original_price)}</span>
                   <span class="discounted-price">${formatMoneyEuro(item.price)}</span>`
                : `<span class="unit-price">${formatMoneyEuro(item.price)}</span>`
              }
              <span class="price-label">each</span>
            </span>
          </div>
        </div>

        <div class="item-actions-column">
          <div class="quantity-wrapper">
            <label class="quantity-label">QUANTITY</label>
            <div class="quantity-controls">
              <button
                type="button"
                class="quantity-btn quantity-decrease"
                data-key="${item.key}"
                ${item.quantity <= 1 ? 'disabled' : ''}
              >
                −
              </button>
              <span class="qty-display" data-key="${item.key}">${item.quantity}</span>
              <button
                type="button"
                class="quantity-btn quantity-increase"
                data-key="${item.key}"
              >
                +
              </button>
            </div>
            ${hasInventoryLimit 
              ? `` 
              : ''}
          </div>
          
          <div class="total-wrapper">
            <label class="total-label">TOTAL</label>
            <div class="item-total-price">${formatMoneyEuro(item.line_price)}</div>
          </div>

          <button class="remove-item-btn" data-key="${item.key}">
            × REMOVE
          </button>
        </div>
      </div>
      `;
        })
        .join('');

      // Add event listeners for quantity buttons
      addQuantityListeners();
    }

    // Add quantity change listeners
    function addQuantityListeners() {
      const decreaseButtons = document.querySelectorAll('.cart-sidebar .quantity-decrease');
      const increaseButtons = document.querySelectorAll('.cart-sidebar .quantity-increase');
      const removeButtons = document.querySelectorAll('.cart-sidebar .remove-item-btn');

      decreaseButtons.forEach((btn) => {
        btn.addEventListener('click', function () {
          const key = this.dataset.key;
          const qtyDisplay = this.parentElement.querySelector('.qty-display');
          const currentQty = parseInt(qtyDisplay.textContent);
          if (currentQty > 1) {
            updateCartItem(key, currentQty - 1);
          }
        });
      });

      increaseButtons.forEach((btn) => {
        btn.addEventListener('click', function () {
          const key = this.dataset.key;
          const qtyDisplay = this.parentElement.querySelector('.qty-display');
          const currentQty = parseInt(qtyDisplay.textContent);
          const newQty = currentQty + 1;

          // Check if we can increase using the same logic as main cart
          // if (canIncreaseQuantity(key, newQty)) {
            updateCartItem(key, newQty);
          // }
        });
      });
      
      removeButtons.forEach((btn) => {
        btn.addEventListener('click', function() {
          const key = this.dataset.key;
          removeCartItem(key);
        });
      });
    }

    // Helper function to check if quantity can be increased (same as main cart)
    function canIncreaseQuantity(key, newQuantity) {
      // Check inventory data first
      const inventoryItem = currentInventoryData[key];
      
      if (inventoryItem && 
          inventoryItem.inventory_management === 'shopify' && 
          inventoryItem.inventory_policy === 'deny' && 
          inventoryItem.inventory_quantity !== null) {
          
        const availableStock = inventoryItem.inventory_quantity;
        
        if (newQuantity > availableStock) {
          const msgTpl = window.themeStrings?.only_x_available || 'Only ___COUNT___ items available in stock.';
          showError(msgTpl.replace('___COUNT___', availableStock));
          return false;
        }
        return true;
      }

      // Fallback to DOM check
      const itemCard = document.querySelector(`.cart-sidebar .cart-item-card[data-key="${key}"]`);
      const stockInfo = itemCard ? itemCard.querySelector('.stock-info') : null;

      if (stockInfo) {
        // Extract available stock from text, language-agnostic: just take the first number
        const stockText = stockInfo.textContent;
        const availableStock = parseInt(stockText.match(/(\d+)/)?.[1]);

        if (availableStock && newQuantity > availableStock) {
          const msgTpl = window.themeStrings?.only_x_available || 'Only ___COUNT___ items available in stock.';
          showError(msgTpl.replace('___COUNT___', availableStock));
          return false;
        }
      }

      return true;
    }

    // Update cart item quantity
    function updateCartItem(key, quantity) {
      const formData = new FormData();
      formData.append('updates[' + key + ']', quantity);

      fetch('/cart/update.js', {
        method: 'POST',
        body: formData,
      })
        .then((response) => response.json())
        .then((cart) => {
          // Update stored cart data first
          currentCartData = cart;
          
          // Re-fetch inventory data to ensure it's up to date (optional but safer)
          fetch('/?section_id=cart-inventory')
            .then(res => res.text())
            .then(inventoryHtml => {
              const parser = new DOMParser();
              const doc = parser.parseFromString(inventoryHtml, 'text/html');
              const inventoryJson = doc.getElementById('inventory-data')?.textContent;
              if (inventoryJson) {
                try {
                  const data = JSON.parse(inventoryJson);
                  currentInventoryData = data.items || {};
                } catch (e) { console.error(e); }
              }
              
              renderCartItems(cart);
              updateCartCount(cart.item_count);
              updateCartTotal(cart.total_price);
            });

          // Broadcast cart update event for main cart page
          window.dispatchEvent(
            new CustomEvent('cartUpdated', {
              detail: { cart: cart, source: 'sidebar' },
            })
          );
        })
        .catch((error) => {
          console.error('Error updating cart:', error);
        });
    }

    // Remove cart item
    function removeCartItem(key) {
      updateCartItem(key, 0);
    }

    // Update cart count in header
    function updateCartCount(count) {
      [cartCount, mobileCartCount].forEach(el => {
        if (!el) return;
        if (count > 0) {
          el.textContent = count;
          el.classList.add('cart-count--visible');
        } else {
          el.textContent = '';
          el.classList.remove('cart-count--visible');
        }
      });
    }

    // Update cart total
    function updateCartTotal(totalPrice) {
      cartTotal.textContent = formatMoneyEuro(totalPrice);
    }

    // Format money using shop currency (fallback to simple format)
    function formatMoneyEuro(cents) {
      const amount = Math.abs(cents || 0);
      const euros = Math.floor(amount / 100);
      const centsPart = amount % 100;
      const centsStr = String(centsPart).padStart(2, '0');
      const eurosStr = String(euros).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      return `${eurosStr},${centsStr} €`;
    }

    // Show error notification
    window.showError = function(message) {
      // Create a simple error notification
      const errorDiv = document.createElement('div');
      errorDiv.className = 'notification-toast notification-toast-error';
      errorDiv.textContent = message;

      document.body.appendChild(errorDiv);

      setTimeout(() => {
        errorDiv.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
          if (document.body.contains(errorDiv)) {
            document.body.removeChild(errorDiv);
          }
        }, 300);
      }, 3000);
    }

    // Global function to add item and update cart (called from product page)
    window.addToCartAndUpdate = function (formData) {
      if (window.loadingScreen) window.loadingScreen.show();
      return fetch('/cart/add.js', {
        method: 'POST',
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          // Update cart count immediately
          return fetch('/cart.js');
        })
        .then((response) => response.json())
        .then((cart) => {
          // Update stored cart data
          currentCartData = cart;

          updateCartCount(cart.item_count);

          // Broadcast cart update event for main cart page
          window.dispatchEvent(
            new CustomEvent('cartUpdated', {
              detail: { cart: cart, source: 'sidebar' },
            })
          );
          
          if (window.loadingScreen) window.loadingScreen.hide();
          return cart;
        })
        .catch((error) => {
          console.error('Error adding to cart:', error);
          if (window.loadingScreen) window.loadingScreen.hide();
          throw error;
        });
    };

    // Clear Cart Modal Functionality
    const clearCartBtn = document.getElementById('clear-cart-btn');
    const clearCartModal = document.getElementById('clear-cart-modal');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalCancel = document.getElementById('modal-cancel');
    const modalConfirm = document.getElementById('modal-confirm');

    // Open modal
    if (clearCartBtn) {
      clearCartBtn.addEventListener('click', function () {
        clearCartModal.classList.add('open');
        modalOverlay.classList.add('open');
      });
    }

    // Close modal
    function closeModal() {
      clearCartModal.classList.remove('open');
      modalOverlay.classList.remove('open');
    }

    if (modalCancel) {
      modalCancel.addEventListener('click', closeModal);
    }

    if (modalOverlay) {
      modalOverlay.addEventListener('click', closeModal);
    }

    // Confirm clear cart
    if (modalConfirm) {
      modalConfirm.addEventListener('click', function () {
        // Clear cart via Shopify API
        fetch('/cart/clear.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then((response) => {
            if (response.ok) {
              // Update UI immediately
              updateCartCount(0);
              cartItems.innerHTML =
                '<p style="color: #cccccc; text-align: center; padding: 40px;">' +
                (window.themeStrings?.cart_empty_title || 'Your cart is empty') +
                '</p>';
              cartTotal.textContent = formatMoneyEuro(0);

              // Broadcast cart clear event for main cart page
              window.dispatchEvent(
                new CustomEvent('cartCleared', {
                  detail: { source: 'sidebar' },
                })
              );

              // Close modal and cart
              closeModal();
              closeCart();
            } else {
              throw new Error('Failed to clear cart');
            }
          })
          .catch((error) => {
            closeModal();
          });
      });
    }

    // Listen for cart updates from main cart page
    window.addEventListener('cartUpdated', function (event) {
      if (event.detail.source !== 'sidebar') {
        const cart = event.detail.cart;

        // Update stored cart data
        currentCartData = cart;

        updateCartCount(cart.item_count);
        updateCartTotal(cart.total_price);

        // If sidebar is open, refresh the items
        if (cartSidebar.classList.contains('open')) {
          renderCartItems(cart);
        }
      }
    });

    // Listen for cart clear events from main cart page
    window.addEventListener('cartCleared', function (event) {
      if (event.detail.source !== 'sidebar') {
        updateCartCount(0);
        cartTotal.textContent = formatMoneyEuro(0);

        // If sidebar is open, show empty state
        if (cartSidebar.classList.contains('open')) {
          cartItems.innerHTML = '<p style="color: #cccccc; text-align: center; padding: 40px;">Your cart is empty</p>';
        }
      }
    });

    // Header inline search dropdown
    const inlineSearch = document.querySelector('[data-search]');
    const inlineSearchToggle = inlineSearch?.querySelector('.header-search-toggle');
    const inlineSearchInput = inlineSearch?.querySelector('.header-search-input');
    const inlineSearchForm = inlineSearch?.querySelector('form');

    const closeInlineSearch = () => {
      if (!inlineSearch) return;
      inlineSearch.classList.remove('is-open');
      document.body.classList.remove('search-open');
      inlineSearchToggle?.setAttribute('aria-expanded', 'false');
    };

    const openInlineSearch = () => {
      if (!inlineSearch) return;
      inlineSearch.classList.add('is-open');
      document.body.classList.add('search-open');
      inlineSearchToggle?.setAttribute('aria-expanded', 'true');
      requestAnimationFrame(() => inlineSearchInput?.focus());
    };

    inlineSearchToggle?.addEventListener('click', (event) => {
      event.stopPropagation();
      if (inlineSearch?.classList.contains('is-open')) {
        closeInlineSearch();
      } else {
        openInlineSearch();
      }
    });

    inlineSearchForm?.addEventListener('click', (event) => {
      event.stopPropagation();
    });

    document.addEventListener('click', (event) => {
      if (!inlineSearch) return;
      if (!inlineSearch.contains(event.target)) {
        closeInlineSearch();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeInlineSearch();
      }
    });

    inlineSearchForm?.addEventListener('submit', () => {
      closeInlineSearch();
    });
  });
{% endjavascript %}

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo Image"
    },
    {
      "type": "text",
      "id": "tagline",
      "label": "Tagline",
      "default": "Lisbon / Worldwide shipping"
    }
  ]
}
{% endschema %}
