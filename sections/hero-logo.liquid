{% schema %}
{
  "name": "Hero Logo Animation",
  "settings": [
    {
      "type": "range",
      "id": "max_width",
      "min": 50,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "Max Logo Width",
      "default": 80
    }
  ],
  "presets": [
    {
      "name": "Hero Logo Animation"
    }
  ]
}
{% endschema %}

<div class="hero-logo-container">
  <div class="hero-logo-wrapper">
    <div class="hero-logo-composite">
      <img src="https://cdn.shopify.com/s/files/1/0954/9840/4181/files/Logo_horizontal_black.svg?v=1764257555" width="100%" height="100%" class="hero-text" alt="Icon">
    </div>
  </div>
</div>

<style>
  .hero-logo-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    pointer-events: none;
    z-index: 950;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1; /* Visible at top (Scroll 0) */
    padding-bottom: 30vh; /* Move logo up visually */
  }

  .hero-logo-wrapper {
    width: {{ section.settings.max_width }}%;
    max-width: 1000px;
    display: flex;
    justify-content: center;
    will-change: transform, width;
  }

  .hero-logo-composite {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    width: 100%;
  }

  .hero-icon {
    height: auto;
    width: 15%; /* Adjust proportion */
    max-width: 100px;
  }

  .hero-text {
    height: auto;
    width: 85%;
  }

  /* Header States */
  /* Initial State (Top): Logo Hidden, Slogan Visible */
  body.template-index .site-header .header-logo {
    display: none;
    opacity: 0;
  }
  
  body.template-index .site-header .header-slogan {
    display: block;
    opacity: 1;
    transition: opacity 0.2s ease;
  }

  /* Scrolled State: Logo Visible, Slogan Hidden */
  body.template-index .site-header.is-scrolled .header-logo {
    display: block;
    opacity: 1;
  }
  
  body.template-index .site-header.is-scrolled .header-slogan {
    display: none;
    opacity: 0;
  }
  
  body.template-index .site-header-backdrop {
    background-color: transparent;
    border-bottom: none;
  }
  
  body.template-index .site-header.is-scrolled ~ .site-header-backdrop,
  body.template-index .site-header.is-scrolled + .site-header-backdrop {
    /* This selector is tricky because backdrop is a sibling BEFORE header */
    /* We need to target backdrop based on header class, but CSS can't select previous sibling */
    /* So we need to toggle class on backdrop via JS or use a different structure */
  }
  
  /* Correct way: target backdrop directly via class added by JS */
  body.template-index .site-header-backdrop.is-scrolled {
    background-color: var(--color-background);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.hero-logo-container');
    const wrapper = document.querySelector('.hero-logo-wrapper');
    const headerLogo = document.querySelector('.site-header .header-logo');
    const headerSlogan = document.querySelector('.site-header .header-slogan');
    const header = document.querySelector('.site-header');
    const headerBackdrop = document.querySelector('.site-header-backdrop');
    
    if (!container || !wrapper) return;

    let bigWidth; // Width in Hero State (Start)
    let bigHeight;
    let bigTop;
    let bigLeft;
    let aspectRatio;

    function initDimensions() {
      // Reset styles to get natural CSS-defined dimensions (Hero State)
      wrapper.style.width = '';
      wrapper.style.transform = '';
      
      const rect = wrapper.getBoundingClientRect();
      bigWidth = rect.width;
      bigHeight = rect.height;
      bigTop = rect.top;
      bigLeft = rect.left;
      aspectRatio = rect.width / rect.height;
      
      handleScroll();
    }

    function easeOutCubic(x) {
      return 1 - Math.pow(1 - x, 3);
    }

    // Helper to measure the hidden header logo accurately
    function getTargetRect() {
        if (!headerLogo) return { top: 20, left: 20, width: 220 };

        // Save current state
        const prevLogoDisplay = headerLogo.style.display;
        const prevSloganDisplay = headerSlogan ? headerSlogan.style.display : '';
        const prevHeaderClass = header.className;
        const prevHeaderTransition = header.style.transition;

        // Disable transitions to get final state immediately
        header.style.transition = 'none';
        headerLogo.style.transition = 'none';

        // Force "Scrolled" state where logo is visible and slogan is hidden
        header.classList.add('is-scrolled');
        headerLogo.style.display = 'block';
        headerLogo.style.opacity = '0'; // Keep invisible but layout-active
        if (headerSlogan) headerSlogan.style.display = 'none';

        // Force reflow
        void headerLogo.offsetWidth;

        // Measure
        const rect = headerLogo.getBoundingClientRect();

        // Restore state
        header.className = prevHeaderClass;
        headerLogo.style.display = prevLogoDisplay;
        headerLogo.style.opacity = ''; // Clear opacity override
        if (headerSlogan) headerSlogan.style.display = prevSloganDisplay;
        
        // Restore transitions
        header.style.transition = prevHeaderTransition;
        headerLogo.style.transition = '';

        return rect;
    }

    function handleScroll() {
      const scrollY = window.scrollY;
      const windowHeight = window.innerHeight;
      const scrollThreshold = windowHeight * 0.6; 
      
      // Target Dimensions (Header Logo Position)
      // We want the Hero Logo to shrink to where the Header Logo IS (or will be)
      let targetTop = 20;
      let targetLeft = 20;
      let targetWidth = 220;
      
      // Measure accurately
      const targetRect = getTargetRect();
      targetTop = targetRect.top;
      targetLeft = targetRect.left;
      targetWidth = targetRect.width;

      let rawProgress = Math.min(scrollY / scrollThreshold, 1);
      let progress = easeOutCubic(rawProgress);
      
      if (rawProgress < 1) {
        // Animation Phase
        container.style.opacity = '1';
        header.classList.remove('is-scrolled'); 
        if (headerBackdrop) headerBackdrop.classList.remove('is-scrolled');
        
        // Slogan Fading
        if (headerSlogan) {
            headerSlogan.style.display = 'inline-block';
            // Fade out in the last 50% of the scroll
            let fadeOutStart = 0.5;
            if (rawProgress > fadeOutStart) {
                let opacity = 1 - ((rawProgress - fadeOutStart) / (1 - fadeOutStart));
                headerSlogan.style.opacity = Math.max(0, opacity).toString();
            } else {
                headerSlogan.style.opacity = '1';
            }
        }
        
        // Ensure Header Logo is hidden
        if (headerLogo) {
            headerLogo.style.display = 'none';
        }

        // Use Scale for smoother animation
        // Calculate Scale Factor
        const scale = 1 - ((1 - (targetWidth / bigWidth)) * progress);
        
        // Interpolate Position (Top-Left)
        // From bigTop/Left to targetTop/Left
        const desiredX = bigLeft + (targetLeft - bigLeft) * progress;
        const desiredY = bigTop + (targetTop - bigTop) * progress;
        
        // Calculate Transform
        // When scaling, the element shrinks towards its center.
        // We need to translate it so its top-left corner ends up at desiredX, desiredY.
        
        // Current Center (if just scaled in place)
        const naturalCenterX = bigLeft + bigWidth / 2;
        const naturalCenterY = bigTop + bigHeight / 2;
        
        // Target Center (where we want the center to be)
        // Target Center = Desired TopLeft + (Current Width / 2)
        const currentWidth = bigWidth * scale;
        const currentHeight = bigHeight * scale;
        
        const targetCenterX = desiredX + currentWidth / 2;
        const targetCenterY = desiredY + currentHeight / 2;
        
        const translateX = targetCenterX - naturalCenterX;
        const translateY = targetCenterY - naturalCenterY;
        
        wrapper.style.width = `${bigWidth}px`; // Keep original width, use scale
        wrapper.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        
      } else {
        // Animation Complete (Scrolled Down)
        // Hide Hero Logo
        container.style.opacity = '0';
        
        // Show Header Logo
        header.classList.add('is-scrolled');
        if (headerBackdrop) headerBackdrop.classList.add('is-scrolled');
        
        if (headerLogo) {
            headerLogo.style.display = 'block';
            headerLogo.style.opacity = '1';
        }
        if (headerSlogan) {
            headerSlogan.style.display = 'none';
        }
      }
    }
    
    // Initialize
    const img = wrapper.querySelector('img');
    if (img.complete) {
        initDimensions();
    } else {
        img.onload = initDimensions;
    }

    window.addEventListener('scroll', () => {
      requestAnimationFrame(handleScroll);
    });
    
    window.addEventListener('resize', () => {
        initDimensions();
    });
  });
</script>
