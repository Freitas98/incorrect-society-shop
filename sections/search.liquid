{% comment %}
  This section is used in the search template to render search results for
  products, articles, and pages.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/search
{% endcomment %}

<div class="search-section">
  <div class="search-header">
    {% if search.performed %}
      {% if search.results_count == 0 %}
        <h1 class="search-title">{{ 'search.no_results_title' | t }}</h1>
        <p class="search-subtitle">{{ 'search.no_results_html' | t: terms: search.terms }}</p>
        <div class="no-results-illustration">
          <svg width="280" height="280" viewBox="0 0 200 200" class="not-found-svg">
            <!-- Search magnifying glass -->
            <circle cx="80" cy="80" r="30" fill="none" stroke="var(--color-primary)" stroke-width="4"/>
            <line x1="105" y1="105" x2="130" y2="130" stroke="var(--color-primary)" stroke-width="4" stroke-linecap="round"/>

            <!-- X mark inside the magnifying glass -->
            <line x1="65" y1="65" x2="95" y2="95" stroke="var(--color-foreground)" stroke-width="3" stroke-linecap="round"/>
            <line x1="95" y1="65" x2="65" y2="95" stroke="var(--color-foreground)" stroke-width="3" stroke-linecap="round"/>

            <!-- Dotted lines around for "searching" effect -->
            <circle cx="100" cy="100" r="60" fill="none" stroke="var(--color-border)" stroke-width="2" stroke-dasharray="5,5" opacity="0.5"/>
            <circle cx="100" cy="100" r="80" fill="none" stroke="var(--color-border)" stroke-width="1" stroke-dasharray="3,3" opacity="0.3"/>
          </svg>
          <p class="no-results-message">{{ 'search.no_results_suggestion' | t }}</p>
        </div>
      {% else %}
        <h1 class="search-title">{{ 'search.results_title' | t }}</h1>
        <p class="search-subtitle">
          {{ 'search.results_for_html' | t: count: search.results_count, terms: search.terms }}
        </p>
      {% endif %}
    {% else %}
      <h1 class="search-title">{{ 'search.title' | t }}</h1>
      <p class="search-subtitle">{{ 'search.welcome_subtitle' | t }}</p>
      <div class="search-welcome-illustration">
        <svg width="280" height="280" viewBox="0 0 200 200" class="search-welcome-svg">
              <!-- Search magnifying glass -->
          <circle cx="80" cy="80" r="30" fill="none" stroke="var(--color-primary)" stroke-width="4"/>
          <line x1="105" y1="105" x2="130" y2="130" stroke="var(--color-primary)" stroke-width="4" stroke-linecap="round"/>

              <!-- Question mark inside the magnifying glass -->
              <path d="M75 70 Q75 65, 80 65 Q85 65, 85 70 Q85 75, 82 77 L82 82 M82 88 L82 92"
            stroke="var(--color-foreground)" stroke-width="3" stroke-linecap="round" fill="none"/>

              <!-- Dotted lines around for "searching" effect -->
          <circle cx="100" cy="100" r="60" fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-dasharray="5,5" opacity="0.6"/>
          <circle cx="100" cy="100" r="80" fill="none" stroke="var(--color-primary)" stroke-width="1" stroke-dasharray="3,3" opacity="0.4"/>
        </svg>
        <p class="search-welcome-message">{{ 'search.welcome_message' | t }}</p>
      </div>
    {% endif %}
  </div>

  {% if search.performed and search.results_count > 0 %}
    <div class="search-results">
      {% paginate search.results by 12 %}
        {% for result in search.results %}
          {% if result.object_type == 'product' %}
            <div class="product-card"
                 data-product-id="{{ result.id }}"
                 data-product-handle="{{ result.handle }}"
                 data-available="{{ result.available }}">
              <div class="product-image-container">
                <a href="{{ result.url }}" class="product-link">
                  <div class="product-image">
                    {% if result.featured_media %}
                      <img
                        src="{{ result.featured_media | image_url: width: 600 }}"
                        alt="{{ result.featured_media.alt | escape | default: result.title }}"
                        class="product-image-main"
                        width="600"
                        height="600"
                        loading="lazy"
                      >
                      {% if result.media[1] %}
                        <img 
                          src="{{ result.media[1] | image_url: width: 600 }}" 
                          alt="{{ result.media[1].alt | escape | default: result.title }}"
                          class="product-image-hover"
                          loading="lazy"
                          width="600"
                          height="600"
                        >
                      {% endif %}
                    {% else %}
                      <div class="product-image-placeholder">
                        {{ 'general.no_image' | t }}
                      </div>
                    {% endif %}
                  </div>
                </a>
                
                <!-- Quick Add Button -->
                {% if result.available %}
                  <button type="button" 
                          class="quick-add-btn" 
                          data-product-id="{{ result.id }}"
                          data-product-handle="{{ result.handle }}"
                          aria-label="Quick add {{ result.title }}">
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
                      <path d="M7 0V14M0 7H14" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                  </button>
                {% endif %}
                
                <!-- Quick Add Variant Selector -->
                <div class="quick-add-variants" data-product-handle="{{ result.handle }}">
                  <button class="quick-add-close" aria-label="Close">&times;</button>
                  <div class="quick-add-variants-list">
                    <!-- Populated via JS -->
                  </div>
                </div>
              </div>

              <div class="product-info">
                <div class="product-info-separator"></div>
                <div class="product-info-row">
                  <a href="{{ result.url }}" class="product-title-link">
                    <h3 class="product-title">{{ result.title }}</h3>
                  </a>
                  <span class="product-price">
                    {% if result.available %}
                      {% render 'price', amount: result.price, product: result %}
                    {% else %}
                      <span class="sold-out-text">{{ 'products.product.sold_out' | t }}</span>
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}

        {{ paginate | default_pagination }}
      {% endpaginate %}
    </div>
  {% endif %}
</div>

{% stylesheet %}
  .search-section {
    padding: 60px 40px;
  }

  .search-header {
    text-align: center;
    margin-bottom: 60px;
  }

  .search-title {
    font-size: 32px;
    font-weight: var(--font-heading-weight);
    text-transform: uppercase;
    letter-spacing: var(--font-heading-letter-spacing);
    color: var(--color-foreground);
    margin: 0 0 20px 0;
  }

  .search-subtitle {
    font-size: 16px;
    color: var(--color-foreground);
    opacity: 0.8;
    margin: 0;
  }

  .no-results-image {
    margin-bottom: 30px;
  }

  .no-results-logo {
    max-width: 150px;
    height: auto;
    opacity: 0.6;
    filter: grayscale(100%);
  }

  .no-results-illustration {
    margin-top: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  .not-found-svg {
    opacity: 0.8;
    animation: gentle-pulse 3s ease-in-out infinite;
  }

  .no-results-message {
    font-size: 16px;
    color: var(--color-foreground);
    opacity: 0.7;
    text-align: center;
    max-width: 400px;
    line-height: 1.5;
    margin: 0;
  }

  @keyframes gentle-pulse {
    0%,
    100% {
      transform: scale(1);
      opacity: 0.8;
    }
    50% {
      transform: scale(1.05);
      opacity: 1;
    }
  }

  .search-welcome-illustration {
    margin-top: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  .search-welcome-svg {
    opacity: 0.9;
    animation: gentle-pulse 4s ease-in-out infinite;
  }

  .search-welcome-message {
    font-size: 16px;
    color: var(--color-foreground);
    opacity: 0.7;
    text-align: center;
    max-width: 400px;
    line-height: 1.5;
    margin: 0;
  }

  .search-results {
    display: grid;
    grid-template-columns: repeat(4, minmax(180px, 280px));
    gap: 20px;
    max-width: 1400px;
    margin: 0 auto;
    justify-content: center;
  }

  .product-card {
    background-color: transparent;
    position: relative;
  }

  .product-image-container {
    position: relative;
  }

  .product-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .product-image {
    position: relative;
    width: 100%;
    aspect-ratio: 3/4;
    background-color: var(--color-surface, #f5f5f5);
    overflow: hidden;
  }

  .product-image-main,
  .product-image-hover {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: center;
    transition: opacity 0.4s ease;
  }

  .product-image-hover {
    opacity: 0;
  }

  .product-link:hover .product-image:has(.product-image-hover) .product-image-main {
    opacity: 0;
  }

  .product-link:hover .product-image-hover {
    opacity: 1;
  }

  .product-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-surface);
    color: var(--color-foreground);
    opacity: 0.8;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Quick Add Button */
  .quick-add-btn {
    position: absolute;
    bottom: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
    background: transparent;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.25s ease, transform 0.25s ease, color 0.2s ease;
    z-index: 5;
    color: var(--color-foreground);
  }

  .product-card:hover .quick-add-btn {
    opacity: 1;
    transform: translateY(0);
  }
  
  .quick-add-btn.hidden {
    opacity: 0 !important;
    pointer-events: none;
  }

  .quick-add-btn:hover {
    color: var(--color-primary);
  }

  .quick-add-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Quick Add Variants */
  .quick-add-variants {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(255, 255, 255, 0.97);
    backdrop-filter: blur(4px);
    padding: 16px 10px 14px 10px;
    z-index: 10;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.25s ease;
  }

  .quick-add-variants.is-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .quick-add-close {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    font-size: 18px;
    font-weight: 300;
    cursor: pointer;
    color: var(--color-foreground);
    opacity: 0.4;
    transition: opacity 0.2s ease;
    line-height: 1;
    padding: 4px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .quick-add-close:hover {
    opacity: 1;
  }

  .quick-add-variants-list {
    display: flex;
    gap: 0;
    flex-wrap: nowrap;
    justify-content: center;
    align-items: center;
  }

  .quick-add-variant-btn {
    min-width: 40px;
    height: 36px;
    padding: 0 12px;
    border: none;
    background-color: transparent;
    font-family: var(--font-primary-family);
    font-size: 14px;
    font-weight: 400;
    cursor: pointer;
    transition: opacity 0.15s ease;
    color: var(--color-foreground);
  }

  .quick-add-variant-btn:hover:not(:disabled) {
    opacity: 0.6;
  }

  .quick-add-variant-btn:disabled {
    opacity: 0.25;
    cursor: not-allowed;
    text-decoration: line-through;
  }

  /* Product Info */
  .product-info {
    padding: 0;
  }

  .product-info-separator {
    height: 1px;
    background-color: var(--color-border);
    margin: 12px 0 10px 0;
  }

  .product-info-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 10px;
  }

  .product-title-link {
    text-decoration: none;
    color: inherit;
    flex: 1;
    min-width: 0;
  }

  .product-title {
    font-family: var(--font-primary-family);
    font-size: 12px;
    font-weight: 400;
    margin: 0;
    color: var(--color-foreground);
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    text-transform: uppercase;
  }

  .product-price {
    font-size: 12px;
    font-weight: 400;
    color: var(--color-foreground);
    white-space: nowrap;
    flex-shrink: 0;
    margin: 0;
  }

  .sold-out-text {
    color: var(--color-foreground);
    opacity: 0.4;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 0.5px;
  }

  /* Pagination styling */
  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 60px;
    gap: 10px;
    width: 100%;
  }

  .pagination a,
  .pagination span {
    padding: 10px 15px;
    color: var(--color-foreground);
    text-decoration: none;
    border: 1px solid var(--color-border);
    transition: all 0.3s ease;
  }

  .pagination a:hover {
  background-color: var(--color-primary);
  border-color: var(--color-primary);
  }

  .pagination .current {
  background-color: var(--color-primary);
  border-color: var(--color-primary);
  }

  /* When fewer than 3 items, they'll be centered automatically */
  @media (max-width: 1200px) {
    .search-results {
      grid-template-columns: repeat(3, minmax(180px, 280px));
    }
  }

  @media (max-width: 1024px) {
    .search-section {
      padding: 40px 20px;
    }

    .search-results {
      grid-template-columns: repeat(3, minmax(160px, 240px));
      gap: 15px;
    }

    .search-header {
      margin-bottom: 40px;
    }

    .search-title {
      font-size: 24px;
    }
  }

  @media (max-width: 768px) {
    .search-title {
      font-size: 20px;
      letter-spacing: 1px;
    }

    .search-results {
      grid-template-columns: repeat(2, minmax(140px, 1fr));
      gap: 12px;
    }
    
    .quick-add-btn {
      opacity: 1;
      transform: translateY(0);
    }
    
    .product-title {
      font-size: 11px;
    }
    
    .product-price {
      font-size: 11px;
    }
  }

  @media (max-width: 480px) {
    .search-section {
      padding: 20px;
    }
  }
{% endstylesheet %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.querySelector('.search-section');
    if (!section) return;

    // Quick Add functionality
    const quickAddBtns = section.querySelectorAll('.quick-add-btn');
    let currentOpenVariants = null;
    let currentOpenBtn = null;

    const closeAllVariants = () => {
      section.querySelectorAll('.quick-add-variants.is-open').forEach(el => {
        el.classList.remove('is-open');
      });
      if (currentOpenBtn) {
        currentOpenBtn.classList.remove('hidden');
      }
      currentOpenVariants = null;
      currentOpenBtn = null;
    };

    // Close variants when clicking outside
    document.addEventListener('click', (e) => {
      if (currentOpenVariants && !e.target.closest('.quick-add-variants') && !e.target.closest('.quick-add-btn')) {
        closeAllVariants();
      }
    });

    quickAddBtns.forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();

        const card = this.closest('.product-card');
        const productHandle = this.dataset.productHandle;
        const variantsContainer = card.querySelector('.quick-add-variants');
        const variantsList = variantsContainer.querySelector('.quick-add-variants-list');

        // Close other open variants first
        closeAllVariants();

        try {
          const response = await fetch(`/products/${productHandle}.js`);
          const product = await response.json();

          // Find size option (handle both string and object formats)
          const sizeOptionIndex = product.options.findIndex(opt => {
            const optName = typeof opt === 'string' ? opt : (opt.name || opt.title || '');
            return optName.toLowerCase().includes('size') || optName.toLowerCase().includes('tamanho');
          });

          if (sizeOptionIndex !== -1 && product.variants.length > 1) {
            // Get unique sizes only
            const seenSizes = new Set();
            const uniqueVariants = [];
            
            product.variants.forEach(variant => {
              const size = variant.options[sizeOptionIndex];
              if (!seenSizes.has(size)) {
                seenSizes.add(size);
                const availableForSize = product.variants.some(v => 
                  v.options[sizeOptionIndex] === size && v.available
                );
                uniqueVariants.push({ 
                  size, 
                  id: variant.id, 
                  available: availableForSize 
                });
              }
            });

            // Build variant buttons
            variantsList.innerHTML = uniqueVariants.map(v => `
              <button 
                type="button"
                class="quick-add-variant-btn" 
                data-variant-id="${v.id}"
                ${!v.available ? 'disabled' : ''}
              >${v.size}</button>
            `).join('');

            // Hide the + button and show variants
            this.classList.add('hidden');
            variantsContainer.classList.add('is-open');
            currentOpenVariants = variantsContainer;
            currentOpenBtn = this;

            // Add click handlers to variant buttons
            variantsList.querySelectorAll('.quick-add-variant-btn').forEach(variantBtn => {
              variantBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!this.disabled) {
                  const variantId = this.dataset.variantId;
                  addToCart(variantId);
                  closeAllVariants();
                }
              });
            });
          } else {
            // No size variants, add directly
            const availableVariant = product.variants.find(v => v.available) || product.variants[0];
            if (availableVariant) {
              addToCart(availableVariant.id);
            }
          }
        } catch (error) {
          console.error('Error fetching product:', error);
        }
      });
    });

    // Close button handlers
    section.querySelectorAll('.quick-add-close').forEach(closeBtn => {
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        closeAllVariants();
      });
    });

    // Add to cart function
    async function addToCart(variantId, quantity = 1) {
      const formData = new FormData();
      formData.append('id', variantId);
      formData.append('quantity', quantity);

      try {
        if (window.addToCartAndUpdate) {
          await window.addToCartAndUpdate(formData);
        } else {
          await fetch('/cart/add.js', {
            method: 'POST',
            body: formData
          });
          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();
          
          const cartCounts = document.querySelectorAll('.cart-count');
          cartCounts.forEach(el => {
            if (cart.item_count > 0) {
              el.textContent = cart.item_count;
              el.classList.add('cart-count--visible');
            }
          });
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
      }
    }
  });
</script>

{% schema %}
{
  "name": "t:general.search",
  "settings": []
}
{% endschema %}
