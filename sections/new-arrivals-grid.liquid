{% comment %}
  New Arrivals Grid Section
  Features: Category tabs, product badges, color swatches, quick add with variants
{% endcomment %}

{% liquid
  assign collection_handle = section.settings.collection | default: 'all'
  assign products_to_show = section.settings.products_count | default: 12
  assign title = section.settings.title | default: 'New Arrivals'
  
  if collection_handle == 'all'
    assign products = collections.all.products
  else
    assign products = collections[collection_handle].products
  endif
%}

<section class="new-arrivals-section" style="position: relative; z-index: 1;">
  <div class="new-arrivals-container">
    <!-- Header with title and category tabs -->
    <div class="new-arrivals-header">
      <h2 class="new-arrivals-title">{{ title }}</h2>
      
      <div class="filters-wrapper">
        <nav class="category-tabs" role="tablist">
          <button class="category-tab active" data-filter="all" role="tab" aria-selected="true">
            View all<sup class="tab-count">{{ products.size }}</sup>
          </button>
          {% for collection in section.settings.featured_collections %}
            {% assign col = collections[collection] %}
            {% if col %}
              <button class="category-tab" data-filter="{{ col.handle }}" role="tab" aria-selected="false">
                {{ col.title }}<sup class="tab-count">{{ col.products_count }}</sup>
              </button>
            {% endif %}
          {% endfor %}
        </nav>
        
        <!-- Filter Dropdowns -->
        <div class="filter-dropdowns">
          <div class="filter-dropdown">
            <button class="filter-dropdown-btn" data-dropdown="size">
              Size
              <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                <path d="M2 3.5L5 6.5L8 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </button>
            <div class="filter-dropdown-content" data-dropdown-content="size">
              <button class="filter-option" data-size="all">All sizes</button>
              <button class="filter-option" data-size="XS">XS</button>
              <button class="filter-option" data-size="S">S</button>
              <button class="filter-option" data-size="M">M</button>
              <button class="filter-option" data-size="L">L</button>
              <button class="filter-option" data-size="XL">XL</button>
              <button class="filter-option" data-size="XXL">XXL</button>
            </div>
          </div>
          
          <div class="filter-dropdown">
            <button class="filter-dropdown-btn" data-dropdown="availability">
              Availability
              <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                <path d="M2 3.5L5 6.5L8 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </button>
            <div class="filter-dropdown-content" data-dropdown-content="availability">
              <button class="filter-option" data-availability="all">All</button>
              <button class="filter-option" data-availability="in-stock">In stock</button>
              <button class="filter-option" data-availability="out-of-stock">Out of stock</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Grid -->
    <div class="new-arrivals-grid">
      {% for product in products limit: products_to_show %}
        {% liquid
          # Get badge from metafield or determine automatically
          assign badge_text = product.metafields.custom.badge | default: ''
          assign badge_class = ''
          
          # Check if product is new (created within last 30 days)
          if badge_text == blank
            assign now_timestamp = 'now' | date: '%s' | plus: 0
            assign product_timestamp = product.created_at | date: '%s' | plus: 0
            assign days_old = now_timestamp | minus: product_timestamp | divided_by: 86400
            
            if days_old <= 30
              assign badge_text = 'NEW IN'
              assign badge_class = 'badge-new'
            endif
          else
            if badge_text contains 'BACK'
              assign badge_class = 'badge-back'
            else
              assign badge_class = 'badge-new'
            endif
          endif
          
          # Get color variants
          assign color_option = nil
          for option in product.options_with_values
            assign option_name_down = option.name | downcase
            if option_name_down contains 'color' or option_name_down contains 'colour' or option_name_down contains 'cor'
              assign color_option = option
              break
            endif
          endfor
        %}
        
        <article class="product-card-enhanced" 
                 data-product-id="{{ product.id }}"
                 data-product-handle="{{ product.handle }}"
                 data-collections="{% for col in product.collections %}{{ col.handle }},{% endfor %}"
                 data-available="{{ product.available }}"
                 data-product-type="{{ product.metafields.custom.type | downcase }}">
          
          <div class="product-image-container">
            <a href="{{ product.url }}" class="product-card-link">
              <!-- Product Image Container -->
              <div class="product-image-wrapper">
                {% if badge_text != '' %}
                  <span class="product-badge {{ badge_class }}">{{ badge_text }}</span>
                {% endif %}
                
                {% if product.featured_media %}
                  <img 
                    src="{{ product.featured_media | image_url: width: 600 }}" 
                    alt="{{ product.featured_media.alt | escape | default: product.title }}"
                    class="product-image-main"
                    loading="lazy"
                    width="600"
                    height="800"
                  >
                  {% if product.media[1] %}
                    <img 
                      src="{{ product.media[1] | image_url: width: 600 }}" 
                      alt="{{ product.media[1].alt | escape | default: product.title }}"
                      class="product-image-hover"
                      loading="lazy"
                      width="600"
                      height="800"
                    >
                  {% endif %}
                {% else %}
                  <div class="product-image-placeholder">
                    {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  </div>
                {% endif %}
              </div>
            </a>
            
            <!-- Quick Add Button -->
            {% if product.available %}
              <button type="button" 
                      class="quick-add-btn" 
                      data-product-id="{{ product.id }}"
                      data-product-handle="{{ product.handle }}"
                      aria-label="Quick add {{ product.title }}">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
                  <path d="M7 0V14M0 7H14" stroke="currentColor" stroke-width="1.5"/>
                </svg>
              </button>
            {% endif %}
            
            <!-- Quick Add Variant Selector -->
            <div class="quick-add-variants" data-product-handle="{{ product.handle }}">
              <button class="quick-add-close" aria-label="Close">Ã—</button>
              <div class="quick-add-variants-list">
                <!-- Populated via JS -->
              </div>
            </div>
          </div>
          
          <!-- Product Info with separator line -->
          <div class="product-info-enhanced">
            <div class="product-info-separator"></div>
            <div class="product-info-row">
              <a href="{{ product.url }}" class="product-title-link">
                <span class="product-title-enhanced">{{ product.title }}</span>
              </a>
              <span class="product-price-enhanced">
                {% if product.available %}
                  {% render 'price', amount: product.price, product: product %}
                {% else %}
                  <span class="sold-out-text">{{ 'products.product.sold_out' | t }}</span>
                {% endif %}
              </span>
            </div>
            
            <!-- Color Swatches -->
            {% if color_option and color_option.values.size > 1 %}
              <div class="color-swatches">
                {% for color_value in color_option.values limit: 6 %}
                  {% liquid
                    assign color_handle = color_value | handleize
                    case color_handle
                      when 'black' or 'preto'
                        assign swatch_color = '#000000'
                      when 'white' or 'branco'
                        assign swatch_color = '#ffffff'
                      when 'grey' or 'gray' or 'cinzento'
                        assign swatch_color = '#808080'
                      when 'light-grey' or 'light-gray' or 'melange'
                        assign swatch_color = '#d3d3d3'
                      when 'navy' or 'navy-blue' or 'azul-marinho'
                        assign swatch_color = '#1a1a3e'
                      when 'blue' or 'azul'
                        assign swatch_color = '#2563eb'
                      when 'red' or 'vermelho'
                        assign swatch_color = '#dc2626'
                      when 'pink' or 'rosa'
                        assign swatch_color = '#f9a8d4'
                      when 'green' or 'verde'
                        assign swatch_color = '#16a34a'
                      when 'brown' or 'castanho'
                        assign swatch_color = '#78350f'
                      when 'beige' or 'bege'
                        assign swatch_color = '#d4c4a8'
                      when 'cream' or 'creme'
                        assign swatch_color = '#fffdd0'
                      when 'yellow' or 'amarelo'
                        assign swatch_color = '#eab308'
                      when 'orange' or 'laranja'
                        assign swatch_color = '#ea580c'
                      when 'purple' or 'roxo'
                        assign swatch_color = '#7c3aed'
                      else
                        assign swatch_color = '#cccccc'
                    endcase
                  %}
                  <span 
                    class="color-swatch{% if forloop.first %} active{% endif %}" 
                    style="background-color: {{ swatch_color }};"
                    title="{{ color_value }}"
                    data-color="{{ color_value }}"
                  ></span>
                {% endfor %}
              </div>
            {% endif %}
          </div>
          
          <!-- Quick Add Variant Selector (inline, attached to card) -->
          <div class="quick-add-variants" data-product-handle="{{ product.handle }}">
            <button class="quick-add-close" aria-label="Close">&times;</button>
            <div class="quick-add-variants-list">
              <!-- Populated via JS -->
            </div>
          </div>
        </article>
      {% endfor %}
    </div>
  </div>
</section>

<style>
  .new-arrivals-section {
    padding: 60px 0;
    background-color: var(--color-background);
  }

  .new-arrivals-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 40px;
  }

  .new-arrivals-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 40px;
    margin-bottom: 40px;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 20px;
    flex-wrap: wrap;
  }

  .new-arrivals-title {
    font-family: var(--font-heading-family);
    font-size: clamp(22px, 4vw, 32px);
    font-weight: var(--font-heading-weight);
    margin: 0;
    white-space: nowrap;
    color: var(--color-foreground);
  }

  .filters-wrapper {
    display: flex;
    align-items: center;
    gap: 30px;
    flex: 1;
    justify-content: flex-end;
  }

  .category-tabs {
    display: flex;
    gap: 28px;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-bottom: 2px;
  }

  .category-tabs::-webkit-scrollbar {
    display: none;
  }

  /* Filter Dropdowns */
  .filter-dropdowns {
    display: flex;
    gap: 20px;
  }

  .filter-dropdown {
    position: relative;
  }

  .filter-dropdown-btn {
    background: none;
    border: none;
    font-family: var(--font-primary-family);
    font-size: 12px;
    color: var(--color-foreground);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 0;
    opacity: 0.6;
    transition: opacity 0.2s ease;
  }

  .filter-dropdown-btn:hover {
    opacity: 1;
  }

  .filter-dropdown-btn svg {
    transition: transform 0.2s ease;
  }

  .filter-dropdown.is-open .filter-dropdown-btn svg {
    transform: rotate(180deg);
  }

  .filter-dropdown-content {
    position: absolute;
    top: 100%;
    right: 0;
    min-width: 150px;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    padding: 8px 0;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
  }

  .filter-dropdown.is-open .filter-dropdown-content {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .filter-option {
    display: block;
    width: 100%;
    padding: 8px 16px;
    background: none;
    border: none;
    text-align: left;
    font-family: var(--font-primary-family);
    font-size: 12px;
    color: var(--color-foreground);
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .filter-option:hover {
    background-color: var(--color-surface);
  }

  .filter-option.active {
    color: var(--color-primary);
  }

  .category-tab {
    background: none;
    border: none;
    padding: 0;
    font-family: var(--font-primary-family);
    font-size: 14px;
    color: var(--color-foreground);
    opacity: 0.4;
    cursor: pointer;
    white-space: nowrap;
    transition: opacity 0.2s ease;
    position: relative;
  }

  .category-tab:hover {
    opacity: 0.7;
  }

  .category-tab.active {
    opacity: 1;
  }

  .tab-count {
    font-size: 10px;
    margin-left: 1px;
    vertical-align: super;
    opacity: 0.6;
  }

  /* Product Grid */
  .new-arrivals-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 30px 20px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .product-card-enhanced {
    width: calc(25% - 15px);
    position: relative;
  }

  @media (max-width: 1400px) {
    .new-arrivals-grid {
      gap: 25px 15px;
    }
    
    .product-card-enhanced {
      width: calc(25% - 12px);
    }
  }

  @media (max-width: 1100px) {
    .product-card-enhanced {
      width: calc(33.333% - 10px);
    }
  }

  @media (max-width: 768px) {
    .new-arrivals-section {
      padding: 40px 0;
    }
    
    .new-arrivals-container {
      padding: 0 15px;
    }
    
    .new-arrivals-grid {
      gap: 20px 12px;
    }
    
    .product-card-enhanced {
      width: calc(50% - 6px);
    }
    
    .new-arrivals-header {
      flex-direction: column;
      gap: 15px;
      margin-bottom: 25px;
      padding-bottom: 15px;
    }
    
    .new-arrivals-title {
      font-size: 22px;
    }
    
    .product-title-enhanced {
      font-size: 11px;
    }
    
    .product-price-enhanced {
      font-size: 11px;
    }
    
    .quick-add-btn {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @media (max-width: 480px) {
    .new-arrivals-container {
      padding: 0 12px;
    }
    
    .new-arrivals-grid {
      gap: 15px 10px;
    }
    
    .product-card-enhanced {
      width: calc(50% - 5px);
    }
  }

  /* Product Card */
  .product-card-enhanced[data-visible="false"] {
    display: none;
  }

  .product-image-container {
    position: relative;
    width: 100%;
  }

  .product-card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .product-image-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 3 / 4;
    overflow: hidden;
    background-color: var(--color-surface, #f5f5f5);
  }

  .product-image-main,
  .product-image-hover {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: center;
    transition: opacity 0.4s ease;
  }

  .product-image-hover {
    opacity: 0;
  }

  /* Only hide main image on hover when there's a hover image */
  .product-card-link:hover .product-image-wrapper:has(.product-image-hover) .product-image-main {
    opacity: 0;
  }

  .product-card-link:hover .product-image-hover {
    opacity: 1;
  }

  .product-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f0f0f0;
  }

  /* Product Badge */
  .product-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 6px 10px;
    font-size: 9px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 2;
    background-color: transparent;
    color: var(--color-foreground);
  }

  .product-badge.badge-new {
    background-color: transparent;
    color: var(--color-foreground);
  }

  .product-badge.badge-back {
    background-color: transparent;
    color: var(--color-foreground);
  }

  /* Quick Add Button */
  .quick-add-btn {
    position: absolute;
    bottom: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
    background: transparent;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.25s ease, transform 0.25s ease, color 0.2s ease;
    z-index: 3;
    color: var(--color-foreground);
  }

  .product-card-enhanced:hover .quick-add-btn {
    opacity: 1;
    transform: translateY(0);
  }
  
  .quick-add-btn.hidden {
    opacity: 0 !important;
    pointer-events: none;
  }

  .quick-add-btn:hover {
    color: var(--color-primary);
  }

  .quick-add-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Product Info */
  .product-info-enhanced {
    padding: 0;
  }

  .product-info-separator {
    height: 1px;
    background-color: var(--color-border);
    margin: 12px 0 10px 0;
  }

  .product-info-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 10px;
  }

  .product-title-link {
    text-decoration: none;
    color: inherit;
    flex: 1;
    min-width: 0;
  }

  .product-title-enhanced {
    font-family: var(--font-primary-family);
    font-size: 12px;
    font-weight: 400;
    margin: 0;
    color: var(--color-foreground);
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
  }

  .product-price-enhanced {
    font-size: 12px;
    font-weight: 400;
    color: var(--color-foreground);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .sold-out-text {
    color: var(--color-foreground);
    opacity: 0.4;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 0.5px;
  }

  /* Color Swatches */
  .color-swatches {
    display: flex;
    gap: 4px;
    align-items: center;
    margin-top: 8px;
  }

  .color-swatch {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.15);
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .color-swatch:hover {
    transform: scale(1.3);
  }

  /* Quick Add Variants (inline horizontal selector like image) */
  .quick-add-variants {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(255, 255, 255, 0.97);
    backdrop-filter: blur(4px);
    padding: 16px 10px 14px 10px;
    z-index: 10;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.25s ease;
  }

  .quick-add-variants.is-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .quick-add-close {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    font-size: 18px;
    font-weight: 300;
    cursor: pointer;
    color: var(--color-foreground);
    opacity: 0.4;
    transition: opacity 0.2s ease;
    line-height: 1;
    padding: 4px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .quick-add-close:hover {
    opacity: 1;
  }

  .quick-add-variants-list {
    display: flex;
    gap: 0;
    flex-wrap: nowrap;
    justify-content: center;
    align-items: center;
  }

  .quick-add-variant-btn {
    min-width: 40px;
    height: 36px;
    padding: 0 12px;
    border: none;
    background-color: transparent;
    font-family: var(--font-primary-family);
    font-size: 13px;
    font-weight: 400;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--color-foreground);
  }

  .quick-add-variant-btn:hover:not(:disabled) {
    text-decoration: underline;
  }

  .quick-add-variant-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  @media (max-width: 768px) {
    .new-arrivals-header {
      flex-direction: column;
      gap: 20px;
    }
    
    .filters-wrapper {
      width: 100%;
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }
    
    .filter-dropdowns {
      width: 100%;
      justify-content: flex-start;
    }
    
    .product-title-enhanced {
      font-size: 11px;
    }
    
    .product-price-enhanced {
      font-size: 11px;
    }
    
    .quick-add-btn {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.querySelector('.new-arrivals-section');
    if (!section) return;

    // Category Tab Filtering
    const tabs = section.querySelectorAll('.category-tab');
    const products = section.querySelectorAll('.product-card-enhanced');
    
    // Current filter state
    let activeFilters = {
      collection: 'all',
      size: 'all',
      availability: 'all',
      type: 'all'
    };

    // Check URL for type filter parameter
    const urlParams = new URLSearchParams(window.location.search);
    const typeParam = urlParams.get('type');
    if (typeParam) {
      activeFilters.type = typeParam.toLowerCase();
    }

    // Filter Dropdown functionality
    const filterDropdowns = section.querySelectorAll('.filter-dropdown');
    
    filterDropdowns.forEach(dropdown => {
      const btn = dropdown.querySelector('.filter-dropdown-btn');
      const options = dropdown.querySelectorAll('.filter-option');
      
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close other dropdowns
        filterDropdowns.forEach(d => {
          if (d !== dropdown) d.classList.remove('is-open');
        });
        dropdown.classList.toggle('is-open');
      });
      
      options.forEach(option => {
        option.addEventListener('click', () => {
          // Update active state
          options.forEach(o => o.classList.remove('active'));
          option.classList.add('active');
          
          // Update filter
          if (option.dataset.size) {
            activeFilters.size = option.dataset.size;
            btn.firstChild.textContent = option.dataset.size === 'all' ? 'Size' : option.dataset.size;
          }
          if (option.dataset.availability) {
            activeFilters.availability = option.dataset.availability;
            btn.firstChild.textContent = option.dataset.availability === 'all' ? 'Availability' : 
              option.dataset.availability === 'in-stock' ? 'In stock' : 'Out of stock';
          }
          
          dropdown.classList.remove('is-open');
          applyFilters();
        });
      });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.filter-dropdown')) {
        filterDropdowns.forEach(d => d.classList.remove('is-open'));
      }
    });

    // Apply all filters
    async function applyFilters() {
      for (const product of products) {
        let visible = true;
        const collections = product.dataset.collections || '';
        const isAvailable = product.dataset.available === 'true';
        const productType = product.dataset.productType || '';
        
        // Collection filter
        if (activeFilters.collection !== 'all' && !collections.includes(activeFilters.collection)) {
          visible = false;
        }
        
        // Type filter (hoodie, t-shirt, etc.)
        if (activeFilters.type !== 'all') {
          if (!productType.includes(activeFilters.type)) {
            visible = false;
          }
        }
        
        // Availability filter
        if (activeFilters.availability === 'in-stock' && !isAvailable) {
          visible = false;
        }
        if (activeFilters.availability === 'out-of-stock' && isAvailable) {
          visible = false;
        }
        
        // Size filter (requires fetching product data)
        if (visible && activeFilters.size !== 'all') {
          const productHandle = product.dataset.productHandle;
          try {
            const response = await fetch(`/products/${productHandle}.js`);
            const productData = await response.json();
            
            // Handle both string and object formats
            const sizeOptionIndex = productData.options.findIndex(opt => {
              const optName = typeof opt === 'string' ? opt : (opt.name || opt.title || '');
              return optName.toLowerCase().includes('size') || optName.toLowerCase().includes('tamanho');
            });
            
            if (sizeOptionIndex !== -1) {
              const hasSize = productData.variants.some(v => 
                v.options[sizeOptionIndex] === activeFilters.size && v.available
              );
              if (!hasSize) visible = false;
            }
          } catch (e) {
            console.error('Error checking size:', e);
          }
        }
        
        product.style.display = visible ? '' : 'none';
        product.setAttribute('data-visible', visible ? 'true' : 'false');
      }
    }

    // Apply filters on page load if type param exists
    if (activeFilters.type !== 'all') {
      applyFilters();
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const filter = this.dataset.filter;
        activeFilters.collection = filter;
        
        // Clear type filter when switching collection tabs
        activeFilters.type = 'all';
        
        tabs.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-selected', 'true');

        applyFilters();
      });
    });

    // Quick Add functionality
    const quickAddBtns = section.querySelectorAll('.quick-add-btn');
    let currentOpenVariants = null;
    let currentOpenBtn = null;

    const closeAllVariants = () => {
      section.querySelectorAll('.quick-add-variants.is-open').forEach(el => {
        el.classList.remove('is-open');
      });
      if (currentOpenBtn) {
        currentOpenBtn.classList.remove('hidden');
      }
      currentOpenVariants = null;
      currentOpenBtn = null;
    };

    // Close variants when clicking outside
    document.addEventListener('click', (e) => {
      if (currentOpenVariants && !e.target.closest('.quick-add-variants') && !e.target.closest('.quick-add-btn')) {
        closeAllVariants();
      }
    });

    quickAddBtns.forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();

        const card = this.closest('.product-card-enhanced');
        const productHandle = this.dataset.productHandle;
        const variantsContainer = card.querySelector('.quick-add-variants');
        const variantsList = variantsContainer.querySelector('.quick-add-variants-list');

        // Close other open variants
        closeAllVariants();

        try {
          const response = await fetch(`/products/${productHandle}.js`);
          const product = await response.json();

          // Find size option (handle both string and object formats)
          const sizeOptionIndex = product.options.findIndex(opt => {
            const optName = typeof opt === 'string' ? opt : (opt.name || opt.title || '');
            return optName.toLowerCase().includes('size') || optName.toLowerCase().includes('tamanho');
          });

          if (sizeOptionIndex !== -1 && product.variants.length > 1) {
            // Get unique sizes only
            const seenSizes = new Set();
            const uniqueVariants = [];
            
            product.variants.forEach(variant => {
              const size = variant.options[sizeOptionIndex];
              if (!seenSizes.has(size)) {
                seenSizes.add(size);
                // Check if any variant with this size is available
                const availableForSize = product.variants.some(v => 
                  v.options[sizeOptionIndex] === size && v.available
                );
                uniqueVariants.push({ 
                  size, 
                  id: variant.id, 
                  available: availableForSize 
                });
              }
            });

            // Build variant buttons
            variantsList.innerHTML = uniqueVariants.map(v => `
              <button 
                type="button"
                class="quick-add-variant-btn" 
                data-variant-id="${v.id}"
                ${!v.available ? 'disabled' : ''}
              >${v.size}</button>
            `).join('');

            // Hide the + button and show variants
            this.classList.add('hidden');
            variantsContainer.classList.add('is-open');
            currentOpenVariants = variantsContainer;
            currentOpenBtn = this;

            // Add click handlers to variant buttons
            variantsList.querySelectorAll('.quick-add-variant-btn').forEach(variantBtn => {
              variantBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!this.disabled) {
                  const variantId = this.dataset.variantId;
                  addToCart(variantId);
                  closeAllVariants();
                }
              });
            });
          } else {
            // No size variants, add directly
            const availableVariant = product.variants.find(v => v.available) || product.variants[0];
            if (availableVariant) {
              addToCart(availableVariant.id);
            }
          }
        } catch (error) {
          console.error('Error fetching product:', error);
        }
      });
    });

    // Close button handlers
    section.querySelectorAll('.quick-add-close').forEach(closeBtn => {
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        closeAllVariants();
      });
    });

    // Add to cart function
    async function addToCart(variantId, quantity = 1) {
      const formData = new FormData();
      formData.append('id', variantId);
      formData.append('quantity', quantity);

      try {
        if (window.addToCartAndUpdate) {
          await window.addToCartAndUpdate(formData);
        } else {
          await fetch('/cart/add.js', {
            method: 'POST',
            body: formData
          });
          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();
          
          const cartCounts = document.querySelectorAll('.cart-count');
          cartCounts.forEach(el => {
            if (cart.item_count > 0) {
              el.textContent = cart.item_count;
              el.classList.add('cart-count--visible');
            }
          });
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
      }
    }
  });
</script>

{% schema %}
{
  "name": "New Arrivals Grid",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "New Arrivals"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_count",
      "label": "Products to show",
      "min": 4,
      "max": 24,
      "step": 2,
      "default": 12
    },
    {
      "type": "collection_list",
      "id": "featured_collections",
      "label": "Category tabs (collections)",
      "limit": 10
    }
  ],
  "presets": [
    {
      "name": "New Arrivals Grid"
    }
  ]
}
{% endschema %}
