<!-- Cart Container -->
<div class="cart-container">
  <!-- Cart Header -->
  <div class="cart-header">
  <h1 class="cart-title">{{ 'cart.title' | t | upcase }}</h1>
  </div>

  {% if cart.item_count > 0 %}
    <div class="cart-layout">
      <!-- Cart Items Grid -->
      <div class="cart-items-grid">
        {% for item in cart.items %}
        <div class="cart-item-card" data-key="{{ item.key }}" data-line="{{ forloop.index }}">
          <!-- Product Image -->
          <div class="item-image">
            {% if item.image %}
              <img
                src="{{ item.image | image_url: width: 200 }}"
                alt="{{ item.image.alt | escape }}"
                width="200"
                height="200"
                loading="lazy"
              >
            {% else %}
              <div class="no-image">No Image</div>
            {% endif %}
          </div>

          <!-- Product Info -->
          <div class="item-info">
            <h3 class="item-title">{{ item.product.title }}</h3>

            {% unless item.product.has_only_default_variant %}
              <div class="item-variant-price-wrapper">
                <div class="item-variant">
                  {% for option in item.product.options_with_values %}
                    {% liquid
                      assign opt_name_down = option.name | downcase
                      if opt_name_down contains 'size' or opt_name_down contains 'tamanho'
                        assign opt_label = 'products.options.size' | t
                        assign opt_class = 'size-badge'
                      elsif opt_name_down contains 'color' or opt_name_down contains 'cor'
                        assign opt_label = 'products.options.color' | t
                        assign opt_class = 'variant-option'
                      else
                        assign opt_label = option.name
                        assign opt_class = 'variant-option'
                      endif
                    %}
                    <span class="{{ opt_class }}">{{ opt_label }}: {{ item.variant.options[forloop.index0] }}</span>
                  {% endfor %}
                </div>
                
                <!-- Price inline with variant -->
                <span class="variant-price">
                  {% if item.original_price != item.price %}
                    <span class="original-price">{{ item.original_price | money }}</span>
                    <span class="discounted-price">{{ item.price | money }}</span>
                  {% else %}
                    <span class="unit-price">{{ item.price | money }}</span>
                  {% endif %}
                  <span class="price-label">{{ 'cart.each' | t }}</span>
                </span>
              </div>
            {% endunless %}

            {% if item.properties.size > 0 %}
              <div class="item-properties">
                {% for property in item.properties %}
                  <span class="property">{{ property.first }}: {{ property.last }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="item-actions">
            <div class="quantity-section">
              <label class="quantity-label">{{ 'cart.quantity' | t }}</label>
              <div class="quantity-controls">
                <button
                  type="button"
                  class="quantity-btn quantity-decrease"
                  data-key="{{ item.key }}"
                  {% if item.quantity <= 1 %}
                    disabled
                  {% endif %}
                >
                  âˆ’
                </button>
                <span class="qty-display" data-key="{{ item.key }}">{{ item.quantity }}</span>
                <button
                  type="button"
                  class="quantity-btn quantity-increase"
                  data-key="{{ item.key }}"
                  {% if item.variant.inventory_management == 'shopify'
                    and item.variant.inventory_policy == 'deny'
                    and item.variant.inventory_quantity != null
                    and item.variant.inventory_quantity <= item.quantity
                  %}
                    disabled
                  {% endif %}
                >
                  +
                </button>
              </div>
              {% if item.variant.inventory_management == 'shopify' and item.variant.inventory_quantity != null %}
                <span class="stock-info">
                  {{- 'cart.stock_available_html' | t: count: item.variant.inventory_quantity -}}
                </span>
              {% endif %}
            </div>

            <!-- Line Total -->
            <div class="line-total">
              <span class="total-label">{{ 'cart.total' | t }}</span>
              <span class="total-price" data-key="{{ item.key }}">{{ item.line_price | money }}</span>
            </div>

            <!-- Remove Button -->
            <button
              type="button"
              class="remove-item-btn"
              data-key="{{ item.key }}"
              data-title="{{ item.product.title }}"
            >
              <span class="remove-icon">Ã—</span>
              <span class="remove-text">{{ 'cart.remove' | t }}</span>
            </button>
          </div>
        </div>
      {% endfor %}
      </div>

      <!-- Cart Summary -->
      <div class="cart-summary">
        <div class="summary-content">
        <div class="subtotal-row">
          <span class="subtotal-label">{{ 'cart.subtotal' | t }}</span>
          <span class="subtotal-amount" id="cart-subtotal">{{ cart.total_price | money }}</span>
        </div>

        <div class="tax-info">
          {% if cart.taxes_included %}
            <p>{{ 'cart.taxes_included' | t }}</p>
          {% else %}
            <p>{{ 'cart.taxes_not_included' | t }}</p>
          {% endif %}
        </div>

        <!-- Action Buttons -->
        <div class="cart-actions">
          <button type="button" id="clear-cart-btn-main" class="btn btn--secondary btn--block">{{ 'cart.clear' | t }}</button>
          <a href="{{ routes.root_url }}" class="btn btn--primary btn--block">{{ 'cart.continue_shopping' | t }}</a>
          <a href="/checkout" class="btn btn--primary btn--block">{{ 'cart.checkout' | t }}</a>
        </div>
      </div>
    </div>
  </div>

  {% else %}
    <!-- Empty Cart -->
    <div class="empty-cart">
      <div class="empty-cart-content">
        <div class="empty-icon">ðŸ›’</div>
        <h2>{{ 'cart.empty_title' | t }}</h2>
        <p>{{ 'cart.empty_message' | t }}</p>
        <a href="{{ routes.root_url }}" class="btn btn--primary btn--block continue-shopping-btn">
          {{ 'cart.continue_shopping' | t }}
        </a>
      </div>
    </div>
  {% endif %}
</div>

<!-- Remove Item Modal -->
<div class="remove-item-modal" id="remove-item-modal">
  <div class="modal-content">
    <h3>{{ 'cart.remove_item_title' | t }}</h3>
    <p id="remove-item-message">{{ 'cart.remove_item_message_html' | t: title: '' }}</p>
    <div class="modal-actions">
      <button type="button" id="remove-cancel" class="btn btn--primary btn--block">{{ 'general.cancel' | t }}</button>
      <button type="button" id="remove-confirm" class="btn btn--primary btn--block">
        {{ 'cart.remove_item_confirm' | t }}
      </button>
    </div>
  </div>
</div>

<!-- Clear Cart Modal -->
<div class="clear-cart-modal" id="clear-cart-modal">
  <div class="modal-content">
    <h3>{{ 'cart.clear_confirm_title' | t }}</h3>
    <p>{{ 'cart.clear_confirm_message' | t }}</p>
    <div class="modal-actions">
      <button type="button" id="clear-cancel" class="btn btn--primary btn--block">{{ 'general.cancel' | t }}</button>
      <button type="button" id="clear-confirm" class="btn btn--primary btn--block">{{ 'cart.clear' | t }}</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-overlay"></div>

{% stylesheet %}
  /* Cart Container */
  .cart-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 60px 20px;
  }

  .cart-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 60px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--color-border);
  }

  .cart-title {
    font-family: var(--font-heading-family);
    font-size: 42px;
    text-transform: none;
    letter-spacing: -0.02em;
    margin: 0;
    font-weight: 400;
    color: var(--color-foreground);
  }

  .cart-count {
    font-family: var(--font-primary-family);
    font-size: 16px;
    color: var(--color-foreground-muted);
  }

  /* Cart Layout (Desktop) */
  .cart-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 60px;
    align-items: start;
  }

  /* Cart Items Grid */
  .cart-items-grid {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-bottom: 0;
  }

  .cart-item-card {
    display: grid;
    grid-template-columns: 120px 1fr auto;
    gap: 40px;
    padding: 40px 0;
    border-bottom: 1px solid var(--color-border);
    align-items: start;
    background: transparent;
    border-radius: 0;
  }
  
  .cart-item-card:first-child {
    padding-top: 0;
  }

  .item-image img {
    transition: transform 0.5s ease;
  }

  .cart-item-card:hover .item-image img {
    transform: scale(1.05);
  }

  .no-image {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-surface);
    color: var(--color-foreground-muted);
    font-size: 12px;
  }

  /* Product Info */
  .item-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .item-title {
    font-family: var(--font-heading-family);
    font-size: 20px;
    font-weight: 500;
    margin: 0;
    color: var(--color-foreground);
    text-decoration: none;
    letter-spacing: 0;
    text-transform: none;
  }

  .item-variant {
    font-size: 14px;
    color: var(--color-foreground-muted);
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .item-variant span {
    display: inline-block;
  }

  .variant-price {
    margin-top: 4px;
    font-size: 16px;
    color: var(--color-foreground);
  }

  .price-label {
    font-size: 12px;
    color: var(--color-foreground-muted);
    margin-left: 4px;
  }

  /* Actions Column (Qty, Total, Remove) */
  .item-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 24px;
  }

  .line-total {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }

  .total-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-foreground-muted);
    margin-bottom: 4px;
  }

  .total-price {
    font-family: var(--font-heading-family);
    font-size: 18px;
    font-weight: 500;
    color: var(--color-foreground);
  }

  /* Quantity Control - Minimal */
  .quantity-section {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 6px;
  }

  .quantity-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-foreground-muted);
  }

  .quantity-controls {
    display: flex;
    align-items: center;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
    padding: 2px;
    background: var(--color-background);
  }

  .quantity-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    color: var(--color-foreground);
    cursor: pointer;
    transition: color 0.2s;
    font-size: 16px;
    padding: 0;
  }
  
  .quantity-btn:hover:not(:disabled) {
    color: var(--color-primary);
    background: transparent;
  }

  .quantity-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .qty-display {
    width: 32px;
    text-align: center;
    font-size: 14px;
    font-weight: 500;
    border: none;
    background: transparent;
  }

  .stock-info {
    font-size: 11px;
    color: var(--color-warning);
  }

  /* Remove Button */
  .remove-item-btn {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-foreground-muted);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: color 0.2s;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .remove-item-btn:hover {
    color: var(--color-error);
    background: transparent;
  }

  .remove-icon {
    font-size: 14px;
  }

  /* Cart Summary */
  .cart-summary {
    background: var(--color-surface);
    border-radius: var(--radius-base);
    padding: 40px;
    width: 100%;
    max-width: 100%;
    border: 1px solid transparent;
    position: sticky;
    top: 40px;
  }

  .subtotal-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }

  .subtotal-label {
    font-family: var(--font-heading-family);
    font-size: 18px;
    color: var(--color-foreground);
  }

  .subtotal-amount {
    font-family: var(--font-heading-family);
    font-size: 24px;
    font-weight: 500;
    color: var(--color-foreground);
  }

  .tax-info {
    font-size: 13px;
    color: var(--color-foreground-muted);
    margin-bottom: 30px;
    text-align: right;
  }

  .cart-actions {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  /* Empty Cart */
  .empty-cart {
    text-align: center;
    padding: 100px 20px;
  }

  .empty-cart-content {
    max-width: 400px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
  }

  .empty-icon {
    font-size: 48px;
    margin-bottom: 10px;
    opacity: 0.5;
  }

  /* Modals */
  .remove-item-modal,
  .clear-cart-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.98);
    /* enforce black/white palette for modals */
    --modal-bg: var(--color-surface);
    --modal-fg: var(--color-foreground);
    background: var(--modal-bg);
    color: var(--modal-fg);
    font-family: var(--font-heading-family);
    border: 1px solid var(--color-border);
    padding: 40px;
    z-index: 1001;
    width: 400px;
    max-width: 92vw;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s ease, visibility 0.25s ease, transform 0.25s ease;
    border-radius: var(--radius-base);
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  }

  .remove-item-modal.open,
  .clear-cart-modal.open {
    z-index: 1000000;
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
  }

  .modal-content h3 {
    color: var(--modal-fg);
    margin: 0 0 16px 0;
    font-size: 24px;
    text-align: center;
    font-weight: 400;
  }

  .modal-content p {
    color: var(--modal-fg);
    margin: 0 0 24px 0;
    text-align: center;
    font-size: 16px;
    line-height: 1.6;
    opacity: 0.8;
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .modal-actions .btn {
    flex: 1;
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.open {
    opacity: 1;
    visibility: visible;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .cart-layout {
      display: block;
    }

    .cart-summary {
      margin-top: 40px;
      position: static;
    }

    .cart-item-card {
      gap: 30px;
    }
  }

  @media (max-width: 768px) {
    .cart-item-card {
      grid-template-columns: 125px 1fr;
      gap: 20px;
      padding: 30px 0;
    }
    
    .item-actions {
      grid-column: 1 / -1;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      padding-top: 20px;
      border-top: 1px dashed var(--color-border);
      width: 100%;
    }

    .quantity-section {
      align-items: flex-start;
    }

    .line-total {
      align-items: flex-end;
    }
  }
{% endstylesheet %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Elements
    const clearCartBtn = document.getElementById('clear-cart-btn-main') || document.getElementById('clear-cart-btn');
    const clearCartModal = document.getElementById('clear-cart-modal');
    const removeItemModal = document.getElementById('remove-item-modal');
    const modalOverlay = document.getElementById('modal-overlay');

    // Clear cart modal buttons
    const clearCancel = document.getElementById('clear-cancel');
    const clearConfirm = document.getElementById('clear-confirm');

    // Remove item modal buttons
    const removeCancel = document.getElementById('remove-cancel');
    const removeConfirm = document.getElementById('remove-confirm');
    const removeMessage = document.getElementById('remove-item-message');

    // Quantity controls
    const qtyIncreaseButtons = document.querySelectorAll('.quantity-increase');
    const qtyDecreaseButtons = document.querySelectorAll('.quantity-decrease');
    const removeItemButtons = document.querySelectorAll('.remove-item-btn');

    let currentItemKey = null;
    let currentItemTitle = null;

    // Track ongoing cart updates to prevent spamming
    const ongoingUpdates = new Map();

    // Clear Cart Modal Functions
    if (clearCartBtn) {
      clearCartBtn.addEventListener('click', function () {
        openModal(clearCartModal);
      });
    }

    if (clearCancel) {
      clearCancel.addEventListener('click', function () {
        closeModal(clearCartModal);
      });
    }

    if (clearConfirm) {
      clearConfirm.addEventListener('click', function () {
        clearCart();
      });
    }

    // Remove Item Modal Functions
    removeItemButtons.forEach((btn) => {
      btn.addEventListener('click', function () {
        currentItemKey = this.dataset.key;
        currentItemTitle = this.dataset.title;
        const tpl =
          window.themeStrings?.cart_remove_item_message ||
          'Are you sure you want to remove "___TITLE___" from your cart?';
        removeMessage.textContent = tpl.replace('___TITLE___', currentItemTitle);
        openModal(removeItemModal);
      });
    });

    if (removeCancel) {
      removeCancel.addEventListener('click', function () {
        closeModal(removeItemModal);
        currentItemKey = null;
        currentItemTitle = null;
      });
    }

    if (removeConfirm) {
      removeConfirm.addEventListener('click', function () {
        if (currentItemKey) {
          removeCartItem(currentItemKey);
        }
      });
    }

    // Quantity Control Functions
    qtyIncreaseButtons.forEach((btn) => {
      btn.addEventListener('click', function () {
        const key = this.dataset.key;
        const qtyDisplay = document.querySelector(`.qty-display[data-key="${key}"]`);
        const currentQty = parseInt(qtyDisplay.textContent);
        const newQty = currentQty + 1;

        // Check if we can increase (verify stock availability)
        if (canIncreaseQuantity(key, newQty) && !this.disabled) {
          updateCartItem(key, newQty);
        }
      });
    });

    qtyDecreaseButtons.forEach((btn) => {
      btn.addEventListener('click', function () {
        const key = this.dataset.key;
        const qtyDisplay = document.querySelector(`.qty-display[data-key="${key}"]`);
        const currentQty = parseInt(qtyDisplay.textContent);
        const newQty = currentQty - 1;

        if (this.disabled) return;

        if (newQty <= 0) {
          // If quantity would be 0 or less, trigger the remove item modal
          const productTitle = btn.closest('.cart-item-card').querySelector('.item-title').textContent;
          currentItemKey = key;
          currentItemTitle = productTitle;
          const removeMessage = document.getElementById('remove-item-message');
          const tpl =
            window.themeStrings?.cart_remove_item_message ||
            'Are you sure you want to remove "___TITLE___" from your cart?';
          removeMessage.textContent = tpl.replace('___TITLE___', productTitle);
          openModal(removeItemModal);
        } else {
          updateCartItem(key, newQty);
        }
      });
    });

    // Helper function to check if quantity can be increased
    function canIncreaseQuantity(key, newQuantity) {
      const stockInfo = document.querySelector(`.cart-item-card[data-key="${key}"] .stock-info`);

      if (stockInfo) {
        // Extract available stock from text "X available"
        const stockText = stockInfo.textContent;
        const availableStock = parseInt(stockText.match(/(\d+)/)?.[1]);

        if (availableStock && newQuantity > availableStock) {
          const msgTpl = window.themeStrings?.only_x_available || 'Only ___COUNT___ items available in stock.';
          showError(msgTpl.replace('___COUNT___', availableStock));
          return false;
        }
      }

      return true;
    }

    // Modal Utility Functions
    function openModal(modal) {
      modal.classList.add('open');
      modalOverlay.classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeModal(modal) {
      modal.classList.remove('open');
      modalOverlay.classList.remove('open');
      document.body.style.overflow = '';
    }

    // Close modal when clicking overlay
    if (modalOverlay) {
      modalOverlay.addEventListener('click', function () {
        closeModal(clearCartModal);
        closeModal(removeItemModal);
        currentItemKey = null;
        currentItemTitle = null;
      });
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        if (clearCartModal.classList.contains('open')) {
          closeModal(clearCartModal);
        }
        if (removeItemModal.classList.contains('open')) {
          closeModal(removeItemModal);
          currentItemKey = null;
          currentItemTitle = null;
        }
      }
    });

    // Cart API Functions
    function updateCartItem(key, quantity) {
      // Prevent multiple simultaneous updates for the same item
      if (ongoingUpdates.has(key)) {
        return;
      }

      // Mark this item as being updated
      ongoingUpdates.set(key, true);

      // Disable buttons to prevent spamming
      const qtyIncreaseBtn = document.querySelector(`.quantity-increase[data-key="${key}"]`);
      const qtyDecreaseBtn = document.querySelector(`.quantity-decrease[data-key="${key}"]`);
      
      if (qtyIncreaseBtn) qtyIncreaseBtn.disabled = true;
      if (qtyDecreaseBtn) qtyDecreaseBtn.disabled = true;

      // Update the display immediately with the new quantity (optimistic update)
      const qtyDisplay = document.querySelector(`.qty-display[data-key="${key}"]`);
      const totalPrice = document.querySelector(`.total-price[data-key="${key}"]`);

      // Store original quantity for error reversion
      const originalQuantity = qtyDisplay ? parseInt(qtyDisplay.textContent) : quantity;

      // Update quantity display immediately (optimistic)
      if (qtyDisplay) {
        qtyDisplay.textContent = quantity;
      }

      // Calculate and update price immediately (optimistic)
      if (totalPrice) {
        const cartItemCard = document.querySelector(`.cart-item-card[data-key="${key}"]`);
        const unitPriceElement = cartItemCard.querySelector('.unit-price') || cartItemCard.querySelector('.discounted-price');
        
        if (unitPriceElement) {
          const unitPriceText = unitPriceElement.textContent;
          const match = unitPriceText.match(/([\d.,]+)/);
          const eurosNumber = match ? parseFloat(match[1].replace(/\./g, '').replace(',', '.')) : 0;
          if (!isNaN(eurosNumber)) {
            const newLineCents = Math.round(eurosNumber * 100) * quantity;
            totalPrice.textContent = formatMoneyEuro(newLineCents);

            // Update cart subtotal optimistically
            updateSubtotalOptimistically();
          }
        }
      }

      // Update button states immediately (but keep them disabled during update)
      if (qtyDecreaseBtn) {
        qtyDecreaseBtn.disabled = true; // Keep disabled during update
      }

      if (qtyIncreaseBtn) {
        qtyIncreaseBtn.disabled = true; // Keep disabled during update
      }

      const formData = new FormData();
      formData.append('updates[' + key + ']', quantity);

      fetch('/cart/update.js', {
        method: 'POST',
        body: formData,
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((cart) => {
          // Remove from ongoing updates
          ongoingUpdates.delete(key);

          updateCartDisplay(cart);

          // Re-enable buttons after successful update
          if (qtyIncreaseBtn) qtyIncreaseBtn.disabled = false;
          if (qtyDecreaseBtn) qtyDecreaseBtn.disabled = false;

          // Broadcast cart update event for sidebar cart
          window.dispatchEvent(
            new CustomEvent('cartUpdated', {
              detail: { cart: cart, source: 'main' },
            })
          );
        })
        .catch((error) => {
          console.error('âŒ Error updating cart:', error);
          
          // Remove from ongoing updates
          ongoingUpdates.delete(key);
          
          // Re-enable buttons after error
          if (qtyIncreaseBtn) qtyIncreaseBtn.disabled = false;
          if (qtyDecreaseBtn) qtyDecreaseBtn.disabled = false;
          
          // If there's an error, revert quantity display
          if (qtyDisplay) {
            qtyDisplay.textContent = originalQuantity;
          }
          showError(window.themeStrings?.cart_update_failed || 'Failed to update item quantity. Please try again.');
        });
    }

    // Helper function to update subtotal optimistically
    function updateSubtotalOptimistically() {
      const cartSubtotal = document.getElementById('cart-subtotal');
      if (cartSubtotal) {
        let totalCents = 0;

        // Sum up all line prices
        document.querySelectorAll('.total-price').forEach((priceEl) => {
          const priceText = priceEl.textContent;
          const match = priceText.match(/([\d.,]+)/);
          const eurosNumber = match ? parseFloat(match[1].replace(/\./g, '').replace(',', '.')) : 0;
          if (!isNaN(eurosNumber)) {
            totalCents += Math.round(eurosNumber * 100);
          }
        });

        cartSubtotal.textContent = formatMoneyEuro(totalCents);
      }
    }

    function removeCartItem(key) {
      // First, hide the card with animation
      const cardToRemove = document.querySelector(`.cart-item-card[data-key="${key}"]`);
      if (cardToRemove) {
        cardToRemove.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        cardToRemove.style.opacity = '0';
        cardToRemove.style.transform = 'translateX(-20px)';
      }

      // Then update the cart
      updateCartItem(key, 0);
      closeModal(removeItemModal);
      currentItemKey = null;
      currentItemTitle = null;

      // Remove the card after animation
      setTimeout(() => {
        if (cardToRemove && cardToRemove.parentNode) {
          cardToRemove.remove();
        }
      }, 300);
    }

    function clearCart() {
      fetch('/cart/clear.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      })
        .then((response) => {
          if (response.ok) {
            window.location.reload();
          } else {
            throw new Error('Failed to clear cart');
          }
        })
        .then(() => {
          // Broadcast cart clear event for sidebar cart
          window.dispatchEvent(
            new CustomEvent('cartCleared', {
              detail: { source: 'main' },
            })
          );
        })
        .catch((error) => {
          console.error('Error clearing cart:', error);
          closeModal(clearCartModal);
          showError(window.themeStrings?.cart_clear_failed || 'Failed to clear cart. Please try again.');
        });
    }

    function updateCartDisplay(cart) {
      // Update each item's quantity and line price from API response (confirmation)
      cart.items.forEach((item) => {
        const qtyDisplay = document.querySelector(`.qty-display[data-key="${item.key}"]`);
        const totalPrice = document.querySelector(`.total-price[data-key="${item.key}"]`);
        const qtyIncreaseBtn = document.querySelector(`.quantity-increase[data-key="${item.key}"]`);
        const qtyDecreaseBtn = document.querySelector(`.quantity-decrease[data-key="${item.key}"]`);

        // Confirm the quantity and price from API
        if (qtyDisplay) {
          qtyDisplay.textContent = item.quantity;
        }

        if (totalPrice) {
          totalPrice.textContent = formatMoneyEuro(item.line_price);
        }

        // Final button state confirmation
        if (qtyDecreaseBtn) {
          qtyDecreaseBtn.disabled = item.quantity <= 1;
        }

        if (qtyIncreaseBtn) {
          const hasInventoryLimit =
            item.variant &&
            item.variant.inventory_management === 'shopify' &&
            item.variant.inventory_policy === 'deny' &&
            item.variant.inventory_quantity !== null;

          if (hasInventoryLimit) {
            qtyIncreaseBtn.disabled = item.quantity >= item.variant.inventory_quantity;
          } else {
            qtyIncreaseBtn.disabled = false;
          }
        }
      });

      // Update cart summary with final values
      const cartSubtotal = document.getElementById('cart-subtotal');
      const cartCount = document.querySelector('.cart-count');

      if (cartSubtotal) cartSubtotal.textContent = formatMoneyEuro(cart.total_price);
      if (cartCount) {
        if (cart.item_count > 0) {
          cartCount.textContent = cart.item_count;
          cartCount.classList.add('cart-count--visible');
        } else {
          cartCount.textContent = '';
          cartCount.classList.remove('cart-count--visible');
        }
      }

      // If cart is empty, reload page to show empty state
      if (cart.item_count === 0) {
        setTimeout(() => {
          window.location.reload();
        }, 500);
      }
    }

    function formatMoney(cents) {
      const dollars = (cents / 100).toFixed(2);
      return `$${dollars}`;
    }

    function formatMoneyEuro(cents) {
      const amount = Math.abs(cents || 0);
      const euros = Math.floor(amount / 100);
      const centsPart = amount % 100;
      const centsStr = String(centsPart).padStart(2, '0');
      const eurosStr = String(euros).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      return `${eurosStr},${centsStr} â‚¬`;
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'notification-toast notification-toast-error';
      errorDiv.textContent = message;

      document.body.appendChild(errorDiv);

      setTimeout(() => {
        errorDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          document.body.removeChild(errorDiv);
        }, 300);
      }, 3000);
    }


    // Listen for cart updates from sidebar
    window.addEventListener('cartUpdated', function (event) {
      if (event.detail.source !== 'main') {
        const cart = event.detail.cart;

        // Update each item's quantity and line price from API response
        cart.items.forEach((item) => {
          const qtyDisplay = document.querySelector(`.qty-display[data-key="${item.key}"]`);
          const totalPrice = document.querySelector(`.total-price[data-key="${item.key}"]`);
          const qtyIncreaseBtn = document.querySelector(`.quantity-increase[data-key="${item.key}"]`);
          const qtyDecreaseBtn = document.querySelector(`.quantity-decrease[data-key="${item.key}"]`);

          // Update quantity and price from sidebar changes
          if (qtyDisplay) {
            qtyDisplay.textContent = item.quantity;
          }

          if (totalPrice) {
            totalPrice.textContent = formatMoneyEuro(item.line_price);
          }

          // Update button states
          if (qtyDecreaseBtn) {
            qtyDecreaseBtn.disabled = item.quantity <= 1;
          }

          if (qtyIncreaseBtn) {
            const hasInventoryLimit =
              item.variant &&
              item.variant.inventory_management === 'shopify' &&
              item.variant.inventory_policy === 'deny' &&
              item.variant.inventory_quantity !== null;

            if (hasInventoryLimit) {
              qtyIncreaseBtn.disabled = item.quantity >= item.variant.inventory_quantity;
            } else {
              qtyIncreaseBtn.disabled = false;
            }
          }
        });

        // Update cart summary
        const cartSubtotal = document.getElementById('cart-subtotal');
        const cartCount = document.querySelector('.cart-count');

        if (cartSubtotal) cartSubtotal.textContent = formatMoneyEuro(cart.total_price);
        if (cartCount) {
          if (cart.item_count > 0) {
            cartCount.textContent = cart.item_count;
            cartCount.classList.add('cart-count--visible');
          } else {
            cartCount.textContent = '';
            cartCount.classList.remove('cart-count--visible');
          }
        }

        // Remove items that are no longer in cart
        const currentCards = document.querySelectorAll('.cart-item-card');
        const cartItemKeys = cart.items.map((item) => item.key);

        currentCards.forEach((card) => {
          const cardKey = card.dataset.key;
          if (!cartItemKeys.includes(cardKey)) {
            card.remove();
          }
        });

        // If cart is empty, reload page to show empty state
        if (cart.item_count === 0) {
          setTimeout(() => {
            window.location.reload();
          }, 500);
        }
      }
    });

    // Listen for cart clear events from sidebar
    window.addEventListener('cartCleared', function (event) {
      if (event.detail.source !== 'main') {
        setTimeout(() => {
          window.location.reload();
        }, 500);
      }
    });
  });
</script>

{% schema %}
{
  "name": "t:general.cart",
  "settings": []
}
{% endschema %}
