{% comment %}
  Product Grid Section - 3 items per row
{% endcomment %}

<div class="product-grid-section">
  <div class="product-grid-header">
    <div class="header-left">
      <button type="button" class="filter-toggle-btn" id="main-filter-toggle">
        <span class="filter-icon">
          <svg width="18" height="12" viewBox="0 0 18 12" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 6H15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M0.75 1H17.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5.25 11H12.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        Filter
        <span class="chevron-icon">
          <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </button>
    </div>

    <div class="product-grid-title">
      <h2 class="shop-name">{{ shop.name }}</h2>
      <p class="product-count">{{ collections.all.products_count }} products</p>
    </div>

    <div class="header-right">
      <div class="custom-sort-dropdown">
        <button type="button" class="sort-trigger" id="sort-trigger">
          <span class="current-sort-label">Date, new to old</span>
          <span class="chevron-icon">
            <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </button>
        <div class="sort-options-list" id="sort-options-list">
          <div class="sort-option" data-value="created-descending">Date, new to old</div>
          <div class="sort-option" data-value="created-ascending">Date, old to new</div>
          <div class="sort-option" data-value="price-ascending">Price, low to high</div>
          <div class="sort-option" data-value="price-descending">Price, high to low</div>
          <div class="sort-option" data-value="title-ascending">Alphabetically, A-Z</div>
          <div class="sort-option" data-value="title-descending">Alphabetically, Z-A</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="collection-content-wrapper">
    <aside class="collection-sidebar" id="collection-sidebar">
      <div class="sidebar-filter-group">
        <button class="sidebar-accordion-btn" aria-expanded="true">
          Availability
          <span class="accordion-icon">
            <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 5L5 1L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </button>
        <div class="sidebar-accordion-content">
          <label class="checkbox-container">
            <input type="checkbox" value="all" data-filter-type="availability" checked>
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">All</span>
          </label>
          <label class="checkbox-container">
            <input type="checkbox" value="available" data-filter-type="availability">
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">Available</span>
          </label>
          <label class="checkbox-container">
            <input type="checkbox" value="sold_out" data-filter-type="availability">
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">Sold Out</span>
          </label>
        </div>
      </div>

      <div class="sidebar-filter-group">
        <button class="sidebar-accordion-btn" aria-expanded="true">
          Product Type
          <span class="accordion-icon">
            <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 5L5 1L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </button>
        <div class="sidebar-accordion-content">
          <label class="checkbox-container">
            <input type="checkbox" value="all" data-filter-type="type" checked>
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">All</span>
          </label>
          <label class="checkbox-container">
            <input type="checkbox" value="t-shirt" data-filter-type="type">
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">T-Shirts</span>
          </label>
          <label class="checkbox-container">
            <input type="checkbox" value="hoodie" data-filter-type="type">
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">Hoodies</span>
          </label>
          <label class="checkbox-container">
            <input type="checkbox" value="accessories" data-filter-type="type">
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">Accessories</span>
          </label>
          <label class="checkbox-container">
            <input type="checkbox" value="gift cards" data-filter-type="type">
            <span class="checkbox-custom"></span>
            <span class="checkbox-label">Gift Cards</span>
          </label>
        </div>
      </div>
    </aside>

    <div class="product-grid">
      {% for product in collections.all.products %}
        <div class="product-card" 
             data-title="{{ product.title | downcase }}" 
             data-price="{{ product.price | times: 1 }}" 
             data-created="{{ product.created_at | date: '%s' }}" 
             data-availability="{% if product.available %}available{% else %}sold_out{% endif %}" 
             data-product-type="{{ product.metafields.custom.type | downcase }}"
             data-product-id="{{ product.id }}"
             data-product-handle="{{ product.handle }}">
          <div class="product-image-container">
            <a href="{{ product.url }}" class="product-link">
              <div class="product-image">
                {% if product.featured_media %}
                  <img
                    src="{{ product.featured_media | image_url: width: 600 }}"
                    alt="{{ product.featured_media.alt | escape | default: product.title }}"
                    class="product-image-main"
                    width="600"
                    height="600"
                    loading="lazy"
                  >
                  {% if product.media[1] %}
                    <img 
                      src="{{ product.media[1] | image_url: width: 600 }}" 
                      alt="{{ product.media[1].alt | escape | default: product.title }}"
                      class="product-image-hover"
                      loading="lazy"
                      width="600"
                      height="600"
                    >
                  {% endif %}
                {% else %}
                  <div class="product-image-placeholder">No Image</div>
                {% endif %}
              </div>
            </a>
            
            <!-- Quick Add Button -->
            {% if product.available %}
              <button type="button" 
                      class="quick-add-btn" 
                      data-product-id="{{ product.id }}"
                      data-product-handle="{{ product.handle }}"
                      aria-label="Quick add {{ product.title }}">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
                  <path d="M7 0V14M0 7H14" stroke="currentColor" stroke-width="1.5"/>
                </svg>
              </button>
            {% endif %}
            
            <!-- Quick Add Variant Selector -->
            <div class="quick-add-variants" data-product-handle="{{ product.handle }}">
              <button class="quick-add-close" aria-label="Close">&times;</button>
              <div class="quick-add-variants-list">
                <!-- Populated via JS -->
              </div>
            </div>
          </div>

          <div class="product-info">
            <div class="product-info-separator"></div>
            <div class="product-info-row">
              <a href="{{ product.url }}" class="product-title-link">
                <h3 class="product-title">{{ product.title }}</h3>
              </a>
              <span class="product-price">
                {% if product.available %}
                  {% render 'price', amount: product.price, product: product %}
                {% else %}
                  <span class="sold-out-text">{{ 'products.product.sold_out' | t }}</span>
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

{% stylesheet %}
  .product-grid-section {
    padding: 60px 40px;
    color: var(--color-foreground);
    background-color: var(--color-background);
  }

  .product-grid-title {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin: 0 0 40px;
    font-size: 28px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .product-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 30px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .product-card {
    background-color: transparent;
    width: calc(33.333% - 20px);
    min-width: 280px;
    position: relative;
  }

  .product-image-container {
    position: relative;
  }

  .product-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .product-image {
    position: relative;
    width: 100%;
    aspect-ratio: 3/4;
    background-color: var(--color-surface, #f5f5f5);
    overflow: hidden;
  }

  .product-image-main,
  .product-image-hover {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: center;
    transition: opacity 0.4s ease;
  }

  .product-image-hover {
    opacity: 0;
  }

  .product-link:hover .product-image:has(.product-image-hover) .product-image-main {
    opacity: 0;
  }

  .product-link:hover .product-image-hover {
    opacity: 1;
  }

  .product-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-surface);
    color: var(--color-border);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Quick Add Button */
  .quick-add-btn {
    position: absolute;
    bottom: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
    background: transparent;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.25s ease, transform 0.25s ease, color 0.2s ease;
    z-index: 5;
    color: var(--color-foreground);
  }

  .product-card:hover .quick-add-btn {
    opacity: 1;
    transform: translateY(0);
  }
  
  .quick-add-btn.hidden {
    opacity: 0 !important;
    pointer-events: none;
  }

  .quick-add-btn:hover {
    color: var(--color-primary);
  }

  .quick-add-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Quick Add Variants */
  .quick-add-variants {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(255, 255, 255, 0.97);
    backdrop-filter: blur(4px);
    padding: 16px 10px 14px 10px;
    z-index: 10;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.25s ease;
  }

  .quick-add-variants.is-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .quick-add-close {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    font-size: 18px;
    font-weight: 300;
    cursor: pointer;
    color: var(--color-foreground);
    opacity: 0.4;
    transition: opacity 0.2s ease;
    line-height: 1;
    padding: 4px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .quick-add-close:hover {
    opacity: 1;
  }

  .quick-add-variants-list {
    display: flex;
    gap: 0;
    flex-wrap: nowrap;
    justify-content: center;
    align-items: center;
  }

  .quick-add-variant-btn {
    min-width: 40px;
    height: 36px;
    padding: 0 12px;
    border: none;
    background-color: transparent;
    font-family: var(--font-primary-family);
    font-size: 14px;
    font-weight: 400;
    cursor: pointer;
    transition: opacity 0.15s ease;
    color: var(--color-foreground);
  }

  .quick-add-variant-btn:hover:not(:disabled) {
    opacity: 0.6;
  }

  .quick-add-variant-btn:disabled {
    opacity: 0.25;
    cursor: not-allowed;
    text-decoration: line-through;
  }

  /* Product Info */
  .product-info {
    padding: 0;
  }

  .product-info-separator {
    height: 1px;
    background-color: var(--color-border);
    margin: 12px 0 10px 0;
  }

  .product-info-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 10px;
  }

  .product-title-link {
    text-decoration: none;
    color: inherit;
    flex: 1;
    min-width: 0;
  }

  .product-title {
    font-family: var(--font-primary-family);
    font-size: 12px;
    font-weight: 400;
    margin: 0;
    color: var(--color-foreground);
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    text-transform: uppercase;
  }

  .product-price {
    font-size: 12px;
    font-weight: 400;
    color: var(--color-foreground);
    white-space: nowrap;
    flex-shrink: 0;
    margin: 0;
  }

  .sold-out-text {
    color: var(--color-foreground);
    opacity: 0.4;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 0.5px;
  }

  .product-card--promo {
    width: calc(33.333% - 20px);
  }

  .product-image--promo img {
    object-fit: cover;
    transform: scale(1);
  }

  .product-card--banner {
    width: 100%;
  }

  .product-image--banner {
    aspect-ratio: 16/6;
    background-color: transparent;
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .product-grid-section {
      padding: 40px 20px;
    }

    .product-grid {
      gap: 20px;
    }
    
    .product-card {
      width: calc(50% - 10px);
      min-width: 0;
    }
    
    .product-card--promo {
      width: calc(50% - 10px);
    }
    
    .product-card--banner .product-image--banner {
      aspect-ratio: 16/8;
    }
  }

  @media (max-width: 768px) {
    .product-grid {
      gap: 15px;
    }
    
    .product-card {
      width: calc(50% - 8px);
    }
    
    .product-card--promo {
      width: calc(50% - 8px);
    }
    
    .product-grid-section {
      padding: 30px 15px;
    }
    
    .quick-add-btn {
      opacity: 1;
      transform: translateY(0);
    }
    
    .product-title {
      font-size: 11px;
    }
    
    .product-price {
      font-size: 11px;
    }
  }

  @media (max-width: 480px) {
    .product-grid {
      gap: 12px;
    }
    
    .product-card {
      width: calc(50% - 6px);
    }
    
    .product-card--promo {
      width: calc(50% - 6px);
    }
  }

  .product-grid-header{
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 40px;
    position: relative;
  }

  /* Collection Header */
  .collection-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 40px;
    position: relative;
    flex-direction: column;
  }

  .header-left, .header-right {
    flex: 1;
    display: flex;
  }

  .header-right {
    justify-content: flex-end;
  }

  .product-grid-title {
    flex: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    text-align: center;
  }

  .shop-name {
    font-size: 24px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
  }

  .product-count {
    font-size: 14px;
    color: var(--color-foreground);
    opacity: 0.7;
    margin: 0;
  }

  /* Filter Toggle Button */
  .filter-toggle-btn {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-family: var(--font-primary-family);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--color-foreground);
    transition: opacity 0.2s ease;
  }

  .filter-toggle-btn:hover {
    opacity: 0.7;
  }

  .filter-toggle-btn .chevron-icon svg {
    transition: transform 0.3s ease;
  }

  .filter-toggle-btn.is-active .chevron-icon svg {
    transform: rotate(180deg);
  }

  .filter-icon, .chevron-icon {
    display: flex;
    align-items: center;
  }

  /* Sort Dropdown */
  .custom-sort-dropdown {
    position: relative;
    min-width: 135px;
  }

  .sort-trigger {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    font-family: var(--font-primary-family);
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 8px;
    color: var(--color-foreground);
    width: 100%;
  }

  .sort-trigger .chevron-icon svg {
    transition: transform 0.3s ease;
  }

  .sort-trigger.is-active .chevron-icon svg {
    transform: rotate(180deg);
  }

  .sort-options-list {
    position: absolute;
    top: 100%;
    left: 50%;
    margin-top: 10px;
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    padding: 8px 0;
    min-width: 200px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    opacity: 0;
    visibility: hidden;
    transform: translateX(-50%) translateY(-10px);
    transition: all 0.2s ease;
    z-index: 100;
  }

  .sort-options-list.is-visible {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  .sort-option {
    padding: 8px 16px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s ease;
  }

  .sort-option:hover {
    background-color: rgba(0,0,0,0.05);
  }

  .sort-option.selected {
    font-weight: 600;
    background-color: rgba(0,0,0,0.03);
  }

  /* Main Content Layout */
  .collection-content-wrapper {
    display: flex;
    align-items: flex-start;
    gap: 0;
    transition: gap 0.3s ease;
  }

  /* Sidebar */
  .collection-sidebar {
    width: 0;
    opacity: 0;
    visibility: hidden;
    overflow: hidden;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .collection-sidebar.is-visible {
    width: 250px;
    opacity: 1;
    visibility: visible;
    margin-right: 40px;
  }

  .sidebar-filter-group {
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 15px;
  }

  .sidebar-accordion-btn {
    width: 100%;
    background: none;
    border: none;
    padding: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-family: var(--font-primary-family);
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--color-foreground);
  }

  .sidebar-accordion-btn .accordion-icon svg {
    transition: transform 0.3s ease;
  }

  /* When collapsed (aria-expanded="false"), rotate 180deg to point down */
  .sidebar-accordion-btn[aria-expanded="false"] .accordion-icon svg {
    transform: rotate(180deg);
  }

  .sidebar-accordion-content {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-top: 10px;
    max-height: 500px; /* Arbitrary large height for transition */
    transition: max-height 0.3s ease;
    overflow: hidden;
  }

  .sidebar-accordion-content.is-collapsed {
    max-height: 0;
    padding-top: 0;
    opacity: 0;
  }

  .checkbox-container {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
    color: var(--color-foreground);
    opacity: 0.8;
    transition: opacity 0.2s ease;
  }

  .checkbox-container:hover {
    opacity: 1;
  }

  .checkbox-container input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
  }

  .checkbox-custom {
    height: 16px;
    width: 16px;
    border: 1px solid var(--color-border);
    border-radius: 2px;
    margin-right: 10px;
    position: relative;
    transition: all 0.2s ease;
  }

  .checkbox-container input:checked ~ .checkbox-custom {
    background-color: var(--color-foreground);
    border-color: var(--color-foreground);
  }

  .checkbox-custom:after {
    content: "";
    position: absolute;
    display: none;
    left: 5px;
    top: 2px;
    width: 4px;
    height: 8px;
    border: solid var(--color-background);
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .checkbox-container input:checked ~ .checkbox-custom:after {
    display: block;
  }

  .product-grid {
    flex: 1;
    display: flex;
    flex-wrap: wrap;
    gap: 30px;
  }

  /* Mobile */
  @media (max-width: 768px) {
    .collection-header {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-direction: column;
    }
    
    .product-grid-title {
      grid-area: title;
      margin-bottom: 10px;
      min-width: 190px;
    }
    
    .header-left {
      grid-area: filter;
      justify-content: flex-start;
    }
    
    .header-right {
      grid-area: sort;
      justify-content: flex-end;
    }
    
    .collection-sidebar {
      height: 0px;
    }

    .collection-sidebar.is-visible {
      width: 100%;
      height: 100%;
      margin-right: 0;
      margin-bottom: 30px;
    }

    .collection-content-wrapper {
      flex-direction: column;
    }
  }
{% endstylesheet %}

<script>
(function() {
  function initProductGrid() {
    const section = document.querySelector('.product-grid-section');
    if (!section) return;
    
    const productGrid = section.querySelector('.product-grid');
    const productCards = Array.from(section.querySelectorAll('.product-card'));
    const productCountEl = section.querySelector('.product-count');
    
    // Main Filter Toggle (Sidebar)
    const mainFilterToggle = document.getElementById('main-filter-toggle');
    const collectionSidebar = document.getElementById('collection-sidebar');
    
    if (mainFilterToggle && collectionSidebar) {
      mainFilterToggle.addEventListener('click', () => {
        collectionSidebar.classList.toggle('is-visible');
        mainFilterToggle.classList.toggle('is-active');
      });
    }

    // Sidebar Accordions
    const accordionBtns = section.querySelectorAll('.sidebar-accordion-btn');
    
    accordionBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const content = btn.nextElementSibling;
        const isExpanded = btn.getAttribute('aria-expanded') === 'true';
        
        btn.setAttribute('aria-expanded', !isExpanded);
        content.classList.toggle('is-collapsed');
      });
    });

    // Sort Dropdown
    const sortTrigger = document.getElementById('sort-trigger');
    const sortOptionsList = document.getElementById('sort-options-list');
    const sortOptions = section.querySelectorAll('.sort-option');
    const currentSortLabel = section.querySelector('.current-sort-label');

    if (sortTrigger && sortOptionsList) {
      sortTrigger.addEventListener('click', (e) => {
        e.stopPropagation();
        sortOptionsList.classList.toggle('is-visible');
        sortTrigger.classList.toggle('is-active');
      });

      document.addEventListener('click', (e) => {
        if (!sortTrigger.contains(e.target) && !sortOptionsList.contains(e.target)) {
          sortOptionsList.classList.remove('is-visible');
          sortTrigger.classList.remove('is-active');
        }
      });

      sortOptions.forEach(option => {
        option.addEventListener('click', () => {
          const value = option.dataset.value;
          const label = option.textContent;
          
          currentSortLabel.textContent = label;
          sortOptionsList.classList.remove('is-visible');
          sortTrigger.classList.remove('is-active');
          
          sortOptions.forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');
          
          applySort(value);
        });
      });
    }

    // Filter state
    const selectedAvailability = new Set();
    const selectedTypes = new Set();

    const applyFilters = () => {
      let visibleCount = 0;

      productCards.forEach((card) => {
        const avail = card.dataset.availability;
        const type = card.dataset.productType;
        
        const showAvail = selectedAvailability.size === 0 || selectedAvailability.has(avail);
        const showType = selectedTypes.size === 0 || selectedTypes.has(type);

        if (showAvail && showType) {
          card.style.display = '';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      if (productCountEl) {
        productCountEl.textContent = visibleCount === 1 ? `${visibleCount} product` : `${visibleCount} products`;
      }
    };

    const updateFilterState = (checkbox) => {
      const type = checkbox.dataset.filterType;
      const value = checkbox.value;
      const isChecked = checkbox.checked;
      
      const targetSet = type === 'availability' ? selectedAvailability : selectedTypes;
      
      if (value === 'all') {
        if (isChecked) {
          targetSet.clear();
          section.querySelectorAll(`input[data-filter-type="${type}"]:not([value="all"])`).forEach(cb => {
            cb.checked = false;
          });
        } else {
          if (targetSet.size === 0) {
            checkbox.checked = true;
            return; 
          }
        }
      } else {
        if (isChecked) {
          targetSet.add(value);
          const allCheckbox = section.querySelector(`input[data-filter-type="${type}"][value="all"]`);
          if (allCheckbox) allCheckbox.checked = false;
        } else {
          targetSet.delete(value);
          if (targetSet.size === 0) {
            const allCheckbox = section.querySelector(`input[data-filter-type="${type}"][value="all"]`);
            if (allCheckbox) allCheckbox.checked = true;
          }
        }
      }
      
      applyFilters();
    };

    section.querySelectorAll('input[type="checkbox"][data-filter-type]').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => updateFilterState(e.target));
    });

    const applySort = (sortValue) => {
      let sortedCards;

      switch (sortValue) {
        case 'title-ascending':
          sortedCards = productCards.slice().sort((a, b) => a.dataset.title.localeCompare(b.dataset.title));
          break;
        case 'title-descending':
          sortedCards = productCards.slice().sort((a, b) => b.dataset.title.localeCompare(a.dataset.title));
          break;
        case 'price-ascending':
          sortedCards = productCards.slice().sort((a, b) => parseFloat(a.dataset.price) - parseFloat(b.dataset.price));
          break;
        case 'price-descending':
          sortedCards = productCards.slice().sort((a, b) => parseFloat(b.dataset.price) - parseFloat(a.dataset.price));
          break;
        case 'created-ascending':
          sortedCards = productCards.slice().sort((a, b) => parseInt(a.dataset.created, 10) - parseInt(b.dataset.created, 10));
          break;
        case 'created-descending':
        default:
          sortedCards = productCards.slice().sort((a, b) => parseInt(b.dataset.created, 10) - parseInt(a.dataset.created, 10));
          break;
      }

      productGrid.innerHTML = '';
      sortedCards.forEach((card) => productGrid.appendChild(card));
      productCards.length = 0;
      productCards.push(...sortedCards);
      applyFilters();
    };

    // Quick Add functionality
    let currentOpenVariants = null;
    let currentOpenBtn = null;

    const closeAllVariants = () => {
      section.querySelectorAll('.quick-add-variants.is-open').forEach(el => {
        el.classList.remove('is-open');
      });
      if (currentOpenBtn) {
        currentOpenBtn.classList.remove('hidden');
      }
      currentOpenVariants = null;
      currentOpenBtn = null;
    };

    document.addEventListener('click', (e) => {
      if (currentOpenVariants && !e.target.closest('.quick-add-variants') && !e.target.closest('.quick-add-btn')) {
        closeAllVariants();
      }
    });

    async function addToCart(variantId) {
      const formData = new FormData();
      formData.append('id', variantId);
      formData.append('quantity', 1);

      try {
        if (window.addToCartAndUpdate) {
          await window.addToCartAndUpdate(formData);
        } else {
          await fetch('/cart/add.js', {
            method: 'POST',
            body: formData
          });
          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();
          
          document.querySelectorAll('.cart-count').forEach(el => {
            if (cart.item_count > 0) {
              el.textContent = cart.item_count;
              el.classList.add('cart-count--visible');
            }
          });
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
      }
    }

    section.querySelectorAll('.quick-add-btn').forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();

        const card = this.closest('.product-card');
        const productHandle = this.dataset.productHandle;
        const variantsContainer = card.querySelector('.quick-add-variants');
        const variantsList = variantsContainer.querySelector('.quick-add-variants-list');

        closeAllVariants();

        try {
          const response = await fetch(`/products/${productHandle}.js`);
          const product = await response.json();

          // Handle both string and object formats
          const sizeOptionIndex = product.options.findIndex(opt => {
            const optName = typeof opt === 'string' ? opt : (opt.name || opt.title || '');
            return optName.toLowerCase().includes('size') || optName.toLowerCase().includes('tamanho');
          });

          if (sizeOptionIndex !== -1 && product.variants.length > 1) {
            const seenSizes = new Set();
            const uniqueVariants = [];
            
            product.variants.forEach(variant => {
              const size = variant.options[sizeOptionIndex];
              if (!seenSizes.has(size)) {
                seenSizes.add(size);
                const availableForSize = product.variants.some(v => 
                  v.options[sizeOptionIndex] === size && v.available
                );
                uniqueVariants.push({ size, id: variant.id, available: availableForSize });
              }
            });

            variantsList.innerHTML = uniqueVariants.map(v => `
              <button type="button" class="quick-add-variant-btn" data-variant-id="${v.id}" ${!v.available ? 'disabled' : ''}>${v.size}</button>
            `).join('');

            this.classList.add('hidden');
            variantsContainer.classList.add('is-open');
            currentOpenVariants = variantsContainer;
            currentOpenBtn = this;

            variantsList.querySelectorAll('.quick-add-variant-btn').forEach(variantBtn => {
              variantBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!this.disabled) {
                  addToCart(this.dataset.variantId);
                  closeAllVariants();
                }
              });
            });
          } else {
            const availableVariant = product.variants.find(v => v.available) || product.variants[0];
            if (availableVariant) {
              addToCart(availableVariant.id);
            }
          }
        } catch (error) {
          console.error('Error fetching product:', error);
        }
      });
    });

    section.querySelectorAll('.quick-add-close').forEach(closeBtn => {
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        closeAllVariants();
      });
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProductGrid);
  } else {
    initProductGrid();
  }
})();
</script>

{% schema %}
{
  "name": "Product Grid",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to show",
      "min": 3,
      "max": 12,
      "step": 3,
      "default": 6
    }
  ],
  "blocks": [
    {
      "type": "promo_image",
      "name": "Photoshoot Image",
      "limit": 12,
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "alt", "label": "Alt text" },
        { "type": "url", "id": "link", "label": "Optional link" },
        {
          "type": "range",
          "id": "insert_after",
          "label": "Insert after N products",
          "min": 0,
          "max": 24,
          "step": 1,
          "default": 2
        }
      ]
    },
    {
      "type": "wide_banner",
      "name": "Wide Banner",
      "limit": 3,
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Banner image" },
        { "type": "text", "id": "alt", "label": "Alt text" },
        { "type": "url", "id": "link", "label": "Optional link" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Grid"
    }
  ]
}
{% endschema %}
