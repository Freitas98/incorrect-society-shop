{% comment %}
  New Arrivals Grid Section
  Features: Category tabs, product badges, color swatches, quick add
{% endcomment %}

{% liquid
  assign collection_handle = section.settings.collection | default: 'all'
  assign products_to_show = section.settings.products_count | default: 12
  assign title = section.settings.title | default: 'New Arrivals'
  
  if collection_handle == 'all'
    assign products = collections.all.products
  else
    assign products = collections[collection_handle].products
  endif
%}

<section class="new-arrivals-section" style="position: relative; z-index: 1;">
  <div class="new-arrivals-container">
    <!-- Header with title and category tabs -->
    <div class="new-arrivals-header">
      <h2 class="new-arrivals-title">{{ title }}</h2>
      
      <nav class="category-tabs" role="tablist">
        <button class="category-tab active" data-filter="all" role="tab" aria-selected="true">
          View all<sup class="tab-count">{{ products.size }}</sup>
        </button>
        {% for collection in section.settings.featured_collections %}
          {% assign col = collections[collection] %}
          {% if col %}
            <button class="category-tab" data-filter="{{ col.handle }}" role="tab" aria-selected="false">
              {{ col.title }}<sup class="tab-count">{{ col.products_count }}</sup>
            </button>
          {% endif %}
        {% endfor %}
      </nav>
    </div>

    <!-- Product Grid -->
    <div class="new-arrivals-grid">
      {% for product in products limit: products_to_show %}
        {% liquid
          assign badge_text = ''
          assign badge_class = ''
          
          # Check if product is new (created within last 30 days)
          assign now_timestamp = 'now' | date: '%s' | plus: 0
          assign product_timestamp = product.created_at | date: '%s' | plus: 0
          assign days_old = now_timestamp | minus: product_timestamp | divided_by: 86400
          
          if days_old <= 30
            assign badge_text = 'NEW IN'
            assign badge_class = 'badge-new'
          endif
          
          # Check metafield for "back in stock" or similar
          if product.metafields.custom.badge
            assign badge_text = product.metafields.custom.badge
            if badge_text contains 'BACK'
              assign badge_class = 'badge-back'
            endif
          endif
          
          # Get color variants
          assign color_option = nil
          for option in product.options_with_values
            assign option_name_down = option.name | downcase
            if option_name_down contains 'color' or option_name_down contains 'colour' or option_name_down contains 'cor'
              assign color_option = option
              break
            endif
          endfor
          
          # Get product tags for collection filtering
          assign product_tags = product.tags | join: ',' | downcase
        %}
        
        <article class="product-card-enhanced" 
                 data-product-id="{{ product.id }}"
                 data-collections="{% for col in product.collections %}{{ col.handle }},{% endfor %}"
                 data-available="{{ product.available }}">
          
          <a href="{{ product.url }}" class="product-card-link">
            <!-- Product Image Container -->
            <div class="product-image-wrapper">
              {% if badge_text != '' %}
                <span class="product-badge {{ badge_class }}">{{ badge_text }}</span>
              {% endif %}
              
              {% if product.featured_media %}
                <img 
                  src="{{ product.featured_media | image_url: width: 600 }}" 
                  alt="{{ product.featured_media.alt | escape | default: product.title }}"
                  class="product-image-main"
                  loading="lazy"
                  width="600"
                  height="600"
                >
                {% if product.media[1] %}
                  <img 
                    src="{{ product.media[1] | image_url: width: 600 }}" 
                    alt="{{ product.media[1].alt | escape | default: product.title }}"
                    class="product-image-hover"
                    loading="lazy"
                    width="600"
                    height="600"
                  >
                {% endif %}
              {% else %}
                <div class="product-image-placeholder">
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              {% endif %}
              
              <!-- Quick Add Button -->
              {% if product.available %}
                <button type="button" 
                        class="quick-add-btn" 
                        data-product-id="{{ product.id }}"
                        data-product-handle="{{ product.handle }}"
                        aria-label="Quick add {{ product.title }}">
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
                    <path d="M7 1V13M1 7H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              {% endif %}
            </div>
          </a>
          
          <!-- Product Info -->
          <div class="product-info-enhanced">
            <div class="product-info-row">
              <a href="{{ product.url }}" class="product-title-link">
                <h3 class="product-title-enhanced">{{ product.title }}</h3>
              </a>
              <span class="product-price-enhanced">
                {% if product.available %}
                  {% render 'price', amount: product.price, product: product %}
                {% else %}
                  <span class="sold-out-text">{{ 'products.product.sold_out' | t }}</span>
                {% endif %}
              </span>
            </div>
            
            <!-- Color Swatches -->
            {% if color_option and color_option.values.size > 1 %}
              <div class="color-swatches">
                {% for color_value in color_option.values limit: 6 %}
                  {% liquid
                    assign color_handle = color_value | handleize
                    # Map common color names to hex
                    case color_handle
                      when 'black' or 'preto'
                        assign swatch_color = '#000000'
                      when 'white' or 'branco'
                        assign swatch_color = '#ffffff'
                      when 'grey' or 'gray' or 'cinzento'
                        assign swatch_color = '#808080'
                      when 'light-grey' or 'light-gray'
                        assign swatch_color = '#d3d3d3'
                      when 'navy' or 'navy-blue' or 'azul-marinho'
                        assign swatch_color = '#1a1a3e'
                      when 'blue' or 'azul'
                        assign swatch_color = '#2563eb'
                      when 'red' or 'vermelho'
                        assign swatch_color = '#dc2626'
                      when 'pink' or 'rosa'
                        assign swatch_color = '#f9a8d4'
                      when 'green' or 'verde'
                        assign swatch_color = '#16a34a'
                      when 'brown' or 'castanho'
                        assign swatch_color = '#78350f'
                      when 'beige' or 'bege'
                        assign swatch_color = '#d4c4a8'
                      when 'cream' or 'creme'
                        assign swatch_color = '#fffdd0'
                      when 'yellow' or 'amarelo'
                        assign swatch_color = '#eab308'
                      when 'orange' or 'laranja'
                        assign swatch_color = '#ea580c'
                      when 'purple' or 'roxo'
                        assign swatch_color = '#7c3aed'
                      else
                        assign swatch_color = '#cccccc'
                    endcase
                  %}
                  <span 
                    class="color-swatch{% if forloop.first %} active{% endif %}" 
                    style="background-color: {{ swatch_color }};"
                    title="{{ color_value }}"
                    data-color="{{ color_value }}"
                  ></span>
                {% endfor %}
                {% if color_option.values.size > 6 %}
                  <span class="color-swatch-more">+{{ color_option.values.size | minus: 6 }}</span>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  </div>
  
  <!-- Quick Add Modal (Size Selector) -->
  <div class="quick-add-modal" id="quick-add-modal" aria-hidden="true">
    <button class="quick-add-modal-close" aria-label="Close">&times;</button>
    <div class="quick-add-modal-sizes" id="quick-add-sizes">
      <!-- Sizes will be populated via JS -->
    </div>
  </div>
  <div class="quick-add-overlay" id="quick-add-overlay"></div>
</section>

<style>
  .new-arrivals-section {
    padding: 60px 0;
    background-color: var(--color-background);
  }

  .new-arrivals-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 40px;
  }

  .new-arrivals-header {
    display: flex;
    align-items: baseline;
    gap: 60px;
    margin-bottom: 40px;
    border-bottom: 1px solid var(--color-border);
    padding-bottom: 20px;
  }

  .new-arrivals-title {
    font-family: var(--font-heading-family);
    font-size: clamp(28px, 4vw, 42px);
    font-weight: var(--font-heading-weight);
    margin: 0;
    white-space: nowrap;
    color: var(--color-foreground);
  }

  .category-tabs {
    display: flex;
    gap: 32px;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-bottom: 2px;
  }

  .category-tabs::-webkit-scrollbar {
    display: none;
  }

  .category-tab {
    background: none;
    border: none;
    padding: 0;
    font-family: var(--font-primary-family);
    font-size: 15px;
    color: var(--color-foreground);
    opacity: 0.5;
    cursor: pointer;
    white-space: nowrap;
    transition: opacity 0.2s ease;
    position: relative;
  }

  .category-tab:hover {
    opacity: 0.8;
  }

  .category-tab.active {
    opacity: 1;
    font-weight: 500;
  }

  .tab-count {
    font-size: 11px;
    margin-left: 2px;
    vertical-align: super;
    opacity: 0.7;
  }

  /* Product Grid */
  .new-arrivals-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 20px;
  }

  @media (max-width: 1400px) {
    .new-arrivals-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (max-width: 1100px) {
    .new-arrivals-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 768px) {
    .new-arrivals-container {
      padding: 0 20px;
    }
    
    .new-arrivals-header {
      flex-direction: column;
      gap: 20px;
    }
    
    .new-arrivals-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
  }

  @media (max-width: 480px) {
    .new-arrivals-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Product Card */
  .product-card-enhanced {
    position: relative;
  }

  .product-card-enhanced[data-visible="false"] {
    display: none;
  }

  .product-card-link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .product-image-wrapper {
    position: relative;
    aspect-ratio: 3/4;
    overflow: hidden;
    background-color: #f5f5f5;
    margin-bottom: 12px;
  }

  .product-image-main,
  .product-image-hover {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  .product-image-hover {
    opacity: 0;
  }

  .product-card-link:hover .product-image-main {
    opacity: 0;
  }

  .product-card-link:hover .product-image-hover {
    opacity: 1;
  }

  .product-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f0f0f0;
  }

  /* Product Badge */
  .product-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    padding: 6px 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 2;
    background-color: var(--color-foreground);
    color: var(--color-background);
  }

  .product-badge.badge-new {
    background-color: var(--color-foreground);
    color: var(--color-background);
  }

  .product-badge.badge-back {
    background-color: transparent;
    color: var(--color-foreground);
    border: 1px solid var(--color-foreground);
  }

  /* Quick Add Button */
  .quick-add-btn {
    position: absolute;
    bottom: 12px;
    right: 12px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.2s ease;
    z-index: 3;
  }

  .product-card-enhanced:hover .quick-add-btn {
    opacity: 1;
    transform: translateY(0);
  }

  .quick-add-btn:hover {
    background-color: var(--color-foreground);
    color: var(--color-background);
  }

  .quick-add-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Product Info */
  .product-info-enhanced {
    padding: 0 4px;
  }

  .product-info-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 8px;
  }

  .product-title-link {
    text-decoration: none;
    color: inherit;
    flex: 1;
    min-width: 0;
  }

  .product-title-enhanced {
    font-family: var(--font-primary-family);
    font-size: 13px;
    font-weight: 400;
    margin: 0;
    color: var(--color-foreground);
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .product-price-enhanced {
    font-size: 13px;
    font-weight: 400;
    color: var(--color-foreground);
    white-space: nowrap;
  }

  .sold-out-text {
    color: var(--color-foreground);
    opacity: 0.5;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
  }

  /* Color Swatches */
  .color-swatches {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
  }

  .color-swatch {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .color-swatch:hover {
    transform: scale(1.2);
  }

  .color-swatch.active {
    box-shadow: 0 0 0 1px var(--color-foreground);
  }

  .color-swatch-more {
    font-size: 10px;
    color: var(--color-foreground);
    opacity: 0.6;
  }

  /* Quick Add Modal */
  .quick-add-modal {
    position: fixed;
    bottom: 100px;
    right: 40px;
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    padding: 16px;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: all 0.3s ease;
    min-width: 200px;
  }

  .quick-add-modal.is-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .quick-add-modal-close {
    position: absolute;
    top: 8px;
    right: 12px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--color-foreground);
    opacity: 0.5;
    transition: opacity 0.2s ease;
    line-height: 1;
  }

  .quick-add-modal-close:hover {
    opacity: 1;
  }

  .quick-add-modal-sizes {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    padding-top: 8px;
  }

  .quick-add-size-btn {
    min-width: 40px;
    height: 36px;
    padding: 0 12px;
    border: 1px solid var(--color-border);
    background-color: var(--color-background);
    font-family: var(--font-primary-family);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .quick-add-size-btn:hover:not(:disabled) {
    background-color: var(--color-foreground);
    color: var(--color-background);
    border-color: var(--color-foreground);
  }

  .quick-add-size-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    text-decoration: line-through;
  }

  .quick-add-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 999;
    display: none;
  }

  .quick-add-overlay.is-open {
    display: block;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.querySelector('.new-arrivals-section');
    if (!section) return;

    // Category Tab Filtering
    const tabs = section.querySelectorAll('.category-tab');
    const products = section.querySelectorAll('.product-card-enhanced');

    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const filter = this.dataset.filter;
        
        // Update active tab
        tabs.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-selected', 'true');

        // Filter products
        products.forEach(product => {
          const collections = product.dataset.collections || '';
          if (filter === 'all' || collections.includes(filter)) {
            product.style.display = '';
            product.setAttribute('data-visible', 'true');
          } else {
            product.style.display = 'none';
            product.setAttribute('data-visible', 'false');
          }
        });
      });
    });

    // Quick Add functionality
    const quickAddBtns = section.querySelectorAll('.quick-add-btn');
    const quickAddModal = document.getElementById('quick-add-modal');
    const quickAddSizes = document.getElementById('quick-add-sizes');
    const quickAddOverlay = document.getElementById('quick-add-overlay');
    const quickAddClose = section.querySelector('.quick-add-modal-close');

    let currentProductHandle = null;

    const closeQuickAdd = () => {
      quickAddModal.classList.remove('is-open');
      quickAddOverlay.classList.remove('is-open');
      currentProductHandle = null;
    };

    quickAddBtns.forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();

        const productHandle = this.dataset.productHandle;
        currentProductHandle = productHandle;

        // Fetch product data
        try {
          const response = await fetch(`/products/${productHandle}.js`);
          const product = await response.json();

          // Check if product has size variants
          const sizeOption = product.options.find(opt => 
            opt.toLowerCase().includes('size') || opt.toLowerCase().includes('tamanho')
          );

          if (sizeOption && product.variants.length > 1) {
            // Show size selector
            const sizeIndex = product.options.indexOf(sizeOption);
            
            quickAddSizes.innerHTML = product.variants.map(variant => {
              const size = variant.options[sizeIndex];
              return `
                <button 
                  class="quick-add-size-btn" 
                  data-variant-id="${variant.id}"
                  ${!variant.available ? 'disabled' : ''}
                >
                  ${size}
                </button>
              `;
            }).join('');

            // Position modal near the button
            const btnRect = this.getBoundingClientRect();
            quickAddModal.style.position = 'fixed';
            quickAddModal.style.bottom = 'auto';
            quickAddModal.style.right = 'auto';
            quickAddModal.style.top = `${btnRect.bottom + 10}px`;
            quickAddModal.style.left = `${Math.min(btnRect.left, window.innerWidth - 220)}px`;

            quickAddModal.classList.add('is-open');
            quickAddOverlay.classList.add('is-open');

            // Add click handlers to size buttons
            quickAddSizes.querySelectorAll('.quick-add-size-btn').forEach(sizeBtn => {
              sizeBtn.addEventListener('click', function() {
                const variantId = this.dataset.variantId;
                addToCart(variantId);
                closeQuickAdd();
              });
            });
          } else {
            // No size options, add first available variant directly
            const availableVariant = product.variants.find(v => v.available) || product.variants[0];
            addToCart(availableVariant.id);
          }
        } catch (error) {
          console.error('Error fetching product:', error);
        }
      });
    });

    if (quickAddClose) {
      quickAddClose.addEventListener('click', closeQuickAdd);
    }

    if (quickAddOverlay) {
      quickAddOverlay.addEventListener('click', closeQuickAdd);
    }

    // Add to cart function
    async function addToCart(variantId, quantity = 1) {
      const formData = new FormData();
      formData.append('id', variantId);
      formData.append('quantity', quantity);

      try {
        if (window.addToCartAndUpdate) {
          await window.addToCartAndUpdate(formData);
        } else {
          await fetch('/cart/add.js', {
            method: 'POST',
            body: formData
          });
          // Refresh cart count
          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();
          
          // Update cart count in header
          const cartCounts = document.querySelectorAll('.cart-count');
          cartCounts.forEach(el => {
            if (cart.item_count > 0) {
              el.textContent = cart.item_count;
              el.classList.add('cart-count--visible');
            }
          });
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
      }
    }
  });
</script>

{% schema %}
{
  "name": "New Arrivals Grid",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "New Arrivals"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_count",
      "label": "Products to show",
      "min": 4,
      "max": 24,
      "step": 2,
      "default": 12
    },
    {
      "type": "collection_list",
      "id": "featured_collections",
      "label": "Category tabs (collections)",
      "limit": 10
    }
  ],
  "presets": [
    {
      "name": "New Arrivals Grid"
    }
  ]
}
{% endschema %}
